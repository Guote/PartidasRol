const y={ID:"token-action-hud-core",NAME:"Token Action HUD"},A=`modules/${y.ID}/templates`,w={action:`${A}/action.hbs`,customStyleForm:`${A}/custom-style-form.hbs`,group:`${A}/group.hbs`,hud:`${A}/hud.hbs`,listGroup:`${A}/list-group.hbs`,settings:`${A}/settings.hbs`,tabGroup:`${A}/tab-group.hbs`,tagDialogGroup:`${A}/tag-dialog-group.hbs`,tagDialogHud:`${A}/tag-dialog-hud.hbs`,tagDialogTopLevelGroup:`${A}/tag-dialog-top-level-group.hbs`},k="|",H={compendiumEntry:"tokenActionHud.compendiumEntry",compendiumMacro:"tokenActionHud.compendiumMacro",compendiumPlaylist:"tokenActionHud.compendiumPlaylist",macro:"tokenActionHud.macro"},S=["compendiumEntry","compendiumMacro","compendiumPlaylist","macro"],C=["JournalEntry","Macro","RollTable"],D={compact:{class:"tah-style-foundry-vtt",file:"tah-compact",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},custom:{class:"tah-style-custom",file:"tah-custom"},dorakoUI:{class:"tah-style-dorako-ui",file:"tah-dorako"},foundryVTT:{class:"tah-style-foundry-vtt-dark",file:"tah-foundry-vtt-dark",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},foundryVttLight:{class:"tah-style-foundry-vtt-light",file:"tah-foundry-vtt-light",primaryColor:"#dddddd",secondaryColor:"#dddddd80",tertiaryColor:"#ff6400"},highContrast:{class:"tah-style-high-contrast",file:"tah-high-contrast",primaryColor:"#ffff00",secondaryColor:"#ffff00",tertiaryColor:"#0C7BDC"},pathfinder:{class:"tah-style-pathfinder",file:"tah-pathfinder"}},I={backgroundColor:{cssProperty:"--tah-background-color",type:String,default:"#00000000"},buttonHeight:{cssProperty:"--tah-button-height-editable",type:Number,default:32},buttonBackgroundColor:{cssProperty:"--tah-button-background-color-editable",type:String,default:"#000000b3"},buttonBorderPrimaryColor:{cssProperty:"--tah-button-border-primary-color-editable",type:String,default:"#0C0C0CFF"},buttonBorderSecondaryColor:{cssProperty:"--tah-button-border-secondary-color-editable",type:String,default:"#060606FF"},buttonTextColor:{cssProperty:"--tah-button-text-color-editable",type:String,default:"#DDDDDDFF"},buttonHoverBorderPrimaryColor:{cssProperty:"--tah-button-hover-border-primary-color-editable",type:String,default:"#FF6400FF"},buttonHoverBorderSecondaryColor:{cssProperty:"--tah-button-hover-border-secondary-color-editable",type:String,default:"#FF0000FF"},buttonHoverBackgroundColor:{cssProperty:"--tah-button-hover-background-color-editable",type:String,default:"#000000B3"},buttonHoverTextColor:{cssProperty:"--tah-button-hover-text-color-editable",type:String,default:"#FFFFFFFF"},buttonToggleActiveBackgroundColor:{cssProperty:"--tah-button-toggle-active-background-color-editable",type:String,default:"#3C0078BF"},buttonToggleActiveBorderPrimaryColor:{cssProperty:"--tah-button-toggle-active-border-primary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleActiveBorderSecondaryColor:{cssProperty:"--tah-button-toggle-active-border-secondary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleActiveTextColor:{cssProperty:"--tah-button-toggle-active-text-color-editable",type:String,default:"#FFFFFFFF"},buttonToggleHoverBackgroundColor:{cssProperty:"--tah-button-toggle-hover-background-color-editable",type:String,default:"#3C0078BF"},buttonToggleHoverBorderPrimaryColor:{cssProperty:"--tah-button-toggle-hover-border-primary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleHoverBorderSecondaryColor:{cssProperty:"--tah-button-toggle-hover-secondary-color-editable",type:String,default:"#9B8DFFFF"},buttonToggleHoverTextColor:{cssProperty:"--tah-button-toggle-hover-text-color-editable",type:String,default:"#FFFFFFFF"},textPrimaryColor:{cssProperty:"--tah-text-primary-color-editable",type:String,default:"#DDDDDDFF"},textSecondaryColor:{cssProperty:"--tah-text-secondary-color-editable",type:String,default:"#DDDDDD80"},textTertiaryColor:{cssProperty:"--tah-text-tertiary-color-editable",type:String,default:"#FF6400FF"},textHoverPrimaryColor:{cssProperty:"--tah-text-hover-primary-color-editable",type:String,default:"#DDDDDDFF"},textHoverSecondaryColor:{cssProperty:"--tah-text-hover-secondary-color-editable",type:String,default:"#DDDDDD80"},textHoverTertiaryColor:{cssProperty:"--tah-text-tertiary-color-editable",type:String,default:"#FF6400FF"}},x="custom",E="system",L="system-derived",M="fas fa-sd-card",U="Item Macro",O={customLayout:{hint:"tokenActionHud.settings.customLayout.hint",name:"tokenActionHud.settings.customLayout.name",inputType:"filePicker",filePickerType:"json",dtype:"String",scope:"world"},userCustomLayout:{hint:"tokenActionHud.settings.userCustomLayout.hint",name:"tokenActionHud.settings.userCustomLayout.name",inputType:"filePicker",filePickerType:"json",dtype:"String",scope:"client"},exportLayout:{hint:"tokenActionHud.settings.exportLayout.hint",label:"tokenActionHud.settings.exportLayout.label",name:"tokenActionHud.settings.exportLayout.name",inputType:"button",icon:"fa-solid fa-file-export",onClick:"game?.tokenActionHud?.actionHandler?.exportLayout()"},resetLayout:{hint:"tokenActionHud.settings.resetLayout.hint",label:"tokenActionHud.settings.resetLayout.label",name:"tokenActionHud.settings.resetLayout.name",inputType:"button",icon:"fa-solid fa-arrow-rotate-left",onClick:"game?.tokenActionHud?.resetDialog()",scope:"client"},resetAllLayouts:{hint:"tokenActionHud.settings.resetAllLayouts.hint",label:"tokenActionHud.settings.resetAllLayouts.label",name:"tokenActionHud.settings.resetAllLayouts.name",inputType:"button",icon:"fa-solid fa-bomb",onClick:"game?.tokenActionHud?.resetAllDialog()",scope:"world"}},G={activeCssAsText:{classes:["TokenActionHud"],variable:"activeCssAsTextSetting"},allow:{classes:["TokenActionHud"],variable:"allowSetting"},alwaysShowHud:{classes:["TokenActionHud"],variable:"alwaysShowHudSetting"},backgroundColor:{},buttonBackgroundColor:{},buttonBorderPrimaryColor:{},buttonBorderSecondaryColor:{},buttonHeight:{},buttonHoverBorderPrimaryColor:{},buttonHoverBorderSecondaryColor:{},buttonHoverBackgroundColor:{},buttonHoverTextColor:{},buttonTextColor:{},buttonToggleActiveBackgroundColor:{},buttonToggleActiveBorderPrimaryColor:{},buttonToggleActiveBorderSecondaryColor:{},buttonToggleActiveTextColor:{},buttonToggleHoverBackgroundColor:{},buttonToggleHoverBorderPrimaryColor:{},buttonToggleHoverBorderSecondaryColor:{},buttonToggleHoverTextColor:{},clickOpenCategory:{classes:["TokenActionHud"],variable:"clickOpenCategorySetting"},customLayout:{classes:["ActionHandler"],variable:"customLayoutSetting"},customStyle:{},debug:{classes:["TokenActionHud"],variable:"debugSetting"},direction:{classes:["TokenActionHud"],variable:"directionSetting"},displayCharacterName:{classes:["TokenActionHud"],variable:"displayCharacterName"},displayIcons:{classes:["TokenActionHud"],variable:"displayIconsSetting"},drag:{classes:["TokenActionHud"],variable:"dragSetting"},enable:{classes:["TokenActionHud"],variable:"enableSetting"},enableCustomization:{classes:["ActionHandler","TokenActionHud"],variable:"enableCustomizationSetting"},grid:{classes:["TokenActionHud"],variable:"gridSetting"},itemMacro:{},migrationVersion:{},reset:{},renderItemOnRightClick:{},rollHandler:{default:"core"},scale:{classes:["TokenActionHud"],variable:"scaleSetting"},sortActions:{classes:["ActionHandler"],variable:"sortActionsSetting"},startup:{},style:{},tooltips:{classes:["ActionHandler"],variable:"tooltipsSetting"},textPrimaryColor:{},textSecondaryColor:{},textTertiaryColor:{},textHoverPrimaryColor:{},textHoverSecondaryColor:{},textHoverTertiaryColor:{},userCustomLayout:{classes:["ActionHandler"],variable:"userCustomLayoutSetting"}};class Logger{static info(y,A=!1){A?ui.notifications.info(`Token Action HUD | ${y}`):console.log(`Token Action HUD Info | ${y}`)}static error(y,A=!1){A?ui.notifications.error(`Token Action HUD | ${y}`):console.error(`Token Action HUD Error | ${y}`)}static debug(y,A){if(game.tokenActionHud?game.tokenActionHud.debugSetting:Utils.getSetting("debug")){if(!A)return void console.log(`Token Action HUD Debug | ${y}`);const w=Utils.deepClone(A);console.log(`Token Action HUD Debug | ${y}`,w)}}}class Timer{constructor(y){this.milliseconds=y,this.timer=null}async start(){return this.timer&&this.abort(),new Promise((y=>{this.timer=setTimeout((()=>{y()}),this.milliseconds??100)}))}async abort(){clearTimeout(this.timer),this.timer=null}}class Utils{static checkAllow(y,A){return y>=A}static deepClone(y,A){return deepClone(y,A)}static getActor(y,A){let w=null;return A&&(w=canvas.tokens.placeables.find((y=>y.id===A))),w?w.actor:game.actors.get(y)}static getStatusEffect(y,A){return game.version.startsWith("11")?y.effects.find((y=>y.statuses.every((y=>y===A)))):y.effects.find((y=>y.flags?.core?.statusId===A))}static getImage(y,A=[]){A.push("icons/svg/mystery-man.svg");let w="";return game.tokenActionHud.displayIconsSetting&&(w="string"==typeof y?y:y?.img??y?.icon??""),A.includes(w)?"":w}static getItem(y,A){return y.items.get(A)}static getToken(y){return canvas.tokens.placeables.find((A=>A.id===y))}static getControlledTokens(){return game.canvas.tokens.controlled}static getFirstControlledToken(){const y=game.canvas.tokens.controlled[0];if(y)return y;const A=game.user?.character;return A?canvas.tokens.placeables.find((y=>y.actor?.id===A.id)):void 0}static getSetting(A,w=null){let k=w??null;try{k=game.settings.get(y.ID,A)}catch{Logger.debug(`Setting '${A}' not found`)}return k}static async setSetting(A,w){game.settings.settings.get(`${y.ID}.${A}`)?(await game.settings.set(y.ID,A,w),Logger.debug(`Setting '${A}' set to '${w}'`)):Logger.debug(`Setting '${A}' not found`)}static getActorFlag(A){return game.tokenActionHud.actor.getFlag(y.ID,A)}static async setActorFlag(A,w){await game.tokenActionHud.actor.setFlag(y.ID,A,w)}static async unsetActorFlag(A){await game.tokenActionHud.actor.unsetFlag(y.ID,A)}static getUserFlag(A){return game.user.getFlag(y.ID,A)}static async setUserFlag(A,w){await game.user.setFlag(y.ID,A,w)}static async unsetUserFlag(A){await game.user.unsetFlag(y.ID,A)}static i18n(y){return game.i18n.localize(y)}static isGmActive(){return game.users.some((y=>y.isGM&&y.active))}static isModuleActive(y){const A=game.modules.get(y);return A&&A.active}static getModuleTitle(y){return game.modules.get(y)?.title??""}static getModuleVersion(y){return game.modules.get(y)?.version??""}static humanizeBinding(A){const w=game.keybindings.get(y.ID,A);if(!w)return"";return w[0].modifiers.reduce(((y,A)=>(KeyboardManager.MODIFIER_CODES[A]?.includes(w[0].key)||y.unshift(KeyboardManager.getKeycodeDisplayString(A)),y)),[KeyboardManager.getKeycodeDisplayString(w[0].key)]).join(" + ")}static median(y){const A=Math.floor(y.length/2),w=[...y].sort(((y,A)=>y-A));return y.length%2!=0?w[A]:(w[A-1]+w[A])/2}static getUpperQuartileAverage(y){const A=y.slice().sort(((y,A)=>y-A)),w=A.length,k=w-1;let H=0,S=0;for(let y=Math.ceil(.75*w);y<=k;y++)H+=A[y],S++;return H/S}static getModifier(y){if(!y&&0!==y)return"";return`${y>=0?"+":""}${y}`}static sortItems(y){return new Map([...y.entries()].sort(((y,A)=>y[1].sort.localeCompare(A[1].sort))))}static sortItemsByName(y){return new Map([...y.entries()].sort(((y,A)=>y[1].name.localeCompare(A[1].name))))}static switchCSS(A){for(const[w,k]of Object.entries(D)){const H=[`modules/${y.ID}/`,`styles/${k.file}`];Object.values(document.styleSheets).find((y=>y.href?.includes(H[0])&&y.href?.includes(H[1]))).disabled=w!==A}if("custom"===A)for(const[y,A]of Object.entries(I)){const w=Utils.getSetting(y);w&&document.querySelector(":root").style.setProperty(A.cssProperty,w)}const w=document.querySelector("#token-action-hud");w&&(w.classList.remove(...w.classList),w.classList.add(D[A].class))}static registerHandlebars(){Handlebars.registerHelper("cap",(function(y){return!y||y.length<1?"":y[0].toUpperCase()+y.slice(1)}));const reduceOp=function(y,A){(y=Array.from(y)).pop();const w=y.shift();return y.reduce(A,w)};Handlebars.registerHelper({eq:function(){return reduceOp(arguments,((y,A)=>y===A))},ne:function(){return reduceOp(arguments,((y,A)=>y!==A))},lt:function(){return reduceOp(arguments,((y,A)=>y<A))},gt:function(){return reduceOp(arguments,((y,A)=>y>A))},lte:function(){return reduceOp(arguments,((y,A)=>y<=A))},gte:function(){return reduceOp(arguments,((y,A)=>y>=A))},and:function(){return reduceOp(arguments,((y,A)=>y&&A))},or:function(){return reduceOp(arguments,((y,A)=>y||A))},true:function(){return reduceOp(arguments,(y=>y))},false:function(){return reduceOp(arguments,(y=>!y))}}),Handlebars.registerHelper("activeText",(function(y){return game.tokenActionHud.activeCssAsTextSetting?y.fn(this):y.inverse(this)}))}static getModuleVersionParts(y){if(!y)return void Logger.debug("Module version not retrieved",{trigger:"getModuleVersionParts"});const A=y.split(".");return{major:A[0],minor:A[1],patch:A[2]}}static checkModuleCompatibility(A){const w=this.getModuleVersionParts(A),k=this.getModuleVersionParts(game.modules.get(y.ID).version);return!(k.major!==w.major||k.minor!==w.minor||w.patch&&k.patch!==w.patch)||(ui.notifications.error(`The installed Token Action HUD system module requires Token Action HUD Core module version ${A}. Install the required version to continue using Token Action HUD.`),!1)}static getSubcategories(y,A={}){let w=0;if(!y)return;const k=A?.id,H=A?.type;y=Array.isArray(y)?y:Object.values(y);const S={};for(const C of y){if(!(k&&C.id!==k||H&&C.type!==H)){w++;const y=C.nestId.split("_").length;S[C.nestId]={...C,order:w,level:y}}if(C.subcategories?.length>0){const y=this.getSubcategories(C.subcategories,A);y&&Object.assign(S,y)}}return Object.keys(S).length>0?S:null}static getNestedGroups(y,A={}){let w=0;if(!y)return;const k=A?.id,H=A?.type;y=Array.isArray(y)?y:Object.values(y);const S={};for(const C of y){if(!(k&&C.id!==k||H&&C.type!==H)){w++;const y=C.nestId.split("_").length;S[C.nestId]={...C,order:w,level:y}}if(C.groups?.length>0){const y=this.getNestedGroups(C.groups,A);y&&Object.assign(S,y)}}return Object.keys(S).length>0?S:null}static async getGroupByNestId(y,A={}){const w="string"==typeof A?A:A?.nestId,k=A?.type;if(!w)return;const H=w.split("_");return await async function findGroup(y,A){y=Array.isArray(y)?y:Object.values(y);for(const w of y)if(w.id===A[0]){if(1===A.length)return w.type&&k&&w.type!==k?void 0:w;A.shift();for(const y of Object.values(w.groups)){if(0===y.length)continue;const w=await findGroup(y,A);if(w)return w}}}(y,H)}static async deleteGroupByNestId(y,A={}){const w="string"==typeof A?A:A?.nestId;if(!w)return;const k=w.split("_");return await async function findGroup(y,A){y=Array.isArray(y)?y:Object.values(y);for(const[w,k]of y.entries())if(k.id===A[0]){if(1===A.length)return void y.splice(w,1);if(0===k.groups.length)return;A.shift();if(await findGroup(k.groups,A))return}}(y,k)}static async deleteGroupsById(y,A={}){const w="string"==typeof A?A:A?.id;if(w)for(let k=y.length-1;k>=0;k--)y[k].id===w?y.splice(k,1):y[k].groups?.length>0&&this.deleteGroupsById(y[k].groups,A)}}function isPersistentStorage(){return game.version>="11.305"&&"undefined"==typeof ForgeVTT}class DataHandler{async init(){this.path=DataHandler.getPath(),this.fileMap=await DataHandler.getFilePathsAsGm()}static async createDirectories(){const A="data",w=isPersistentStorage()?`modules/${y.ID}/storage`:y.ID,k=[w,`${w}/${game.world.id}`,`${w}/${game.world.id}/actor`,`${w}/${game.world.id}/user`];for(const y of k)await FilePicker.browse(A,y).catch((async w=>{await FilePicker.createDirectory(A,y,{})||Logger.debug("Failed to create directory: "+y)}))}static getPath(){return isPersistentStorage()?`modules/${y.ID}/storage/${game.world.id}/`:`${y.ID}/${game.world.id}/`}static async getFilePathsAsGm(){if(!game.user.hasPermission("FILES_BROWSE")&&!Utils.isGmActive())return Logger.info("Cannot get file paths without a GM present",!0),new Map;const y=game.user.hasPermission("FILES_BROWSE")?await DataHandler.getFilePaths():await game.tokenActionHud.socket.executeAsGM("getFilePaths");return new Map(y.map((y=>{const{id:A}=function getFileParts(y){const A=y.split("/"),w=A.pop(),k=A.join("/"),H=w.split(".")[0];return{folder:k,filename:w,id:H}}(y);return[A,y]})))}static async getFilePaths(){const y=game?.tokenActionHud?.dataHandler,[A,w]=await Promise.all([FilePicker.browse("data",`${y.path}actor/`),FilePicker.browse("data",`${y.path}user/`)]);return[...A?.files??[],...w?.files??[]]}static canSaveData(){return game.user.hasPermission("FILES_UPLOAD")||Utils.isGmActive()}static async saveDataAsGm(y,A,w){if(game.user.hasPermission("FILES_UPLOAD"))return await DataHandler.saveData(y,A,w);Utils.isGmActive()?await game.tokenActionHud.socket.executeAsGM("saveData",y,A,w):Logger.info("Cannot save data without a GM present",!0)}static async saveData(y,A,w){const k=game?.tokenActionHud?.dataHandler;try{const H=`${k.path}${y}`,S=encodeURI(`${A}.json`),C=new File([JSON.stringify(w,null,"")],S,{type:"application/json"}),D=await FilePicker.upload("data",H,C,{},{notify:!1});D.path?k.fileMap.has(A)||k.fileMap.set(A,D.path):Logger.debug(`Failed to save data to: ${S}\nReason: ${D.error||"Unknown error"}`)}catch(y){Logger.error(`An error occurred while saving data for ${A}.json: ${y.message}`)}}static canGetData(){return game.user.hasPermission("FILES_BROWSE")||Utils.isGmActive()}static async getDataAsGm(y){try{return game.user.hasPermission("FILES_BROWSE")||Utils.isGmActive()?game.user.hasPermission("FILES_BROWSE")?await DataHandler.getData(y):await game.tokenActionHud.socket.executeAsGM("getData",y):void Logger.info("Cannot get data without a GM present",!0)}catch(y){return Logger.error(`An error occurred while getting data: ${y.message}`),null}}static async getData(y){const A=game.tokenActionHud.dataHandler,{id:w}=y,k=A.fileMap.get(w)??null;if(!k)return null;try{const y=Date.now(),A=await fetch(`${k}?ms=${y}`);return A.ok?await A.json():null}catch(y){return console.error(y),null}}static async saveDataMigrate(A,w,k){const H=`${y.ID}/${game.world.id}/${A}`,S=encodeURI(`${w}.json`),C=new File([JSON.stringify(k,null,"")],S,{type:"application/json"}),D=await FilePicker.upload("data",H,C,{},{notify:!1});D.path||Logger.debug(`Failed to save data to: ${S}\nReason: ${D}`)}static async getDataMigrate(A,w){const k=`${y.ID}/${game.world.id}/${A}`,H=encodeURI(`${w}.json`);try{const y=(await FilePicker.browse("data",k)).files.find((y=>y.endsWith(H)));if(y){const A=Date.now();return await fetch(`${y}?ms=${A}`).then((y=>y.ok?y.json():null)).catch((y=>{console.error(y)}))}return null}catch{return null}}}class GenericActionHandler{actionHandler;constructor(y){this.actionHandler=y,this.actor=y.actor,this.token=y.token}buildGenericActions(){this.#t()}#t(){if(this.actor)return this.#e();this.#i()}#e(){if(!this.token)return;const y=[],A="utility",w="toggleCombat",H=this.token?.inCombat?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),S=[A,w].join(k),C={id:w,name:H,encodedValue:S};if(y.push(C),game.user.isGM){const w="toggleVisibility",H=this.token?.document?.hidden?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),S=[A,w].join(k),C={id:w,name:H,encodedValue:S};y.push(C)}const D={id:"token",type:E};this.actionHandler.addActions(y,D)}#i(){const y=Utils.getControlledTokens(),A=[],w="utility",H="toggleCombat",S=y.every((y=>y.inCombat))?Utils.i18n("tokenActionHud.removeFromCombat"):Utils.i18n("tokenActionHud.addToCombat"),C=[w,H].join(k),D={id:H,name:S,encodedValue:C};if(A.push(D),game.user.isGM){const H="toggleVisibility",S=y.every((y=>y.document?.hidden))?Utils.i18n("tokenActionHud.makeVisible"):Utils.i18n("tokenActionHud.makeInvisible"),C=[w,H].join(k),D={id:H,name:S,encodedValue:C};A.push(D)}const I={id:"token",type:E};this.actionHandler.addActions(A,I)}}class CompendiumActionHandler{actionHandler;compendiumActions;packIds;constructor(y){this.actionHandler=y,this.compendiumActions=new Map,this.packIds=[]}async buildCompendiumActions(){if(0===this.compendiumActions.size){if(this.packIds=game.packs.filter((y=>C.includes(y.documentName)&&(game.version.startsWith("11")?y.visible:!y.private||game.user.isGM))).map((y=>y.metadata.id)),0===this.packIds.length)return;await Promise.all(this.packIds.map((y=>this.#s(y))))}for(const y of this.compendiumActions.values())this.actionHandler.addActions(y.actionsData,y.groupData)}async#s(y){const A=game.packs.get(y),w=A?A.index.size>0?A.index:await A.getIndex():null;if(!w)return;const S=this.#o(A?.documentName),C=w.map((A=>({id:A._id,name:A.name,encodedValue:[S,y,A._id].join(k),img:Utils.getImage(A),listName:`${Utils.i18n(H[S])}: ${A.name}`}))),D={id:this.#n(y),type:"core"};this.compendiumActions.set(y,{actionsData:C,groupData:D})}#o(y){switch(y){case"Macro":return"compendiumMacro";case"Playlist":return"compendiumPlaylist";default:return"compendiumEntry"}}#n(y){return y.replace(".","-")}isLinkedCompendium(y){return!!this.packIds.length&&this.packIds?.includes(y)}}class MacroActionHandler{actionHandler;macroActions;constructor(y){this.actionHandler=y,this.macroActions=null}async buildMacroActions(){if(!this.macroActions){const y={id:"macros",type:"core"},A=await this.#a();this.macroActions={actionsData:A,groupData:y}}this.actionHandler.addActions(this.macroActions.actionsData,this.macroActions.groupData)}async#a(){const y="macro";return game.macros.filter((y=>{const A=y.ownership;return A[game.userId]?A[game.userId]>0:A.default>0})).map((A=>{const w=A.id,S=A.name;return{id:w,name:S,listName:`${`${Utils.i18n(H[y])}: `??""}${S}`,encodedValue:[y,A.id].join(k),img:Utils.getImage(A)}}))}}class ActionHandler{characterName=null;actor=null;token=null;furtherActionHandlers=[];delimiter=k;constructor(){this.genericActionHandler=new GenericActionHandler(this),this.compendiumActionHandler=new CompendiumActionHandler(this),this.macroActionHandler=new MacroActionHandler(this),this.hud=[],this.defaultGroups={},this.defaultLayout={},this.groups={},this.actorGroups={},this.userGroups={},this.actions=[],this.availableActionsMap=new Map,this.customLayoutSetting=Utils.getSetting("customLayout"),this.userCustomLayoutSetting=Utils.getSetting("userCustomLayout"),this.enableCustomizationSetting=Utils.getSetting("enableCustomization"),this.displayCharacterNameSetting=Utils.getSetting("displayCharacterName"),this.sortActionsSetting=Utils.getSetting("sortActions"),this.tooltipsSetting=Utils.getSetting("tooltips")}softResetActionHandler(){this.genericActionHandler=new GenericActionHandler(this),this.hud=[],this.defaultGroups={},this.defaultLayout={},this.groups={},this.actions=[],this.availableActionsMap=new Map}hardResetActionHandler(){this.softResetActionHandler(),this.customLayoutSetting=Utils.getSetting("customLayout"),this.userCustomLayoutSetting=Utils.getSetting("userCustomLayout"),this.customLayout=null,this.actorGroups={},this.userGroups={}}async registerDefaultCategories(){}async buildHud(y){return Logger.debug("Building HUD...",{actor:this.actor,token:this.token}),this.previousActor?.id===this.actor?.id?this.isSameActor=!0:(this.previousActor=this.actor,this.isSameActor=!1),this.softResetActionHandler(),await Promise.all([this.#r(),this.#l(),this.#d()]),DataHandler.canGetData()||this.isGmInactiveUserNotified||(Logger.info("Cannot retrieve HUD layout without GM present",!0),this.isGmInactiveUserNotified=!0),await Promise.all([this.#c(),this.#g()]),this.hud=await this.#u(),await Promise.all([this.#h(),this.#p(),this.#m(),this.#f()]),this.buildFurtherActions(),this.#y(),this.#v(),this.#b(),await this.saveGroups(y),Logger.debug("HUD built",{hud:this.hud,actor:this.actor,token:this.token}),this.hud}async#u(){Logger.debug("Preparing HUD...",{actor:this.actor,token:this.token});const y=this.displayCharacterNameSetting?this.characterName??"Multiple":"",A=this.actor?.id??"multi",w={title:y,tokenId:this.token?.id??"multi",actorId:A,groups:[]};if(Object.keys(this.userGroups).length){const y=this.#T();for(const A of y)if(1===A.level){const y=this.#A(A);w.groups.push(y),this.groups[y.nestId]=y}else{const y=A.nestId.split("_",A.level-1).join("_"),k=await Utils.getGroupByNestId(w.groups,{nestId:y});if(k){const y=this.#A(A);"tab"===y.settings.style?k.groups.tabs.push(y):k.groups.lists.push(y),this.groups[y.nestId]=y}}}if(Object.keys(this.actorGroups).length){const y=this.#w();for(const A of y){const y=A.nestId.split("_",A.level-1).join("_"),k=await Utils.getGroupByNestId(w.groups,{nestId:A.nestId});if(k){if(A.actions?.length){k.actions=A.actions,this.actions.push(...k.actions);for(const y of k.actions)y.selected=!1}}else{const k=await Utils.getGroupByNestId(w.groups,{nestId:y});if(k&&"system-derived"===A.type){const y=this.#A(A);if(A.actions?.length){y.actions=A.actions,this.actions.push(...y.actions);for(const A of y.actions)A.selected=!1}"tab"===y.settings.style?k.groups.tabs.push(y):k.groups.lists.push(y),this.groups[y.nestId]=y}}}}return Logger.debug("HUD prepared",{hud:w,actor:this.actor,token:this.token}),w}async buildSystemActions(y){}async#h(){Logger.debug("Building system actions...",{actor:this.actor,token:this.token});const y=Object.values(this.groups).map((y=>y.id));await this.buildSystemActions(y),Logger.debug("System actions built",{hud:this.hud,actor:this.actor,token:this.token})}async#m(){Logger.debug("Building compendium actions..."),await this.compendiumActionHandler.buildCompendiumActions(),Logger.debug("Compendium actions built",{hud:this.hud})}#p(){Logger.debug("Building generic actions...",{actor:this.actor,token:this.token}),this.genericActionHandler.buildGenericActions(),Logger.debug("Generic actions built",{hud:this.hud,actor:this.actor,token:this.token})}async#f(){Logger.debug("Building macro actions..."),await this.macroActionHandler.buildMacroActions(),Logger.debug("Macro actions built",{hud:this.hud})}buildFurtherActions(){this.furtherActionHandlers.forEach((y=>y.extendActionList()))}#y(){const y=this.actions.filter((y=>!y?.isPreset));for(const A of y){const y=this.availableActionsMap.get(A.id);if(y){const w=y.systemSelected??A.systemSelected,k=A.userSelected??y.userSelected;Object.assign(A,this.#k({...y,systemSelected:w,userSelected:k}))}}}#v(){for(const y of Object.values(this.groups))y.actions.some((y=>y.selected))?y.hasActions=!0:y.hasActions=!1}#r(){const y=game.tokenActionHud.defaults?.groups?.length?game.tokenActionHud.defaults?.groups:game.tokenActionHud.defaults?.subcategories;if(!y)return{};for(const A of y)this.defaultGroups[A.id]=A}async#l(){if(Object.keys(this.defaultLayout).length)return;const y=game.tokenActionHud.defaults?.layout?.length?game.tokenActionHud.defaults?.layout:game.tokenActionHud.defaults?.categories;if(!y)return{};this.defaultLayout=await Utils.getNestedGroups(y)}async#d(){if(this.customLayout)return;const y=this.userCustomLayoutSetting||this.customLayoutSetting||null;this.customLayout=y?await DataHandler.getDataAsGm({file:y}):null}async exportLayout(){const y=await DataHandler.getDataAsGm({type:"user",id:game.userId})??this.customLayout??this.defaultLayout;y&&saveDataToFile(JSON.stringify(y,null,2),"text/json","token-action-hud-layout.json")}async#g(){if(!this.actor)return;if(!this.enableCustomizationSetting)return void(this.actorGroups={});if(this.isSameActor&&Object.entries(this.actorGroups).length)return;if(!DataHandler.canGetData())return void(this.actorGroups={});Logger.debug("Retrieving groups from actor...",{actor:this.actor}),this.actorGroups={};const y=await DataHandler.getDataAsGm({type:"actor",id:this.actor.id})??null;if(y){for(const A of Object.entries(y))A[1].nestId=A[0];this.actorGroups=y,Logger.debug("Groups from actor retrieved",{actorGroups:this.actorGroups,actor:this.actor})}}async#c(){const y=game.user,A=this.customLayout??this.defaultLayout,getUserGroups=y=>{const w=Object.keys(y).length?y:A;for(const y of Object.entries(w))y[1].nestId=y[0];return w};if(!this.enableCustomizationSetting)return void(this.userGroups=getUserGroups(A));if(Object.entries(this.userGroups).length)return;if(!DataHandler.canGetData())return void(this.userGroups=getUserGroups(A));Logger.debug("Retrieving groups from user...",{user:y}),this.userGroups={};const w=await DataHandler.getDataAsGm({type:"user",id:y.id})??{};this.userGroups=getUserGroups(w),Logger.debug("Groups retrieved from user",{userGroups:this.userGroups,user:y})}getGroup(y={}){return y?.nestId?this.groups[y.nestId]:Object.values(this.groups).find((A=>!(y.id&&A.id!==y.id||y.type&&A.type!==y.type||y.level&&A.level!==y.level)))}#H(y={}){return Object.values(this.groups).filter((A=>(!y.id||A.id===y.id)&&(!y.nestId||A.nestId.startsWith(y.nestId))&&(!y.type||A.type===y.type)&&(!y.level||A.level===y.level)&&(!y.selected||A.selected===y.selected)))}#w(y={}){return Object.values(this.actorGroups).filter((A=>(!y.id||A.id===y.id)&&(!y.nestId||A.nestId.startsWith(y.nestId))&&(!y.type||A.type===y.type)&&(!y.level||A.level===y.level))).sort(((y,A)=>y.level===A.level?y.order-A.order:y.level-A.level))}#T(y={}){return Object.values(this.userGroups).filter((A=>(!y.id||A.id===y.id)&&(!y.nestId||A.nestId.startsWith(y.nestId))&&(!y.type||A.type===y.type)&&(!y.level||A.level===y.level))).sort(((y,A)=>y.level===A.level?y.order-A.order:y.level-A.level))}getGroupSettings(y){const A=this.getGroup(y);return A?.settings??null}saveGroupSettings(y){const A=this.getGroup(y);A.settings={...A.settings,...y.settings},this.saveGroups({saveActor:!0,saveUser:!0})}#A(y,A=!1){const w=Utils.deepClone(y),k=y.nestId.split("_").length??1,H=this.#S(y?.tooltip,w?.name),S=A?y?.actions??[]:[],C=A?y?.groups??{lists:[],tabs:[]}:{lists:[],tabs:[]},D={showTitle:!0,style:1===k?"tab":"list"},I=w?.settings??{};I.showTitle??=D.showTitle,I.style??=D.style,w.subtitleClass=I.showTitle?"":"tah-hidden";const E={actions:S,class:w?.class??w?.cssClass??"",groups:C,id:w?.id,info1:w?.info1??"",info2:w?.info2??"",info3:w?.info3??"",level:w.level??k??1,listName:w?.listName??w?.name,name:w?.name,nestId:w?.nestId??w?.id,order:w.order,selected:w?.selected??w?.isSelected??w?.defaultSelected??!0,settings:I,tooltip:H,type:w?.type??x};return 1===k?{...E}:{...E,subtitleClass:w?.subtitleClass??""}}updateGroups(y,A){Array.isArray(y)||(y=[y]);const w={level:(A?.level??0)+1};A?.nestId&&(w.nestId=A.nestId);const k=this.#H(w);for(const A of k)"system-derived"===A.type?A.selected=!1:y.find((y=>y.id===A.id))||delete this.groups[A.nestId];let H=0;for(const w of y){w.nestId=A?.nestId?`${A.nestId}_${w.id}`:w.id,w.selected=w.selected??!0,w.order=H;const y=this.getGroup(w);if(y)Object.assign(y,w);else{const y=this.#A(w);this.groups[w.nestId]=y}H++}if(A?.settings){const y=this.getGroup(A);y&&(y.settings=A.settings)}}async saveGroups(y={saveActor:!1,saveUser:!1}){this.enableCustomizationSetting&&(Logger.debug("Saving groups..."),y?.saveActor&&await this.#C(),y?.saveUser&&await this.#D(),Logger.debug("Groups saved",{groups:this.groups}))}async#C(){if(!Object.keys(this.groups).length)return;Logger.debug("Saving actor groups...");const y={};this.actorGroups={};for(const A of Object.values(this.groups))this.actorGroups[A.nestId]=A,y[A.nestId]=this.#I(A,!0);DataHandler.canSaveData()?(await DataHandler.saveDataAsGm("actor",this.actor.id,y),Logger.debug("Actor groups saved",{actorGroups:y})):Logger.debug("Actor groups not saved as no GM present")}async#D(){if(!Object.keys(this.groups).length)return;Logger.debug("Saving user groups...");const y={};this.userGroups={};for(const A of Object.values(this.groups))"system-derived"!==A.type&&(this.userGroups[A.nestId]=A,y[A.nestId]=this.#I(A,!1));DataHandler.canSaveData()?(await DataHandler.saveDataAsGm("user",game.userId,y),Logger.debug("User groups saved",{userGroups:y})):Logger.debug("User groups not saved as no GM present")}#I(y,A=!1){const w={id:y.id,name:y.name,listName:y.listName,selected:y.selected,level:y.level,order:y.order,settings:y.settings,type:y.type};return A&&(w.actions=y.actions.map((y=>({id:y.id,isPreset:y.isPreset,userSelected:y.userSelected})))),w}#a(y){return this.actions.filter((A=>A.id===y.id))}#S(y,A){return"none"===this.tooltipsSetting?null:"nameOnly"===this.tooltipsSetting?A:"full"===this.tooltipsSetting&&y?y.includes("tah-tooltip-wrapper")?y:`<div class="tah-tooltip-wrapper">${y}</div>`:A}#k(y){const A=y.fullName??y.name,w=this.#S(y?.tooltip,A);return{encodedValue:y.encodedValue,id:y.id,name:y.name,fullName:A,listName:y.listName??y.name,cssClass:y.cssClass??"",icons:y.icon??{},icon1:y.icon1??"",icon2:y.icon2??"",icon3:y.icon3??"",img:y.img??"",info1:{class:y?.info1?.class??"",icon:y?.info1?.icon??"",text:y?.info1?.text??"",title:y?.info1?.title??""},info2:{class:y?.info2?.class??"",icon:y?.info2?.icon??"",text:y?.info2?.text??"",title:y?.info2?.title??""},info3:{class:y?.info3?.class??"",icon:y?.info3?.icon??"",text:y?.info3?.text??"",title:y?.info3?.title??""},isAction:!0,isItem:y.isitem??null,isPreset:y.isPreset??!1,userSelected:y.userSelected??!0,systemSelected:y.systemSelected??!0,selected:!!y.systemSelected&&(y.userSelected??y.systemSelected??!0),tooltip:w,useRawHtmlName:y.useRawHtmlName??!1}}updateActions(y,A){const w=this.getGroup(A),k=w.actions,H=[];for(const A of y){if(A.id.includes("itemMacro"))continue;const y=w.actions.find((y=>y.id===A.id));if(y){const A={...y,userSelected:!0};H.push(A)}else{const y=this.availableActionsMap.get(A.id);if(y){const A={...y,userSelected:!0};H.push(A)}}}for(const A of k){if(!A.id||A?.id.includes("itemMacro"))continue;if(!y.find((y=>y.id===A.id))&&A.isPreset){const y={...A,userSelected:!1};H.push(y)}}(A?.settings?.sort||void 0===A?.settings?.sort&&this.sortActionsSetting)&&H.sort(((y,A)=>y.name.localeCompare(A.name))),w.actions=H}#x(y){y.forEach(((y,A)=>{this.availableActionsMap.has(A)||this.availableActionsMap.set(A,y)}))}getAvailableActions(){return[...this.availableActionsMap.values()].map((y=>this.#E(y))).sort(((y,A)=>y.value.localeCompare(A.value)))}getSelectedActions(y){const A=this.getGroup(y);if(A)return A.actions.filter((y=>!0===y.selected)).map((y=>this.#E(y)))}getSelectedGroups(y={}){y.selected=!0,y.level=(y.level||0)+1;const A=this.#H(y);return A?.map((y=>this.#L(y)))??[]}async getAvailableGroups(y){return[...await this.#M(y),...await this.#U(),...await this.#O(),...await this.#G()]}#O(){return game.packs.filter((y=>C.includes(y.documentName)&&(game.version.startsWith("11")?y.visible:!y.private||game.user.isGM))).map((y=>({id:y.metadata.id.replace(".","-"),listName:`Group: ${y.metadata.label}`,name:y.metadata.label,type:"core"}))).map((y=>this.#L(y)))}#M(y){const A=this.#H({nestId:y?.nestId,type:L});return A?.map((y=>this.#L(y)))??[]}#G(){return[this.#L({id:"macros",listName:`Group: ${Utils.i18n("tokenActionHud.macros")}`,name:Utils.i18n("tokenActionHud.macros"),type:"core"})]}#U(){return Object.values(this.defaultGroups).map((y=>this.#L(y)))}addGroup(y,A,w=!1){if(y.type=y?.type??"system-derived",y.style=y?.style??"list",!A?.id&&!A?.nestId)return;const k=this.#H(A);if(k?.length)for(const A of k){const k=`${A.nestId}_${y.id}`,H=this.#H({...y,nestId:k});if(H.length)if(w)for(const A of H)y.info&&(Object.assign(y,{...y.info}),delete y.info),Object.assign(A,this.#A({...A,...y},!0));else for(const A of H){const w=this.#S(y.tooltip,A.name);Object.assign(A,{tooltip:w})}else{const w=this.#A({...y,nestId:k});"tab"===w.settings.style?A.groups.tabs.push(w):A.groups.lists.push(w),this.groups[w.nestId]=w}}}updateGroup(y,A=null){y.type=y?.type??"system-derived";const updateExistingGroups=A=>{for(const w of A)y.info&&(Object.assign(y,{...y.info}),delete y.info),Object.assign(w,this.#A({...w,...y},!0))};if(A){const w=this.#H(A);for(const A of w){const w=`${A.nestId}_${y.id}`;updateExistingGroups(this.#H({...y,nestId:w}))}}else{updateExistingGroups(this.#H(y))}}removeGroup(y){!y?.nestId&&y?.id&&Utils.deleteGroupsById(this.hud.groups,y.id);const A=this.#H(y);if(A?.length)for(const w of A)delete this.groups[w.nestId],y?.nestId&&Utils.deleteGroupByNestId(this.hud.groups,w.nestId)}addGroupInfo(y){const A=y?.id,w=y?.info;if(!A||!w)return;this.#H(y).forEach((y=>{y.info1=w.info1,y.info2=w.info2,y.info3=w.info3}))}addActions(y,A){if(!y.length)return;const w=new Map(y.map((y=>[y.id,this.#k(y)])));if(this.#x(w),!A?.id)return;const k=this.#H(A);if(k)for(const y of k){const k=new Map(y.actions.map((y=>[y.id,y]))),H=[];k.forEach(((y,A)=>{const k=w.get(A);if(k){const A=k.systemSelected??y.systemSelected,w=y.userSelected??k.userSelected,H=!!A&&(w??A??!0);Object.assign(y,{...k,isPreset:!0,selected:H,systemSelected:A,userSelected:w})}else if(!y.selected&&y.isPreset){const A=!1;Object.assign(y,this.#k({...y,systemSelected:A}))}})),w.forEach(((y,A)=>{k.get(A)||H.push(this.#k({...y,isPreset:!0}))})),(A?.settings?.sort||void 0===A?.settings?.sort&&this.sortActionsSetting)&&H.sort(((y,A)=>y.name.localeCompare(A.name))),y.actions.push(...H)}}#b(){const y=this.#H({level:1});for(const A of y){const y=A?.settings?.characterCount,w=this.#H({nestId:A.nestId});for(const A of w){const w=A.actions;if(!w||0===w?.length)continue;const k=A?.settings?.characterCount,H=k>=0?y:k;if(!(!H&&0!==H||H<0))for(const y of w)y.name.length<=H||(y.name=0!==H?y.name.split(" ").map((y=>y.slice(0,H))).join(" "):"")}}}addFurtherActionHandler(y){Logger.debug("Adding further action handler...",{handler:y}),this.furtherActionHandlers.push(y)}#L(y){return{id:y.id,name:y.name,type:y.type,value:y.listName??y.name}}#E(y){return{id:y.id,name:y.name,type:"action",value:y.listName??y.name}}addActionsToActionList(y,A){globalThis.logger.warn("Token Action HUD | ActionHandler.addActionsToActionList is deprecated. Use ActionHandler.addActions"),this.addActions(y,A)}addSubcategoryInfo(y){globalThis.logger.warn("Token Action HUD | ActionHandler.addSubcategoryInfo is deprecated. Use ActionHandler.addGroupInfo"),this.addGroupInfo(y)}addSubcategoryToActionList(y,A,w=!1){globalThis.logger.warn("Token Action HUD | ActionHandler.addSubcategoryToActionList is deprecated. Use ActionHandler.addGroup"),this.addGroup(A,y,w)}sortItems(y){return globalThis.logger.warn("ActionHandler.sortItems is deprecated. Use Utils.sortItems"),Utils.sortItems(y)}sortItemsByName(y){return globalThis.logger.warn("ActionHandler.sortItemsByName is deprecated. Use Utils.sortItemsByName"),Utils.sortItemsByName(y)}}class ActionListExtender extends ActionHandler{extendActionList(){}}class MigrationManager{constructor(y){this.socket=y}async init(){if(!game.user.isGM)return;const y=game.modules.get("token-action-hud-core").version,A=Utils.getSetting("migrationVersion");if(y===A)return;let w=!0;w=!(!A||A<"1.4.10")||await this.#N(),w=!(isPersistentStorage()&&(!A||A<"1.4.11"))||await this.#P(),w&&Utils.setSetting("migrationVersion",y)}async#N(){try{const A=game.users.filter((A=>A.getFlag(y.ID,"categories")));for(const w of A)w.unsetFlag(y.ID,"categories"),w.unsetFlag(y.ID,"defaults");const w=game.actors.filter((A=>A.getFlag(y.ID,"categories")));for(const A of w)A.unsetFlag(y.ID,"categories");const k=game.canvas.tokens.objects.children.filter((A=>A.actor?.getFlag(y.ID,"categories")));for(const A of k)A.actor?.unsetFlag(y.ID,"categories");for(const A of game.scenes){const w=A.tokens.filter((A=>A.actor?.getFlag(y.ID,"categories")));for(const A of w)A.actor?.unsetFlag(y.ID,"categories")}return!0}catch(y){return Logger.debug(y.message,y),!1}}async#P(){try{Logger.info("Migrating files to persistent storage...",!0);for(const y of game.users){const A=await DataHandler.getDataMigrate("user",y.id);A&&await DataHandler.saveData("user",y.id,A)}for(const y of game.actors){const A=await DataHandler.getDataMigrate("actor",y.id);A&&await DataHandler.saveData("actor",y.id,A)}return Logger.info("Successfully migrated files to persistent storage",!0),!0}catch{return Logger.info("Failed to migrate files to persistent storage",!0),!1}}}class RollHandler{actor=null;token=null;delimiter=k;preRollHandlers=[];throwInvalidValueErr(y){throw new Error(`Error handling button click: ${y}`)}async handleActionEvent(y,A,w){Logger.debug(`Handling event for action [${A}]`,{event:y}),this.actor=w.actor,this.token=w.token,this.registerKeyPresses(y);let k=!1;this.preRollHandlers.forEach((H=>{k||(k=H.prehandleActionEvent(y,A,w))})),k||(this.#F(A)?await this.#B(A):this.doHandleActionEvent(y,A))}doHandleActionEvent(y,A){}addPreRollHandler(y){Logger.debug(`Adding pre-roll handler ${y.constructor.name}`),this.preRollHandlers.push(y)}registerKeyPresses(y){this.rightClick=this.isRightClick(y),this.ctrl=this.isCtrl(y),this.alt=this.isAlt(y),this.shift=this.isShift(y)}doRenderItem(y,A){y||(y=this.actor);Utils.getItem(y,A).sheet.render(!0)}isRenderItem(){return Utils.getSetting("renderItemOnRightClick")&&this.rightClick&&!(this.alt||this.ctrl||this.shift)}isRightClick(y){return 2===y?.originalEvent?.button}isAlt(y){const A=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.ALT);return y.altKey&&!A?(Logger.debug("Emulating LEFT ALT key press"),KeyboardManager.emulateKeypress(!1,"AltLeft",{altKey:!0,force:!0}),game.keyboard.downKeys.add("AltLeft"),!0):A}isCtrl(y){const A=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.CONTROL);return y.ctrlKey&&!A?(Logger.debug("Emulating LEFT CTRL key press"),KeyboardManager.emulateKeypress(!1,"ControlLeft",{ctrlKey:!0,force:!0}),game.keyboard.downKeys.add("ControlLeft"),!0):A}isShift(y){const A=game.keyboard.isModifierActive(KeyboardManager.MODIFIER_KEYS.SHIFT);return y.shiftKey&&!A?(Logger.debug("Emulating LEFT SHIFT key press"),KeyboardManager.emulateKeypress(!1,"ShiftLeft",{shiftKey:!0,force:!0}),game.keyboard.downKeys.add("ShiftLeft"),!0):A}#F(y){const A=y.split(k),w=A[0],H=A[1];return"utility"===w&&H.includes("toggle")}async#B(y){const A=y.split(k)[1],w=Utils.getFirstControlledToken();"toggleVisibility"===A&&await w.toggleVisibility(),"toggleCombat"===A&&await w.toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud")}}class PreRollHandler extends RollHandler{prehandleActionEvent(y,A){return!1}}class CustomStyleForm extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{title:Utils.i18n("tokenActionHud.settings.customStyle.form.title"),template:w.customStyleForm,id:"token-action-hud-core-settings",width:600,height:600,popOut:!0,resizable:!0,closeOnSubmit:!0})}constructor(...y){super(y)}getData(){return this.data={backgroundColor:Utils.getSetting("backgroundColor",I.backgroundColor.default),buttonHeight:Utils.getSetting("buttonHeight",I.buttonHeight.default),buttonBackgroundColor:Utils.getSetting("buttonBackgroundColor",I.buttonBackgroundColor.default),buttonHoverBackgroundColor:Utils.getSetting("buttonHoverBackgroundColor",I.buttonHoverBackgroundColor.default),buttonToggleActiveBackgroundColor:Utils.getSetting("buttonToggleActiveBackgroundColor",I.buttonToggleActiveBackgroundColor.default),buttonToggleHoverBackgroundColor:Utils.getSetting("buttonToggleHoverBackgroundColor",I.buttonToggleHoverBackgroundColor.default),buttonTextColor:Utils.getSetting("buttonTextColor",I.buttonTextColor.default),buttonHoverTextColor:Utils.getSetting("buttonHoverTextColor",I.buttonHoverTextColor.default),buttonToggleActiveTextColor:Utils.getSetting("buttonToggleActiveTextColor",I.buttonToggleActiveTextColor.default),buttonToggleHoverTextColor:Utils.getSetting("buttonToggleHoverTextColor",I.buttonToggleHoverTextColor.default),buttonBorderPrimaryColor:Utils.getSetting("buttonBorderPrimaryColor",I.buttonBorderPrimaryColor.default),buttonBorderSecondaryColor:Utils.getSetting("buttonBorderSecondaryColor",I.buttonBorderSecondaryColor.default),buttonHoverBorderPrimaryColor:Utils.getSetting("buttonHoverBorderPrimaryColor",I.buttonHoverBorderPrimaryColor.default),buttonHoverBorderSecondaryColor:Utils.getSetting("buttonHoverBorderSecondaryColor",I.buttonHoverBorderSecondaryColor.default),buttonToggleActiveBorderPrimaryColor:Utils.getSetting("buttonToggleActiveBorderPrimaryColor",I.buttonToggleActiveBorderPrimaryColor.default),buttonToggleActiveBorderSecondaryColor:Utils.getSetting("buttonToggleActiveBorderSecondaryColor",I.buttonToggleActiveBorderSecondaryColor.default),buttonToggleHoverBorderPrimaryColor:Utils.getSetting("buttonToggleHoverBorderPrimaryColor",I.buttonToggleHoverBorderPrimaryColor.default),buttonToggleHoverBorderSecondaryColor:Utils.getSetting("buttonToggleHoverBorderSecondaryColor",I.buttonToggleHoverBorderSecondaryColor.default),textPrimaryColor:Utils.getSetting("textPrimaryColor",I.textPrimaryColor.default),textSecondaryColor:Utils.getSetting("textSecondaryColor",I.textSecondaryColor.default),textTertiaryColor:Utils.getSetting("textTertiaryColor",I.textTertiaryColor.default),textHoverPrimaryColor:Utils.getSetting("textHoverPrimaryColor",I.textHoverPrimaryColor.default),textHoverSecondaryColor:Utils.getSetting("textHoverSecondaryColor",I.textHoverSecondaryColor.default),textHoverTertiaryColor:Utils.getSetting("textHoverTertiaryColor",I.textHoverTertiaryColor.default)},this.data}activateListeners(y){super.activateListeners(y);y.find("#tah-custom-style-reset-button").on("click",this._reset.bind(this)),"undefined"!=typeof ColorPicker&&ColorPicker.install()}_reset(){for(const[y,A]of Object.entries(I))Utils.setSetting(y,A.default),document.querySelector(":root").style.setProperty(A.cssProperty,A.default);this.render(!0)}_updateObject(y,A){for(const[y,w]of Object.entries(A)){const A=I[y];w!==this.data[y]&&(Utils.setSetting(y,w),document.querySelector(":root").style.setProperty(A.cssProperty,w))}}}class TahSettingsForm extends FormApplication{static get defaultOptions(){return mergeObject(super.defaultOptions,{template:w.settings,id:"token-action-hud-core-settings",width:600,height:"auto",closeOnSubmit:!0})}constructor(...y){super(y)}async getData(){const y=[];for(const[A,w]of Object.entries(this.settings)){if("world"===w?.scope&&!game.user.isGM)continue;const k=A,H=Utils.i18n(w.hint),S=w.icon,C=Utils.i18n(w.label),D=Utils.i18n(w.name),I=w?.scope?await Utils.getSetting(A):"",x=w.type instanceof Function?w.type.name:"String",E="button"===w.inputType,L=w.onClick,M="checkbox"===w.inputType,U="filePicker"===w.inputType,O="filePicker"===w.inputType?x??"any":"",G="number"===w.inputType,P="range"===w.inputType&&w.range,F=void 0!==w.choices;y.push({id:k,hint:H,icon:S,label:C,name:D,value:I,type:x,isButton:E,onClick:L,isCheckbox:M,isFilePicker:U,filePickerType:O,isNumber:G,isRange:P,isSelect:F})}return{settings:y}}activateListeners(y){super.activateListeners(y),super.activateListeners(y);y.find("#tah-form-cancel").on("click",this.close.bind(this))}_updateObject(y,A){for(const[y,w]of Object.entries(A))this.settings[y].scope&&(Utils.setSetting(y,w),game.tokenActionHud.updateSettings(y,w));game.tokenActionHud.update()}}class TahSettingsFormLayout extends TahSettingsForm{constructor(){super(),this.settings=O}static get defaultOptions(){return mergeObject(super.defaultOptions,{title:Utils.i18n("tokenActionHud.settings.layout.form.title")})}}function onChangeFunction(y,A){game.tokenActionHud&&game.tokenActionHud.updateSettings(y,A)}Hooks.on("init",(async()=>{game.keybindings.register(y.ID,"toggleHud",{name:Utils.i18n("tokenActionHud.toggleHud"),editable:[],onDown:()=>{game.tokenActionHud.toggleHud()}})}));const registerSettings=function(A,w){game.settings.registerMenu(y.ID,"customStyle",{hint:Utils.i18n("tokenActionHud.settings.customStyle.hint"),label:Utils.i18n("tokenActionHud.settings.customStyle.label"),name:Utils.i18n("tokenActionHud.settings.customStyle.name"),icon:"fas fa-palette",type:CustomStyleForm,restricted:!1,scope:"client"}),game.settings.registerMenu(y.ID,"layout",{hint:Utils.i18n("tokenActionHud.settings.layout.hint"),label:Utils.i18n("tokenActionHud.settings.layout.label"),name:Utils.i18n("tokenActionHud.settings.layout.name"),icon:"fas fa-table-layout",type:TahSettingsFormLayout,restricted:!1,scope:"client"}),game.settings.register(y.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.register(y.ID,"migrationVersion",{name:"Migration Version",scope:"world",config:!1,type:String,default:"0.0"}),game.settings.register(y.ID,"style",{name:Utils.i18n("tokenActionHud.settings.style.name"),hint:Utils.i18n("tokenActionHud.settings.style.hint"),scope:"client",config:!0,type:String,default:"foundryVTT",choices:{foundryVTT:"Foundry VTT Dark",foundryVttLight:"Foundry VTT Light",compact:"Foundry VTT Compact Dark",dorakoUI:"Dorako UI",highContrast:"High Contrast",pathfinder:"Pathfinder",custom:"Custom"},onChange:y=>{Utils.switchCSS(y)}}),game.settings.register(y.ID,"customLayout",{name:Utils.i18n("tokenActionHud.settings.customLayout.name"),hint:Utils.i18n("tokenActionHud.settings.customLayout.hint"),scope:"world",config:!1,type:String}),game.settings.register(y.ID,"userCustomLayout",{name:Utils.i18n("tokenActionHud.settings.userCustomLayout.name"),hint:Utils.i18n("tokenActionHud.settings.userCustomLayout.hint"),scope:"client",config:!1,type:String}),game.settings.register(y.ID,"direction",{name:Utils.i18n("tokenActionHud.settings.direction.name"),hint:Utils.i18n("tokenActionHud.settings.direction.hint"),scope:"client",config:!0,type:String,default:"auto",choices:{auto:Utils.i18n("tokenActionHud.settings.direction.choice.auto"),up:Utils.i18n("tokenActionHud.settings.direction.choice.up"),down:Utils.i18n("tokenActionHud.settings.direction.choice.down")},onChange:y=>{onChangeFunction("direction",y)}}),game.settings.register(y.ID,"grid",{name:Utils.i18n("tokenActionHud.settings.grid.name"),hint:Utils.i18n("tokenActionHud.settings.grid.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("grid",y)}}),game.settings.register(y.ID,"scale",{name:Utils.i18n("tokenActionHud.settings.scale.name"),hint:Utils.i18n("tokenActionHud.settings.scale.hint"),scope:"client",config:!0,type:Number,range:{min:.5,max:2,step:.05},default:1,onChange:y=>{onChangeFunction("scale",y)}}),game.settings.register(y.ID,"drag",{name:Utils.i18n("tokenActionHud.settings.drag.name"),hint:Utils.i18n("tokenActionHud.settings.drag.hint"),scope:"client",config:!0,type:String,default:"whenUnlocked",choices:{always:Utils.i18n("tokenActionHud.settings.drag.choices.always"),whenUnlocked:Utils.i18n("tokenActionHud.settings.drag.choices.whenUnlocked"),never:Utils.i18n("tokenActionHud.settings.drag.choices.never")},onChange:y=>{onChangeFunction("drag",y)}}),game.settings.register(y.ID,"enable",{name:Utils.i18n("tokenActionHud.settings.enable.name"),hint:Utils.i18n("tokenActionHud.settings.enable.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("enable",y)}}),game.settings.register(y.ID,"rollHandler",{name:Utils.i18n("tokenActionHud.settings.rollHandler.name"),hint:Utils.i18n("tokenActionHud.settings.rollHandler.hint"),scope:"world",config:!0,type:String,choices:w,default:"core",onChange:y=>{onChangeFunction("rollHandler",y)}}),game.settings.register(y.ID,"allow",{name:Utils.i18n("tokenActionHud.settings.allow.name"),hint:Utils.i18n("tokenActionHud.settings.allow.hint"),scope:"world",config:!0,type:String,choices:{4:Utils.i18n("tokenActionHud.settings.allow.choice.4"),3:Utils.i18n("tokenActionHud.settings.allow.choice.3"),2:Utils.i18n("tokenActionHud.settings.allow.choice.2"),1:Utils.i18n("tokenActionHud.settings.allow.choice.1")},default:1,requiresReload:!0}),game.settings.register(y.ID,"enableCustomization",{name:Utils.i18n("tokenActionHud.settings.enableCustomization.name"),hint:Utils.i18n("tokenActionHud.settings.enableCustomization.hint"),scope:"world",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("enableCustomization",y)}}),game.settings.register(y.ID,"alwaysShowHud",{name:Utils.i18n("tokenActionHud.settings.alwaysShowHud.name"),hint:Utils.i18n("tokenActionHud.settings.alwaysShowHud.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("alwaysShowHud",y)}}),game.settings.register(y.ID,"displayCharacterName",{name:Utils.i18n("tokenActionHud.settings.displayCharacterName.name"),hint:Utils.i18n("tokenActionHud.settings.displayCharacterName.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("displayCharacterName",y)}}),game.settings.register(y.ID,"sortActions",{name:Utils.i18n("tokenActionHud.settings.sortActions.name"),hint:Utils.i18n("tokenActionHud.settings.sortActions.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("sortActions",y)}}),game.settings.register(y.ID,"displayIcons",{name:Utils.i18n("tokenActionHud.settings.displayIcons.name"),hint:Utils.i18n("tokenActionHud.settings.displayIcons.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("displayIcons",y)}}),game.settings.register(y.ID,"tooltips",{name:Utils.i18n("tokenActionHud.settings.tooltips.name"),hint:Utils.i18n("tokenActionHud.settings.tooltips.hint"),scope:"client",config:!0,type:String,default:"full",choices:{full:Utils.i18n("tokenActionHud.settings.tooltips.choices.full"),nameOnly:Utils.i18n("tokenActionHud.settings.tooltips.choices.nameOnly"),none:Utils.i18n("tokenActionHud.settings.tooltips.choices.none")},onChange:y=>{onChangeFunction("tooltips",y)}}),game.settings.register(y.ID,"tooltipDelay",{name:Utils.i18n("tokenActionHud.settings.tooltipDelay.name"),hint:Utils.i18n("tokenActionHud.settings.tooltipDelay.hint"),scope:"client",config:!0,type:Number,default:1500,onChange:y=>{setTooltipDelay(y)}});function setTooltipDelay(y){document.querySelector(":root").style.setProperty("--tah-tooltip-delay",`${y}ms`)}setTooltipDelay(Utils.getSetting("tooltipDelay")||1500),game.settings.register(y.ID,"clickOpenCategory",{name:Utils.i18n("tokenActionHud.settings.clickOpenCategory.name"),hint:Utils.i18n("tokenActionHud.settings.clickOpenCategory.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("clickOpenCategory",y)}}),game.settings.register(y.ID,"renderItemOnRightClick",{name:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.name"),hint:Utils.i18n("tokenActionHud.settings.renderItemOnRightClick.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:y=>{onChangeFunction("renderItemOnRightClick",y)}}),Utils.isModuleActive("itemacro")&&!Utils.isModuleActive("midi-qol")&&game.settings.register(y.ID,"itemMacro",{name:Utils.i18n("tokenActionHud.settings.itemMacro.name"),hint:Utils.i18n("tokenActionHud.settings.itemMacro.hint"),scope:"client",config:!0,type:String,choices:{both:Utils.i18n("tokenActionHud.settings.itemMacro.choices.both"),itemMacro:Utils.i18n("tokenActionHud.settings.itemMacro.choices.itemMacro"),original:Utils.i18n("tokenActionHud.settings.itemMacro.choices.original")},default:"both",onChange:y=>{onChangeFunction("itemMacro",y)}}),game.settings.register(y.ID,"activeCssAsText",{name:Utils.i18n("tokenActionHud.settings.activeCssAsText.name"),hint:Utils.i18n("tokenActionHud.settings.activeCssAsText.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("activeCssAsText",y)}}),game.settings.register(y.ID,"debug",{name:Utils.i18n("tokenActionHud.settings.debug.name"),hint:Utils.i18n("tokenActionHud.settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:y=>{onChangeFunction("debug",y)}}),function registerCustomStyleSettings(){for(const[A,w]of Object.entries(I))game.settings.register(y.ID,A,{scope:"client",config:!1,type:w.type,default:w.default})}(),A.doRegisterSettings(onChangeFunction),Logger.debug("Available roll handlers",{rollHandlers:w})};class ItemMacroActionListExtender extends ActionListExtender{constructor(y){super(y),this.actionHandler=y,this.actor=this.actionHandler.actor,this.token=this.actionHandler.token}extendActionList(){if(this.actor=this.actionHandler.actor,this.token=this.actionHandler.token,!this.actor)return;const y=this.actor.items.filter((y=>y.flags?.itemacro?.macro?.command));let A;if(A=Utils.isModuleActive("midi-qol")?y.filter(this.#_).map((y=>y.id)):y.map((y=>y.id)),!A)return;if(0===A.length)return;const w=Utils.getSetting("itemMacro");if("original"===w)return;const k="itemMacro"===w;Object.keys(this.actionHandler.groups).forEach((y=>{const w=this.actionHandler.groups[y];this.#R(A,w,k)}))}#R(y,A,w){if(!A?.actions?.length)return;const k=[];A.actions.forEach((H=>{if(!y.includes(H.id))return;const S=A.actions.find((y=>y.id===`itemMacro+${H.id}`)),C=S??H;S&&(w=!0);const D=this.#$(H,C,w);w||k.push(D)})),this.#V(k,A)}#$(y,A,w){const H=w?A:Utils.deepClone(y);return H.encodedValue=`itemMacro${y.encodedValue?.substr(y.encodedValue.indexOf(k))}`,H.id=`itemMacro+${y.id}`,H.fullName=y.fullName,H.listName=`Item Macro: ${y.fullName}`,H.name=y.name,H.itemMacroIcon=`<i class="${M}" data-tooltip="${U}"></i>`,H}#V(y,A){y.forEach((y=>{const w=A.actions.findIndex((A=>A.id===y.id))+1;A.actions.splice(w,0,y)}))}#_(y){return!y.getFlag("midi-qol","onUseMacroName")}}class CompendiumMacroPreHandler extends PreRollHandler{prehandleActionEvent(y,A){const w=A.split(k);if(w.length<2)return!1;let H=null,C=null,D=null;if(2===w.length&&(H=w[0],D=w[1]),3===w.length&&(H=w[0],C=w[1],D=w[2]),!S.includes(H))return!1;switch(H){case"compendiumEntry":this.#j(C,D);break;case"compendiumMacro":this.#W(C,D);break;case"compendiumPlaylist":this.#z(C,D);break;case"macro":this.#q(D);break;default:return!1}return!0}#j(y,A){game.packs.get(y).getDocument(A).then((y=>y.sheet.render(!0)))}#W(y,A){game.packs.get(y).getDocument(A).then((y=>y.execute()))}async#z(y,A){const w=game.packs.get(y),k=A.split(">"),H=k[0],S=k[1],C=(await w.getDocument(H)).sounds.find((y=>y._id===S));AudioHelper.play({src:C.path},{})}#q(y){game.macros.get(y).execute()}}class ItemMacroPreRollHandler extends PreRollHandler{prehandleActionEvent(y,A,w){this.actor=w.actor;const H=A.split(k);if(2!==H.length)return!1;const S=H[0],C=H[1];return"itemMacro"===S&&(this.isRenderItem()?(this.doRenderItem(this.actor,C),!0):this.#K(C))}#K(y){const A=Utils.getItem(this.actor,y);try{A.executeMacro()}catch(y){return Logger.debug("ItemMacro Error",y),!1}return!0}}class SystemManager{constructor(){this.coreModuleId=y.ID}doGetActionHandler(){}doGetRollHandler(y){}getAvailableRollHandlers(){}doRegisterSettings(y){}async doRegisterDefaultFlags(){}async registerDefaults(){const y=await this.doRegisterDefaultFlags()??[];Hooks.callAll("tokenActionHudCoreRegisterDefaults",y),y&&(y?.categories&&globalThis.logger.warn("Token Action HUD | SystemManager.doRegisterDefaultFlags expects 'layout' to be returned instead of 'categories'"),y?.subcategories&&globalThis.logger.warn("Token Action HUD | SystemManager.doRegisterDefaultFlags expects 'groups' to be returned instead of 'subcategories'"),game.tokenActionHud.defaults=y)}async getActionHandler(){const y=this.doGetActionHandler();return this.addActionExtenders(y),y}addActionExtenders(y){Utils.isModuleActive("itemacro")&&!Utils.isModuleActive("midi-qol")&&y.addFurtherActionHandler(new ItemMacroActionListExtender(y))}getRollHandler(){let y=Utils.getSetting("rollHandler");"core"===y||Utils.isModuleActive(y)||(Logger.error(y,Utils.i18n("tokenActionHud.handlerNotFound")),y="core",Utils.setSetting("rollHandler",y));const A=this.doGetRollHandler(y);return this.addPreHandlers(A),A}addPreHandlers(y){y.addPreRollHandler(new CompendiumMacroPreHandler),Utils.isModuleActive("itemacro")&&!Utils.isModuleActive("midi-qol")&&y.addPreRollHandler(new ItemMacroPreRollHandler)}registerSettings(){const y=this.getAvailableRollHandlers();registerSettings(this,y)}static addHandler(y,A){if(Utils.isModuleActive(A)){const w=Utils.getModuleTitle(A);mergeObject(y,{[A]:w})}}addActionsToActionList(y,A){globalThis.logger.warn("Token Action HUD | ActionHandler.addActionsToActionList is deprecated. Use ActionHandler.addActions"),this.addActions(y,A)}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function getDefaultExportFromCjs(y){return y&&y.__esModule&&Object.prototype.hasOwnProperty.call(y,"default")?y.default:y}var P={exports:{}};!function(y,A){var w,k;w=function(){var y,A=0,w={},k={},H=(y=window.MutationObserver||window.WebKitMutationObserver,function(A,w){A&&1===A.nodeType&&(y?new y((function(y,A){w(y)})).observe(A,{childList:!0,subtree:!1}):window.addEventListener&&A.addEventListener("DOMNodeInserted",w,!1))});function a(y,A){if(!y)return this;A=A||{},this.parentElm=y,this.uid=A.uid,this.settings={selector:"*",callbacks:{}},Object.assign(this.settings,A),this.setup(),H(this.parentElm,this.setup.bind(this)),this.bindEvents()}return a.prototype={namespace:"dragsort",setup(){[...this.parentElm.childNodes].forEach((y=>{if(1!=y.nodeType)return y.parentNode.removeChild(y);y.matches(this.settings.selector)&&(y.draggable=!0)})),this.gap=this.getItemsGap(this.parentElm.firstElementChild)},throttle(y,A){var w=!1,k=this;return function(H){w||(y.call(k,H),w=!0,setTimeout((()=>w=!1),A))}},getDraggableElm(y){if(!y.closest)return null;var A=y.closest('[draggable="true"]');return this.uid==w.uid?A:null},dragstart(y,A){w=this;var k,H=this.getDraggableElm(A);H?(this.source=this.getInitialState(),this.target=this.getInitialState(),k=H.getBoundingClientRect(),this.source.elm=H,this.source.idx=this.getNodeIndex(H),this.source.size.width=k.width,this.source.size.height=k.height,y.dataTransfer.effectAllowed="move",this.settings.callbacks.dragStart&&this.settings.callbacks.dragStart(this.source.elm,y),setTimeout(this.afterDragStart.bind(this))):w={}},afterDragStart(){var y="vertical"==this.settings.mode?"height":"width";this.parentElm.classList.add(`${this.namespace}--dragStart`),this.source.elm.style[y]=this.source.size[y]+"px",this.source.elm.classList.add(`${this.namespace}--dragElem`)},dragover(y){y.preventDefault(),y.stopPropagation();var A=y.target;if((A=this.getDraggableElm(A))&&this.target){var w=this.target.elm,k=this.target.hoverDirection;y.dataTransfer.dropEffect="move",this.target.hoverDirection=this.getTargetDirection(y),w==A&&k==this.target.hoverDirection||this.directionAwareDragEnter(y,A)}},dragenter(y,A){(A=this.getDraggableElm(A))&&this.target&&this.isValidElm(A)&&this.source.elm!=A&&this.source.elm&&(this.target.bounding=A.getBoundingClientRect())},directionAwareDragEnter(y,A){var w;y.preventDefault(),y.stopPropagation(),y.dataTransfer.dropEffect="none",this.isValidElm(A)&&this.source.elm!=A&&this.source.elm&&(y.dataTransfer.dropEffect="move",this.cleanupLastTarget(),this.target.elm=A,this.target.idx=this.getNodeIndex(A),A.classList.add("over"),w=Math.abs(this.target.idx-this.source.idx),this.source.elm.classList.toggle(`${this.namespace}--hide`,w>0),"vertical"==this.settings.mode?this.target.elm.style[this.target.hoverDirection?"marginBottom":"marginTop"]=this.source.size.height+this.gap+"px":this.target.elm.style[this.target.hoverDirection?"marginRight":"marginLeft"]=this.source.size.width+this.gap+"px")},dragend(y){if(clearTimeout(this.dragoverTimeout),this.dragoverTimeout=null,this.parentElm.classList.remove(`${this.namespace}--dragStart`),!this.isValidElm(this.target.elm))return this.cleanup();var A=this.target.hoverDirection?this.target.elm.nextElementSibling:this.target.elm;return this.source.elm!=this.target.elm&&this.target.elm&&(this.target.elm.classList.add(`${this.namespace}--noAnim`),this.cleanup(),this.parentElm.insertBefore(this.source.elm,A)),this.source.elm&&this.source.elm.classList.remove(`${this.namespace}--dragElem`,`${this.namespace}--hide`),this.settings.callbacks.dragEnd&&this.settings.callbacks.dragEnd(this.source.elm),this},isTargetLastChild(){return this.parentElm.lastElementChild==this.target.elm},getTargetDirection(y){if(this.target.bounding)return"vertical"==this.settings.mode?y.pageY>this.target.bounding.top+this.target.bounding.height/2?1:0:y.pageX>this.target.bounding.left+this.target.bounding.width/2?1:0},getNodeIndex(y){for(var A=0;y=y.previousSibling;)3==y.nodeType&&/^\s*$/.test(y.data)||A++;return A},isValidElm(y){return y&&y.nodeType&&y.parentNode==this.parentElm},cleanup(){w={},[...this.parentElm.children].forEach((y=>{y.removeAttribute("style"),setTimeout((()=>{y.classList.remove(`${this.namespace}--over`,`${this.namespace}--noAnim`,`${this.namespace}--dragElem`)}),50)}))},cleanupLastTarget(){this.target.elm&&(this.target.elm.classList.remove(`${this.namespace}--hide`,`${this.namespace}--over`),this.target.elm.removeAttribute("style"))},getInitialState:()=>({elm:null,size:{}}),getItemsGap(y){var A=getComputedStyle(y),w=getComputedStyle(y.parentNode),k="vertical"==this.settings.mode,H=parseInt(w.gap)||0;return parseInt(A["margin"+(k?"Top":"Left")])+parseInt(A["margin"+(k?"Bottom":"Right")])+H},bindEvents(y){for(var A in this.listeners=this.listeners||{dragstart:y=>this.dragstart(y,y.target),dragenter:y=>this.dragenter(y,y.target),dragend:y=>this.dragend(y,y.target),dragover:this.throttle(this.dragover,350)},this.listeners)this.parentElm[y?"removeEventListener":"addEventListener"](A,this.listeners[A])},destroy(){this.cleanup(),this.bindEvents(!0),delete k[this.uid]}},function(y,w){return k[++A]=y.DragSort?k[y.DragSort]:new a(y,{...w,uid:A}),y.DragSort=A,k[A]}},"function"==typeof(k=k||{})&&k.amd?k([],w):y.exports=w()}(P);const F=getDefaultExportFromCjs(P.exports);var B={exports:{}};const _=getDefaultExportFromCjs(B.exports=function(){function t(y,A){var w=Object.keys(y);if(Object.getOwnPropertySymbols){var k=Object.getOwnPropertySymbols(y);A&&(k=k.filter((function(A){return Object.getOwnPropertyDescriptor(y,A).enumerable}))),w.push.apply(w,k)}return w}function e(y){for(var A=1;A<arguments.length;A++){var w=null!=arguments[A]?arguments[A]:{};A%2?t(Object(w),!0).forEach((function(A){i(y,A,w[A])})):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(w)):t(Object(w)).forEach((function(A){Object.defineProperty(y,A,Object.getOwnPropertyDescriptor(w,A))}))}return y}function i(y,A,w){return(A=function(y){var A=function(y,A){if("object"!=typeof y||null===y)return y;var w=y[Symbol.toPrimitive];if(void 0!==w){var k=w.call(y,A||"default");if("object"!=typeof k)return k;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===A?String:Number)(y)}(y,"string");return"symbol"==typeof A?A:String(A)}(A))in y?Object.defineProperty(y,A,{value:w,enumerable:!0,configurable:!0,writable:!0}):y[A]=w,y}const s=(y,A,w,k)=>(y=""+y,A=""+A,k&&(y=y.trim(),A=A.trim()),w?y==A:y.toLowerCase()==A.toLowerCase()),a=(y,A)=>y&&Array.isArray(y)&&y.map((y=>n(y,A)));function n(y,A){var w,k={};for(w in y)A.indexOf(w)<0&&(k[w]=y[w]);return k}function o(y){var A=document.createElement("div");return y.replace(/\&#?[0-9a-z]+;/gi,(function(y){return A.innerHTML=y,A.innerText}))}function r(y){return(new DOMParser).parseFromString(y.trim(),"text/html").body.firstElementChild}function l(y,A){for(A=A||"previous";y=y[A+"Sibling"];)if(3==y.nodeType)return y}function d(y){return"string"==typeof y?y.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/`|'/g,"&#039;"):y}function h(y){var A=Object.prototype.toString.call(y).split(" ")[1].slice(0,-1);return y===Object(y)&&"Array"!=A&&"Function"!=A&&"RegExp"!=A&&"HTMLUnknownElement"!=A}function g(y,A,w){function s(y,A){for(var w in A)if(A.hasOwnProperty(w)){if(h(A[w])){h(y[w])?s(y[w],A[w]):y[w]=Object.assign({},A[w]);continue}if(Array.isArray(A[w])){y[w]=Object.assign([],A[w]);continue}y[w]=A[w]}}return y instanceof Object||(y={}),s(y,A),w&&s(y,w),y}function p(){const y=[],A={};for(let w of arguments)for(let k of w)h(k)?A[k.value]||(y.push(k),A[k.value]=1):y.includes(k)||y.push(k);return y}function c(y){return String.prototype.normalize?"string"==typeof y?y.normalize("NFD").replace(/[\u0300-\u036f]/g,""):void 0:y}var u=()=>/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent);function m(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(y=>(y^crypto.getRandomValues(new Uint8Array(1))[0]&15>>y/4).toString(16)))}function v(y){return y&&y.classList&&y.classList.contains(this.settings.classNames.tag)}function f(y,A){var w=window.getSelection();return A=A||w.getRangeAt(0),"string"==typeof y&&(y=document.createTextNode(y)),A&&(A.deleteContents(),A.insertNode(y)),y}function T(y,A,w){return y?(A&&(y.__tagifyTagData=w?A:g({},y.__tagifyTagData||{},A)),y.__tagifyTagData):(console.warn("tag element doesn't exist",y,A),A)}var y={delimiters:",",pattern:null,tagTextProp:"value",maxTags:1/0,callbacks:{},addTagOnBlur:!0,onChangeAfterBlur:!0,duplicates:!1,whitelist:[],blacklist:[],enforceWhitelist:!1,userInput:!0,keepInvalidTags:!1,createInvalidTags:!0,mixTagsAllowedAfter:/,|\.|\:|\s/,mixTagsInterpolator:["[[","]]"],backspace:!0,skipInvalid:!1,pasteAsTags:!0,editTags:{clicks:2,keepInvalid:!0},transformTag:()=>{},trim:!0,a11y:{focusableTags:!1},mixMode:{insertAfterTag:""},autoComplete:{enabled:!0,rightKey:!1},classNames:{namespace:"tagify",mixMode:"tagify--mix",selectMode:"tagify--select",input:"tagify__input",focus:"tagify--focus",tagNoAnimation:"tagify--noAnim",tagInvalid:"tagify--invalid",tagNotAllowed:"tagify--notAllowed",scopeLoading:"tagify--loading",hasMaxTags:"tagify--hasMaxTags",hasNoTags:"tagify--noTags",empty:"tagify--empty",inputInvalid:"tagify__input--invalid",dropdown:"tagify__dropdown",dropdownWrapper:"tagify__dropdown__wrapper",dropdownHeader:"tagify__dropdown__header",dropdownFooter:"tagify__dropdown__footer",dropdownItem:"tagify__dropdown__item",dropdownItemActive:"tagify__dropdown__item--active",dropdownItemHidden:"tagify__dropdown__item--hidden",dropdownInital:"tagify__dropdown--initial",tag:"tagify__tag",tagText:"tagify__tag-text",tagX:"tagify__tag__removeBtn",tagLoading:"tagify__tag--loading",tagEditing:"tagify__tag--editable",tagFlash:"tagify__tag--flash",tagHide:"tagify__tag--hide"},dropdown:{classname:"",enabled:2,maxItems:10,searchKeys:["value","searchBy"],fuzzySearch:!0,caseSensitive:!1,accentedSearch:!0,includeSelectedTags:!1,highlightFirst:!1,closeOnSelect:!0,clearOnSelect:!0,position:"all",appendTarget:null},hooks:{beforeRemoveTag:()=>Promise.resolve(),beforePaste:()=>Promise.resolve(),suggestionClick:()=>Promise.resolve()}};function b(){this.dropdown={};for(let y in this._dropdown)this.dropdown[y]="function"==typeof this._dropdown[y]?this._dropdown[y].bind(this):this._dropdown[y];this.dropdown.refs()}var A={refs(){this.DOM.dropdown=this.parseTemplate("dropdown",[this.settings]),this.DOM.dropdown.content=this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-wrapper']")},getHeaderRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-header']")},getFooterRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-footer']")},getAllSuggestionsRefs(){return[...this.DOM.dropdown.content.querySelectorAll(this.settings.classNames.dropdownItemSelector)]},show(y){var A,w,k,H=this.settings,S="mix"==H.mode&&!H.enforceWhitelist,C=!H.whitelist||!H.whitelist.length,D="manual"==H.dropdown.position;if(y=void 0===y?this.state.inputText:y,!(C&&!S&&!H.templates.dropdownItemNoMatch||!1===H.dropdown.enable||this.state.isLoading||this.settings.readonly)){if(clearTimeout(this.dropdownHide__bindEventsTimeout),this.suggestedListItems=this.dropdown.filterListItems(y),y&&!this.suggestedListItems.length&&(this.trigger("dropdown:noMatch",y),H.templates.dropdownItemNoMatch&&(k=H.templates.dropdownItemNoMatch.call(this,{value:y}))),!k){if(this.suggestedListItems.length)y&&S&&!this.state.editing.scope&&!s(this.suggestedListItems[0].value,y)&&this.suggestedListItems.unshift({value:y});else{if(!y||!S||this.state.editing.scope)return this.input.autocomplete.suggest.call(this),void this.dropdown.hide();this.suggestedListItems=[{value:y}]}w=""+(h(A=this.suggestedListItems[0])?A.value:A),H.autoComplete&&w&&0==w.indexOf(y)&&this.input.autocomplete.suggest.call(this,A)}this.dropdown.fill(k),H.dropdown.highlightFirst&&this.dropdown.highlightOption(this.DOM.dropdown.content.querySelector(H.classNames.dropdownItemSelector)),this.state.dropdown.visible||setTimeout(this.dropdown.events.binding.bind(this)),this.state.dropdown.visible=y||!0,this.state.dropdown.query=y,this.setStateSelection(),D||setTimeout((()=>{this.dropdown.position(),this.dropdown.render()})),setTimeout((()=>{this.trigger("dropdown:show",this.DOM.dropdown)}))}},hide(y){var A=this.DOM,w=A.scope,k=A.dropdown,H="manual"==this.settings.dropdown.position&&!y;if(k&&document.body.contains(k)&&!H)return window.removeEventListener("resize",this.dropdown.position),this.dropdown.events.binding.call(this,!1),w.setAttribute("aria-expanded",!1),k.parentNode.removeChild(k),setTimeout((()=>{this.state.dropdown.visible=!1}),100),this.state.dropdown.query=this.state.ddItemData=this.state.ddItemElm=this.state.selection=null,this.state.tag&&this.state.tag.value.length&&(this.state.flaggedTags[this.state.tag.baseOffset]=this.state.tag),this.trigger("dropdown:hide",k),this},toggle(y){this.dropdown[this.state.dropdown.visible&&!y?"hide":"show"]()},render(){var y,A,w=((A=this.DOM.dropdown.cloneNode(!0)).style.cssText="position:fixed; top:-9999px; opacity:0",document.body.appendChild(A),y=A.clientHeight,A.parentNode.removeChild(A),y),k=this.settings;return"number"==typeof k.dropdown.enabled&&k.dropdown.enabled>=0?(this.DOM.scope.setAttribute("aria-expanded",!0),document.body.contains(this.DOM.dropdown)||(this.DOM.dropdown.classList.add(k.classNames.dropdownInital),this.dropdown.position(w),k.dropdown.appendTarget.appendChild(this.DOM.dropdown),setTimeout((()=>this.DOM.dropdown.classList.remove(k.classNames.dropdownInital)))),this):this},fill(y){y="string"==typeof y?y:this.dropdown.createListHTML(y||this.suggestedListItems);var A,w=this.settings.templates.dropdownContent.call(this,y);this.DOM.dropdown.content.innerHTML=(A=w)?A.replace(/\>[\r\n ]+\</g,"><").replace(/(<.*?>)|\s+/g,((y,A)=>A||" ")):""},fillHeaderFooter(){var y=this.dropdown.filterListItems(this.state.dropdown.query),A=this.parseTemplate("dropdownHeader",[y]),w=this.parseTemplate("dropdownFooter",[y]),k=this.dropdown.getHeaderRef(),H=this.dropdown.getFooterRef();A&&k?.parentNode.replaceChild(A,k),w&&H?.parentNode.replaceChild(w,H)},refilter(y){y=y||this.state.dropdown.query||"",this.suggestedListItems=this.dropdown.filterListItems(y),this.dropdown.fill(),this.suggestedListItems.length||this.dropdown.hide(),this.trigger("dropdown:updated",this.DOM.dropdown)},position(y){var A=this.settings.dropdown;if("manual"!=A.position){var w,k,H,S,C,D,I=this.DOM.dropdown,x=A.placeAbove,E=A.appendTarget===document.body,L=E?window.pageYOffset:A.appendTarget.scrollTop,M=document.fullscreenElement||document.webkitFullscreenElement||document.documentElement,U=M.clientHeight,O=Math.max(M.clientWidth||0,window.innerWidth||0)>480?A.position:"all",G=this.DOM["input"==O?"input":"scope"];if(y=y||I.clientHeight,this.state.dropdown.visible){if("text"==O?(H=(w=function(){const y=document.getSelection();if(y.rangeCount){const A=y.getRangeAt(0),w=A.startContainer,k=A.startOffset;let H,S;if(k>0)return S=document.createRange(),S.setStart(w,k-1),S.setEnd(w,k),H=S.getBoundingClientRect(),{left:H.right,top:H.top,bottom:H.bottom};if(w.getBoundingClientRect)return w.getBoundingClientRect()}return{left:-9999,top:-9999}}()).bottom,k=w.top,S=w.left,C="auto"):(D=function(y){for(var A=0,w=0;y&&y!=M;)A+=y.offsetLeft||0,w+=y.offsetTop||0,y=y.parentNode;return{left:A,top:w}}(A.appendTarget),k=(w=G.getBoundingClientRect()).top-D.top,H=w.bottom-1-D.top,S=w.left-D.left,C=w.width+"px"),!E){let y=function(){for(var y=0,w=A.appendTarget.parentNode;w;)y+=w.scrollTop||0,w=w.parentNode;return y}();k+=y,H+=y}k=Math.floor(k),H=Math.ceil(H),x=void 0===x?U-w.bottom<y:x,I.style.cssText="left:"+(S+window.pageXOffset)+"px; width:"+C+";"+(x?"top: "+(k+L)+"px":"top: "+(H+L)+"px"),I.setAttribute("placement",x?"top":"bottom"),I.setAttribute("position",O)}}},events:{binding(){let y=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var A=this.dropdown.events.callbacks,w=this.listeners.dropdown=this.listeners.dropdown||{position:this.dropdown.position.bind(this,null),onKeyDown:A.onKeyDown.bind(this),onMouseOver:A.onMouseOver.bind(this),onMouseLeave:A.onMouseLeave.bind(this),onClick:A.onClick.bind(this),onScroll:A.onScroll.bind(this)},k=y?"addEventListener":"removeEventListener";"manual"!=this.settings.dropdown.position&&(document[k]("scroll",w.position,!0),window[k]("resize",w.position),window[k]("keydown",w.onKeyDown)),this.DOM.dropdown[k]("mouseover",w.onMouseOver),this.DOM.dropdown[k]("mouseleave",w.onMouseLeave),this.DOM.dropdown[k]("mousedown",w.onClick),this.DOM.dropdown.content[k]("scroll",w.onScroll)},callbacks:{onKeyDown(y){if(this.state.hasFocus&&!this.state.composing){var A=this.DOM.dropdown.querySelector(this.settings.classNames.dropdownItemActiveSelector),w=this.dropdown.getSuggestionDataByNode(A);switch(y.key){case"ArrowDown":case"ArrowUp":case"Down":case"Up":y.preventDefault();var k=this.dropdown.getAllSuggestionsRefs(),H="ArrowUp"==y.key||"Up"==y.key;A&&(A=this.dropdown.getNextOrPrevOption(A,!H)),A&&A.matches(this.settings.classNames.dropdownItemSelector)||(A=k[H?k.length-1:0]),this.dropdown.highlightOption(A,!0);break;case"Escape":case"Esc":this.dropdown.hide();break;case"ArrowRight":if(this.state.actions.ArrowLeft)return;case"Tab":if("mix"!=this.settings.mode&&A&&!this.settings.autoComplete.rightKey&&!this.state.editing){y.preventDefault();var S=this.dropdown.getMappedValue(w);return this.input.autocomplete.set.call(this,S),!1}return!0;case"Enter":y.preventDefault(),this.settings.hooks.suggestionClick(y,{tagify:this,tagData:w,suggestionElm:A}).then((()=>{if(A)return this.dropdown.selectOption(A),A=this.dropdown.getNextOrPrevOption(A,!H),void this.dropdown.highlightOption(A);this.dropdown.hide(),"mix"!=this.settings.mode&&this.addTags(this.state.inputText.trim(),!0)})).catch((y=>y));break;case"Backspace":{if("mix"==this.settings.mode||this.state.editing.scope)return;const y=this.input.raw.call(this);""!=y&&8203!=y.charCodeAt(0)||(!0===this.settings.backspace?this.removeTags():"edit"==this.settings.backspace&&setTimeout(this.editTag.bind(this),0))}}}},onMouseOver(y){var A=y.target.closest(this.settings.classNames.dropdownItemSelector);A&&this.dropdown.highlightOption(A)},onMouseLeave(y){this.dropdown.highlightOption()},onClick(y){if(0==y.button&&y.target!=this.DOM.dropdown&&y.target!=this.DOM.dropdown.content){var A=y.target.closest(this.settings.classNames.dropdownItemSelector),w=this.dropdown.getSuggestionDataByNode(A);this.state.actions.selectOption=!0,setTimeout((()=>this.state.actions.selectOption=!1),50),this.settings.hooks.suggestionClick(y,{tagify:this,tagData:w,suggestionElm:A}).then((()=>{A?this.dropdown.selectOption(A,y):this.dropdown.hide()})).catch((y=>console.warn(y)))}},onScroll(y){var A=y.target,w=A.scrollTop/(A.scrollHeight-A.parentNode.clientHeight)*100;this.trigger("dropdown:scroll",{percentage:Math.round(w)})}}},getSuggestionDataByNode(y){var A=y&&y.getAttribute("value");return this.suggestedListItems.find((y=>y.value==A))||null},getNextOrPrevOption(y){let A=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var w=this.dropdown.getAllSuggestionsRefs(),k=w.findIndex((A=>A===y));return A?w[k+1]:w[k-1]},highlightOption(y,A){var w,k=this.settings.classNames.dropdownItemActive;if(this.state.ddItemElm&&(this.state.ddItemElm.classList.remove(k),this.state.ddItemElm.removeAttribute("aria-selected")),!y)return this.state.ddItemData=null,this.state.ddItemElm=null,void this.input.autocomplete.suggest.call(this);w=this.dropdown.getSuggestionDataByNode(y),this.state.ddItemData=w,this.state.ddItemElm=y,y.classList.add(k),y.setAttribute("aria-selected",!0),A&&(y.parentNode.scrollTop=y.clientHeight+y.offsetTop-y.parentNode.clientHeight),this.settings.autoComplete&&(this.input.autocomplete.suggest.call(this,w),this.dropdown.position())},selectOption(y,A){var w=this.settings.dropdown,k=w.clearOnSelect,H=w.closeOnSelect;if(!y)return this.addTags(this.state.inputText,!0),void(H&&this.dropdown.hide());A=A||{};var S=y.getAttribute("value"),C="noMatch"==S,D=this.suggestedListItems.find((y=>(y.value??y)==S));this.trigger("dropdown:select",{data:D,elm:y,event:A}),S&&(D||C)?(this.state.editing?this.onEditTagDone(null,g({__isValid:!0},this.normalizeTags([D])[0])):this["mix"==this.settings.mode?"addMixTags":"addTags"]([D||this.input.raw.call(this)],k),this.DOM.input.parentNode&&(setTimeout((()=>{this.DOM.input.focus(),this.toggleFocusClass(!0)})),H&&setTimeout(this.dropdown.hide.bind(this)),y.addEventListener("transitionend",(()=>{this.dropdown.fillHeaderFooter(),setTimeout((()=>y.remove()),100)}),{once:!0}),y.classList.add(this.settings.classNames.dropdownItemHidden))):H&&setTimeout(this.dropdown.hide.bind(this))},selectAll(y){this.suggestedListItems.length=0,this.dropdown.hide(),this.dropdown.filterListItems("");var A=this.dropdown.filterListItems("");return y||(A=this.state.dropdown.suggestions),this.addTags(A,!0),this},filterListItems(y,A){var w,k,H,S,C,D=this.settings,I=D.dropdown,x=(A=A||{},[]),E=[],L=D.whitelist,M=I.maxItems>=0?I.maxItems:1/0,U=I.searchKeys,O=0;if(!(y="select"==D.mode&&this.value.length&&this.value[0][D.tagTextProp]==y?"":y)||!U.length)return x=I.includeSelectedTags?L:L.filter((y=>!this.isTagDuplicate(h(y)?y.value:y))),this.state.dropdown.suggestions=x,x.slice(0,M);function f(y,A){return A.toLowerCase().split(" ").every((A=>y.includes(A.toLowerCase())))}for(C=I.caseSensitive?""+y:(""+y).toLowerCase();O<L.length;O++){let y,D;w=L[O]instanceof Object?L[O]:{value:L[O]};let M=Object.keys(w).some((y=>U.includes(y)))?U:["value"];I.fuzzySearch&&!A.exact?(H=M.reduce(((y,A)=>y+" "+(w[A]||"")),"").toLowerCase().trim(),I.accentedSearch&&(H=c(H),C=c(C)),y=0==H.indexOf(C),D=H===C,k=f(H,C)):(y=!0,k=M.some((y=>{var k=""+(w[y]||"");return I.accentedSearch&&(k=c(k),C=c(C)),I.caseSensitive||(k=k.toLowerCase()),D=k===C,A.exact?k===C:0==k.indexOf(C)}))),S=!I.includeSelectedTags&&this.isTagDuplicate(h(w)?w.value:w),k&&!S&&(D&&y?E.push(w):"startsWith"==I.sortby&&y?x.unshift(w):x.push(w))}return this.state.dropdown.suggestions=E.concat(x),"function"==typeof I.sortby?I.sortby(E.concat(x),C):E.concat(x).slice(0,M)},getMappedValue(y){var A=this.settings.dropdown.mapValueTo;return A?"function"==typeof A?A(y):y[A]||y.value:y.value},createListHTML(y){return g([],y).map(((y,A)=>{"string"!=typeof y&&"number"!=typeof y||(y={value:y});var w=this.dropdown.getMappedValue(y);return w="string"==typeof w?d(w):w,this.settings.templates.dropdownItem.apply(this,[e(e({},y),{},{mappedValue:w}),this])})).join("")}};const w="@yaireo/tagify/";var k,H={empty:"empty",exceed:"number of tags exceeded",pattern:"pattern mismatch",duplicate:"already exists",notAllowed:"not allowed"},S={wrapper:(y,A)=>`<tags class="${A.classNames.namespace} ${A.mode?`${A.classNames[A.mode+"Mode"]}`:""} ${y.className}"\n                    ${A.readonly?"readonly":""}\n                    ${A.disabled?"disabled":""}\n                    ${A.required?"required":""}\n                    ${"select"===A.mode?"spellcheck='false'":""}\n                    tabIndex="-1">\n            <span ${!A.readonly&&A.userInput?"contenteditable":""} tabIndex="0" data-placeholder="${A.placeholder||"&#8203;"}" aria-placeholder="${A.placeholder||""}"\n                class="${A.classNames.input}"\n                role="textbox"\n                aria-autocomplete="both"\n                aria-multiline="${"mix"==A.mode}"></span>\n                &#8203;\n        </tags>`,tag(y,A){let w=A.settings;return`<tag title="${y.title||y.value}"\n                    contenteditable='false'\n                    spellcheck='false'\n                    tabIndex="${w.a11y.focusableTags?0:-1}"\n                    class="${w.classNames.tag} ${y.class||""}"\n                    ${this.getAttributes(y)}>\n            <x title='' class="${w.classNames.tagX}" role='button' aria-label='remove tag'></x>\n            <div>\n                <span class="${w.classNames.tagText}">${y[w.tagTextProp]||y.value}</span>\n            </div>\n        </tag>`},dropdown(y){var A=y.dropdown,w="manual"==A.position,k=`${y.classNames.dropdown}`;return`<div class="${w?"":k} ${A.classname}" role="listbox" aria-labelledby="dropdown">\n                    <div data-selector='tagify-suggestions-wrapper' class="${y.classNames.dropdownWrapper}"></div>\n                </div>`},dropdownContent(y){var A=this.settings,w=this.state.dropdown.suggestions;return`\n            ${A.templates.dropdownHeader.call(this,w)}\n            ${y}\n            ${A.templates.dropdownFooter.call(this,w)}\n        `},dropdownItem(y){return`<div ${this.getAttributes(y)}\n                    class='${this.settings.classNames.dropdownItem} ${y.class?y.class:""}'\n                    tabindex="0"\n                    role="option">${y.mappedValue||y.value}</div>`},dropdownHeader(y){return`<header data-selector='tagify-suggestions-header' class="${this.settings.classNames.dropdownHeader}"></header>`},dropdownFooter(y){var A=y.length-this.settings.dropdown.maxItems;return A>0?`<footer data-selector='tagify-suggestions-footer' class="${this.settings.classNames.dropdownFooter}">\n                ${A} more items. Refine your search.\n            </footer>`:""},dropdownItemNoMatch:null},C={customBinding(){this.customEventsList.forEach((y=>{this.on(y,this.settings.callbacks[y])}))},binding(){let y=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var A,w=this.events.callbacks,k=y?"addEventListener":"removeEventListener";if(!this.state.mainEvents||!y){for(var H in this.state.mainEvents=y,y&&!this.listeners.main&&(this.events.bindGlobal.call(this),this.settings.isJQueryPlugin&&jQuery(this.DOM.originalInput).on("tagify.removeAllTags",this.removeAllTags.bind(this))),A=this.listeners.main=this.listeners.main||{focus:["input",w.onFocusBlur.bind(this)],keydown:["input",w.onKeydown.bind(this)],click:["scope",w.onClickScope.bind(this)],dblclick:["scope",w.onDoubleClickScope.bind(this)],paste:["input",w.onPaste.bind(this)],drop:["input",w.onDrop.bind(this)],compositionstart:["input",w.onCompositionStart.bind(this)],compositionend:["input",w.onCompositionEnd.bind(this)]})this.DOM[A[H][0]][k](H,A[H][1]);clearInterval(this.listeners.main.originalInputValueObserverInterval),this.listeners.main.originalInputValueObserverInterval=setInterval(w.observeOriginalInputValue.bind(this),500);var S=this.listeners.main.inputMutationObserver||new MutationObserver(w.onInputDOMChange.bind(this));S.disconnect(),"mix"==this.settings.mode&&S.observe(this.DOM.input,{childList:!0})}},bindGlobal(y){var A,w=this.events.callbacks,k=y?"removeEventListener":"addEventListener";if(this.listeners&&(y||!this.listeners.global))for(A of(this.listeners.global=this.listeners.global||[{type:this.isIE?"keydown":"input",target:this.DOM.input,cb:w[this.isIE?"onInputIE":"onInput"].bind(this)},{type:"keydown",target:window,cb:w.onWindowKeyDown.bind(this)},{type:"blur",target:this.DOM.input,cb:w.onFocusBlur.bind(this)},{type:"click",target:document,cb:w.onClickAnywhere.bind(this)}],this.listeners.global))A.target[k](A.type,A.cb)},unbindGlobal(){this.events.bindGlobal.call(this,!0)},callbacks:{onFocusBlur(y){var A=this.settings,w=y.target?this.trim(y.target.textContent):"",k=this.value?.[0]?.[A.tagTextProp],H=y.type,S=A.dropdown.enabled>=0,C={relatedTarget:y.relatedTarget},D=this.state.actions.selectOption&&(S||!A.dropdown.closeOnSelect),I=this.state.actions.addNew&&S,x=y.relatedTarget&&v.call(this,y.relatedTarget)&&this.DOM.scope.contains(y.relatedTarget);if("blur"==H){if(y.relatedTarget===this.DOM.scope)return this.dropdown.hide(),void this.DOM.input.focus();this.postUpdate(),A.onChangeAfterBlur&&this.triggerChangeEvent()}if(!D&&!I)if(this.state.hasFocus="focus"==H&&+new Date,this.toggleFocusClass(this.state.hasFocus),"mix"!=A.mode){if("focus"==H)return this.trigger("focus",C),void(0!==A.dropdown.enabled&&A.userInput||this.dropdown.show(this.value.length?"":void 0));"blur"==H&&(this.trigger("blur",C),this.loading(!1),"select"==A.mode&&(x&&(this.removeTags(),w=""),k===w&&(w="")),w&&!this.state.actions.selectOption&&A.addTagOnBlur&&this.addTags(w,!0)),this.DOM.input.removeAttribute("style"),this.dropdown.hide()}else"focus"==H?this.trigger("focus",C):"blur"==y.type&&(this.trigger("blur",C),this.loading(!1),this.dropdown.hide(),this.state.dropdown.visible=void 0,this.setStateSelection())},onCompositionStart(y){this.state.composing=!0},onCompositionEnd(y){this.state.composing=!1},onWindowKeyDown(y){var A,w=document.activeElement,k=v.call(this,w)&&this.DOM.scope.contains(document.activeElement),H=k&&w.hasAttribute("readonly");if(k&&!H)switch(A=w.nextElementSibling,y.key){case"Backspace":this.settings.readonly||(this.removeTags(w),(A||this.DOM.input).focus());break;case"Enter":setTimeout(this.editTag.bind(this),0,w)}},onKeydown(y){var A=this.settings;if(!this.state.composing&&A.userInput){"select"==A.mode&&A.enforceWhitelist&&this.value.length&&"Tab"!=y.key&&y.preventDefault();var w=this.trim(y.target.textContent);if(this.trigger("keydown",{event:y}),"mix"==A.mode){switch(y.key){case"Left":case"ArrowLeft":this.state.actions.ArrowLeft=!0;break;case"Delete":case"Backspace":if(this.state.editing)return;var H=document.getSelection(),S="Delete"==y.key&&H.anchorOffset==(H.anchorNode.length||0),C=H.anchorNode.previousSibling,D=1==H.anchorNode.nodeType||!H.anchorOffset&&C&&1==C.nodeType&&H.anchorNode.previousSibling;o(this.DOM.input.innerHTML);var I,x,E,L=this.getTagElms();if("edit"==A.backspace&&D)return I=1==H.anchorNode.nodeType?null:H.anchorNode.previousElementSibling,setTimeout(this.editTag.bind(this),0,I),void y.preventDefault();if(u()&&D instanceof Element)return E=l(D),D.hasAttribute("readonly")||D.remove(),this.DOM.input.focus(),void setTimeout((()=>{this.placeCaretAfterNode(E),this.DOM.input.click()}));if("BR"==H.anchorNode.nodeName)return;if((S||D)&&1==H.anchorNode.nodeType?x=0==H.anchorOffset?S?L[0]:null:L[Math.min(L.length,H.anchorOffset)-1]:S?x=H.anchorNode.nextElementSibling:D instanceof Element&&(x=D),3==H.anchorNode.nodeType&&!H.anchorNode.nodeValue&&H.anchorNode.previousElementSibling&&y.preventDefault(),(D||S)&&!A.backspace)return void y.preventDefault();if("Range"!=H.type&&!H.anchorOffset&&H.anchorNode==this.DOM.input&&"Delete"!=y.key)return void y.preventDefault();if("Range"!=H.type&&x&&x.hasAttribute("readonly"))return void this.placeCaretAfterNode(l(x));clearTimeout(k),k=setTimeout((()=>{var y=document.getSelection();o(this.DOM.input.innerHTML),!S&&y.anchorNode.previousSibling,this.value=[].map.call(L,((y,A)=>{var w=T(y);if(y.parentNode||w.readonly)return w;this.trigger("remove",{tag:y,index:A,data:w})})).filter((y=>y))}),20)}return!0}switch(y.key){case"Backspace":"select"==A.mode&&A.enforceWhitelist&&this.value.length?this.removeTags():this.state.dropdown.visible&&"manual"!=A.dropdown.position||""!=y.target.textContent&&8203!=w.charCodeAt(0)||(!0===A.backspace?this.removeTags():"edit"==A.backspace&&setTimeout(this.editTag.bind(this),0));break;case"Esc":case"Escape":if(this.state.dropdown.visible)return;y.target.blur();break;case"Down":case"ArrowDown":this.state.dropdown.visible||this.dropdown.show();break;case"ArrowRight":{let y=this.state.inputSuggestion||this.state.ddItemData;if(y&&A.autoComplete.rightKey)return void this.addTags([y],!0);break}case"Tab":{let k="select"==A.mode;if(!w||k)return!0;y.preventDefault()}case"Enter":if(this.state.dropdown.visible&&"manual"!=A.dropdown.position)return;y.preventDefault(),setTimeout((()=>{this.state.dropdown.visible||this.state.actions.selectOption||this.addTags(w,!0)}))}}},onInput(y){this.postUpdate();var A=this.settings;if("mix"==A.mode)return this.events.callbacks.onMixTagsInput.call(this,y);var w=this.input.normalize.call(this),k=w.length>=A.dropdown.enabled,H={value:w,inputElm:this.DOM.input},S=this.validateTag({value:w});"select"==A.mode&&this.toggleScopeValidation(S),H.isValid=S,this.state.inputText!=w&&(this.input.set.call(this,w,!1),-1!=w.search(A.delimiters)?this.addTags(w)&&this.input.set.call(this):A.dropdown.enabled>=0&&this.dropdown[k?"show":"hide"](w),this.trigger("input",H))},onMixTagsInput(y){var A,w,k,H,S,C,D,I,x=this.settings,E=this.value.length,L=this.getTagElms(),M=document.createDocumentFragment(),U=window.getSelection().getRangeAt(0),O=[].map.call(L,(y=>T(y).value));if("deleteContentBackward"==y.inputType&&u()&&this.events.callbacks.onKeydown.call(this,{target:y.target,key:"Backspace"}),this.value.slice().forEach((y=>{y.readonly&&!O.includes(y.value)&&M.appendChild(this.createTagElem(y))})),M.childNodes.length&&(U.insertNode(M),this.setRangeAtStartEnd(!1,M.lastChild)),L.length!=E)return this.value=[].map.call(this.getTagElms(),(y=>T(y))),void this.update({withoutChangeEvent:!0});if(this.hasMaxTags())return!0;if(window.getSelection&&(C=window.getSelection()).rangeCount>0&&3==C.anchorNode.nodeType){if((U=C.getRangeAt(0).cloneRange()).collapse(!0),U.setStart(C.focusNode,0),k=(A=U.toString().slice(0,U.endOffset)).split(x.pattern).length-1,(w=A.match(x.pattern))&&(H=A.slice(A.lastIndexOf(w[w.length-1]))),H){if(this.state.actions.ArrowLeft=!1,this.state.tag={prefix:H.match(x.pattern)[0],value:H.replace(x.pattern,"")},this.state.tag.baseOffset=C.baseOffset-this.state.tag.value.length,I=this.state.tag.value.match(x.delimiters))return this.state.tag.value=this.state.tag.value.replace(x.delimiters,""),this.state.tag.delimiters=I[0],this.addTags(this.state.tag.value,x.dropdown.clearOnSelect),void this.dropdown.hide();S=this.state.tag.value.length>=x.dropdown.enabled;try{D=(D=this.state.flaggedTags[this.state.tag.baseOffset]).prefix==this.state.tag.prefix&&D.value[0]==this.state.tag.value[0],this.state.flaggedTags[this.state.tag.baseOffset]&&!this.state.tag.value&&delete this.state.flaggedTags[this.state.tag.baseOffset]}catch(y){}(D||k<this.state.mixMode.matchedPatternCount)&&(S=!1)}else this.state.flaggedTags={};this.state.mixMode.matchedPatternCount=k}setTimeout((()=>{this.update({withoutChangeEvent:!0}),this.trigger("input",g({},this.state.tag,{textContent:this.DOM.input.textContent})),this.state.tag&&this.dropdown[S?"show":"hide"](this.state.tag.value)}),10)},onInputIE(y){var A=this;setTimeout((function(){A.events.callbacks.onInput.call(A,y)}))},observeOriginalInputValue(){this.DOM.originalInput.parentNode||this.destroy(),this.DOM.originalInput.value!=this.DOM.originalInput.tagifyValue&&this.loadOriginalValues()},onClickAnywhere(y){y.target==this.DOM.scope||this.DOM.scope.contains(y.target)||(this.toggleFocusClass(!1),this.state.hasFocus=!1)},onClickScope(y){var A=this.settings,w=y.target.closest("."+A.classNames.tag),k=+new Date-this.state.hasFocus;if(y.target!=this.DOM.scope){if(!y.target.classList.contains(A.classNames.tagX))return w?(this.trigger("click",{tag:w,index:this.getNodeIndex(w),data:T(w),event:y}),void(1!==A.editTags&&1!==A.editTags.clicks||this.events.callbacks.onDoubleClickScope.call(this,y))):void(y.target==this.DOM.input&&("mix"==A.mode&&this.fixFirefoxLastTagNoCaret(),k>500)?this.state.dropdown.visible?this.dropdown.hide():0===A.dropdown.enabled&&"mix"!=A.mode&&this.dropdown.show(this.value.length?"":void 0):"select"!=A.mode||0!==A.dropdown.enabled||this.state.dropdown.visible||this.dropdown.show());this.removeTags(y.target.parentNode)}else this.DOM.input.focus()},onPaste(y){y.preventDefault();var A,w,k=this.settings;if("select"==k.mode&&k.enforceWhitelist||!k.userInput)return!1;k.readonly||(A=y.clipboardData||window.clipboardData,w=A.getData("Text"),k.hooks.beforePaste(y,{tagify:this,pastedText:w,clipboardData:A}).then((A=>{void 0===A&&(A=w),A&&(this.injectAtCaret(A,window.getSelection().getRangeAt(0)),"mix"==this.settings.mode?this.events.callbacks.onMixTagsInput.call(this,y):this.settings.pasteAsTags?this.addTags(this.state.inputText+A,!0):this.state.inputText=A)})).catch((y=>y)))},onDrop(y){y.preventDefault()},onEditTagInput(y,A){var w=y.closest("."+this.settings.classNames.tag),k=this.getNodeIndex(w),H=T(w),S=this.input.normalize.call(this,y),C={[this.settings.tagTextProp]:S,__tagId:H.__tagId},D=this.validateTag(C);this.editTagChangeDetected(g(H,C))||!0!==y.originalIsValid||(D=!0),w.classList.toggle(this.settings.classNames.tagInvalid,!0!==D),H.__isValid=D,w.title=!0===D?H.title||H.value:D,S.length>=this.settings.dropdown.enabled&&(this.state.editing&&(this.state.editing.value=S),this.dropdown.show(S)),this.trigger("edit:input",{tag:w,index:k,data:g({},this.value[k],{newValue:S}),event:A})},onEditTagPaste(y,A){var w=(A.clipboardData||window.clipboardData).getData("Text");A.preventDefault();var k=f(w);this.setRangeAtStartEnd(!1,k)},onEditTagFocus(y){this.state.editing={scope:y,input:y.querySelector("[contenteditable]")}},onEditTagBlur(y){if(this.state.hasFocus||this.toggleFocusClass(),this.DOM.scope.contains(y)){var A,w,k=this.settings,H=y.closest("."+k.classNames.tag),S=T(H),C=this.input.normalize.call(this,y),D={[k.tagTextProp]:C,__tagId:S.__tagId},I=S.__originalData,x=this.editTagChangeDetected(g(S,D)),E=this.validateTag(D);if(C)if(x){if(A=this.hasMaxTags(),w=g({},I,{[k.tagTextProp]:this.trim(C),__isValid:E}),k.transformTag.call(this,w,I),!0!==(E=(!A||!0===I.__isValid)&&this.validateTag(w))){if(this.trigger("invalid",{data:w,tag:H,message:E}),k.editTags.keepInvalid)return;k.keepInvalidTags?w.__isValid=E:w=I}else k.keepInvalidTags&&(delete w.title,delete w["aria-invalid"],delete w.class);this.onEditTagDone(H,w)}else this.onEditTagDone(H,I);else this.onEditTagDone(H)}},onEditTagkeydown(y,A){if(!this.state.composing)switch(this.trigger("edit:keydown",{event:y}),y.key){case"Esc":case"Escape":A.parentNode.replaceChild(A.__tagifyTagData.__originalHTML,A),this.state.editing=!1;case"Enter":case"Tab":y.preventDefault(),y.target.blur()}},onDoubleClickScope(y){var A,w,k=y.target.closest("."+this.settings.classNames.tag),H=T(k),S=this.settings;k&&S.userInput&&!1!==H.editable&&(A=k.classList.contains(this.settings.classNames.tagEditing),w=k.hasAttribute("readonly"),"select"==S.mode||S.readonly||A||w||!this.settings.editTags||this.editTag(k),this.toggleFocusClass(!0),this.trigger("dblclick",{tag:k,index:this.getNodeIndex(k),data:T(k)}))},onInputDOMChange(y){y.forEach((y=>{y.addedNodes.forEach((y=>{if("<div><br></div>"==y.outerHTML)y.replaceWith(document.createElement("br"));else if(1==y.nodeType&&y.querySelector(this.settings.classNames.tagSelector)){let A=document.createTextNode("");3==y.childNodes[0].nodeType&&"BR"!=y.previousSibling.nodeName&&(A=document.createTextNode("\n")),y.replaceWith(A,...[...y.childNodes].slice(0,-1)),this.placeCaretAfterNode(A)}else if(v.call(this,y)&&(3!=y.previousSibling?.nodeType||y.previousSibling.textContent||y.previousSibling.remove(),y.previousSibling&&"BR"==y.previousSibling.nodeName)){y.previousSibling.replaceWith("\n");let A=y.nextSibling,w="";for(;A;)w+=A.textContent,A=A.nextSibling;w.trim()&&this.placeCaretAfterNode(y.previousSibling)}})),y.removedNodes.forEach((y=>{y&&"BR"==y.nodeName&&v.call(this,A)&&(this.removeTags(A),this.fixFirefoxLastTagNoCaret())}))}));var A=this.DOM.input.lastChild;A&&""==A.nodeValue&&A.remove(),A&&"BR"==A.nodeName||this.DOM.input.appendChild(document.createElement("br"))}}};function N(y,A){if(!y){console.warn("Tagify:","input element not found",y);const A=new Proxy(this,{get:()=>()=>A});return A}if(y.__tagify)return console.warn("Tagify: ","input element is already Tagified - Same instance is returned.",y),y.__tagify;var k;g(this,function(y){var A=document.createTextNode("");function i(y,w,k){k&&w.split(/\s+/g).forEach((w=>A[y+"EventListener"].call(A,w,k)))}return{off(y,A){return i("remove",y,A),this},on(y,A){return A&&"function"==typeof A&&i("add",y,A),this},trigger(w,k,H){var S;if(H=H||{cloneData:!0},w)if(y.settings.isJQueryPlugin)"remove"==w&&(w="removeTag"),jQuery(y.DOM.originalInput).triggerHandler(w,[k]);else{try{var C="object"==typeof k?k:{value:k};if((C=H.cloneData?g({},C):C).tagify=this,k.event&&(C.event=this.cloneEvent(k.event)),k instanceof Object)for(var D in k)k[D]instanceof HTMLElement&&(C[D]=k[D]);S=new CustomEvent(w,{detail:C})}catch(y){console.warn(y)}A.dispatchEvent(S)}}}}(this)),this.isFirefox=/firefox|fxios/i.test(navigator.userAgent)&&!/seamonkey/i.test(navigator.userAgent),this.isIE=window.document.documentMode,A=A||{},this.getPersistedData=(k=A.id,y=>{let A,H="/"+y;if(1==localStorage.getItem(w+k+"/v",1))try{A=JSON.parse(localStorage[w+k+H])}catch(y){}return A}),this.setPersistedData=(y=>y?(localStorage.setItem(w+y+"/v",1),(A,k)=>{let H="/"+k,S=JSON.stringify(A);A&&k&&(localStorage.setItem(w+y+H,S),dispatchEvent(new Event("storage")))}):()=>{})(A.id),this.clearPersistedData=(y=>A=>{const k=w+"/"+y+"/";if(A)localStorage.removeItem(k+A);else for(let y in localStorage)y.includes(k)&&localStorage.removeItem(y)})(A.id),this.applySettings(y,A),this.state={inputText:"",editing:!1,composing:!1,actions:{},mixMode:{},dropdown:{},flaggedTags:{}},this.value=[],this.listeners={},this.DOM={},this.build(y),b.call(this),this.getCSSVars(),this.loadOriginalValues(),this.events.customBinding.call(this),this.events.binding.call(this),y.autofocus&&this.DOM.input.focus(),y.__tagify=this}return N.prototype={_dropdown:A,getSetTagData:T,helpers:{sameStr:s,removeCollectionProp:a,omit:n,isObject:h,parseHTML:r,escapeHTML:d,extend:g,concatWithoutDups:p,getUID:m,isNodeTag:v},customEventsList:["change","add","remove","invalid","input","click","keydown","focus","blur","edit:input","edit:beforeUpdate","edit:updated","edit:start","edit:keydown","dropdown:show","dropdown:hide","dropdown:select","dropdown:updated","dropdown:noMatch","dropdown:scroll"],dataProps:["__isValid","__removed","__originalData","__originalHTML","__tagId"],trim(y){return this.settings.trim&&y&&"string"==typeof y?y.trim():y},parseHTML:r,templates:S,parseTemplate(y,A){return r((y=this.settings.templates[y]||y).apply(this,A))},set whitelist(y){const A=y&&Array.isArray(y);this.settings.whitelist=A?y:[],this.setPersistedData(A?y:[],"whitelist")},get whitelist(){return this.settings.whitelist},generateClassSelectors(y){for(let A in y){let w=A;Object.defineProperty(y,w+"Selector",{get(){return"."+this[w].split(" ")[0]}})}},applySettings(A,w){y.templates=this.templates;var k=g({},y,"mix"==w.mode?{dropdown:{position:"text"}}:{}),S=this.settings=g({},k,w);if(S.disabled=A.hasAttribute("disabled"),S.readonly=S.readonly||A.hasAttribute("readonly"),S.placeholder=d(A.getAttribute("placeholder")||S.placeholder||""),S.required=A.hasAttribute("required"),this.generateClassSelectors(S.classNames),void 0===S.dropdown.includeSelectedTags&&(S.dropdown.includeSelectedTags=S.duplicates),this.isIE&&(S.autoComplete=!1),["whitelist","blacklist"].forEach((y=>{var w=A.getAttribute("data-"+y);w&&(w=w.split(S.delimiters))instanceof Array&&(S[y]=w)})),"autoComplete"in w&&!h(w.autoComplete)&&(S.autoComplete=y.autoComplete,S.autoComplete.enabled=w.autoComplete),"mix"==S.mode&&(S.pattern=S.pattern||/@/,S.autoComplete.rightKey=!0,S.delimiters=w.delimiters||null,S.tagTextProp&&!S.dropdown.searchKeys.includes(S.tagTextProp)&&S.dropdown.searchKeys.push(S.tagTextProp)),A.pattern)try{S.pattern=new RegExp(A.pattern)}catch(A){}if(S.delimiters){S._delimiters=S.delimiters;try{S.delimiters=new RegExp(this.settings.delimiters,"g")}catch(A){}}S.disabled&&(S.userInput=!1),this.TEXTS=e(e({},H),S.texts||{}),("select"!=S.mode||w.dropdown?.enabled)&&S.userInput||(S.dropdown.enabled=0),S.dropdown.appendTarget=w.dropdown?.appendTarget||document.body;let C=this.getPersistedData("whitelist");Array.isArray(C)&&(this.whitelist=Array.isArray(S.whitelist)?p(S.whitelist,C):C)},getAttributes(y){var A,w=this.getCustomAttributes(y),k="";for(A in w)k+=" "+A+(void 0!==y[A]?`="${w[A]}"`:"");return k},getCustomAttributes(y){if(!h(y))return"";var A,w={};for(A in y)"__"!=A.slice(0,2)&&"class"!=A&&y.hasOwnProperty(A)&&void 0!==y[A]&&(w[A]=d(y[A]));return w},setStateSelection(){var y=window.getSelection(),A={anchorOffset:y.anchorOffset,anchorNode:y.anchorNode,range:y.getRangeAt&&y.rangeCount&&y.getRangeAt(0)};return this.state.selection=A,A},getCSSVars(){var y,A=getComputedStyle(this.DOM.scope,null);this.CSSVars={tagHideTransition:(y=>{let A=y.value;return"s"==y.unit?1e3*A:A})(function(y){if(!y)return{};var A=(y=y.trim().split(" ")[0]).split(/\d+/g).filter((y=>y)).pop().trim();return{value:+y.split(A).filter((y=>y))[0].trim(),unit:A}}((y="tag-hide-transition",A.getPropertyValue("--"+y))))}},build(y){var A=this.DOM;this.settings.mixMode.integrated?(A.originalInput=null,A.scope=y,A.input=y):(A.originalInput=y,A.originalInput_tabIndex=y.tabIndex,A.scope=this.parseTemplate("wrapper",[y,this.settings]),A.input=A.scope.querySelector(this.settings.classNames.inputSelector),y.parentNode.insertBefore(A.scope,y),y.tabIndex=-1)},destroy(){this.events.unbindGlobal.call(this),this.DOM.scope.parentNode.removeChild(this.DOM.scope),this.DOM.originalInput.tabIndex=this.DOM.originalInput_tabIndex,delete this.DOM.originalInput.__tagify,this.dropdown.hide(!0),clearTimeout(this.dropdownHide__bindEventsTimeout),clearInterval(this.listeners.main.originalInputValueObserverInterval)},loadOriginalValues(y){var A,w=this.settings;if(this.state.blockChangeEvent=!0,void 0===y){const A=this.getPersistedData("value");y=A&&!this.DOM.originalInput.value?A:w.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value}if(this.removeAllTags(),y)if("mix"==w.mode)this.parseMixTags(y),(A=this.DOM.input.lastChild)&&"BR"==A.tagName||this.DOM.input.insertAdjacentHTML("beforeend","<br>");else{try{JSON.parse(y)instanceof Array&&(y=JSON.parse(y))}catch(y){}this.addTags(y,!0).forEach((y=>y&&y.classList.add(w.classNames.tagNoAnimation)))}else this.postUpdate();this.state.lastOriginalValueReported=w.mixMode.integrated?"":this.DOM.originalInput.value},cloneEvent(y){var A={};for(var w in y)"path"!=w&&(A[w]=y[w]);return A},loading(y){return this.state.isLoading=y,this.DOM.scope.classList[y?"add":"remove"](this.settings.classNames.scopeLoading),this},tagLoading(y,A){return y&&y.classList[A?"add":"remove"](this.settings.classNames.tagLoading),this},toggleClass(y,A){"string"==typeof y&&this.DOM.scope.classList.toggle(y,A)},toggleScopeValidation(y){var A=!0===y||void 0===y;!this.settings.required&&y&&y===this.TEXTS.empty&&(A=!0),this.toggleClass(this.settings.classNames.tagInvalid,!A),this.DOM.scope.title=A?"":y},toggleFocusClass(y){this.toggleClass(this.settings.classNames.focus,!!y)},triggerChangeEvent:function(){if(!this.settings.mixMode.integrated){var y=this.DOM.originalInput,A=this.state.lastOriginalValueReported!==y.value,w=new CustomEvent("change",{bubbles:!0});A&&(this.state.lastOriginalValueReported=y.value,w.simulated=!0,y._valueTracker&&y._valueTracker.setValue(Math.random()),y.dispatchEvent(w),this.trigger("change",this.state.lastOriginalValueReported),y.value=this.state.lastOriginalValueReported)}},events:C,fixFirefoxLastTagNoCaret(){},setRangeAtStartEnd(y,A){if(A){y="number"==typeof y?y:!!y,A=A.lastChild||A;var w=document.getSelection();if(w.focusNode instanceof Element&&!this.DOM.input.contains(w.focusNode))return!0;try{w.rangeCount>=1&&["Start","End"].forEach((k=>w.getRangeAt(0)["set"+k](A,y||A.length)))}catch(y){}}},placeCaretAfterNode(y){if(y&&y.parentNode){var A=y,w=window.getSelection(),k=w.getRangeAt(0);w.rangeCount&&(k.setStartAfter(A),k.collapse(!0),w.removeAllRanges(),w.addRange(k))}},insertAfterTag(y,A){if(A=A||this.settings.mixMode.insertAfterTag,y&&y.parentNode&&A)return A="string"==typeof A?document.createTextNode(A):A,y.parentNode.insertBefore(A,y.nextSibling),A},editTagChangeDetected(y){var A=y.__originalData;for(var w in A)if(!this.dataProps.includes(w)&&y[w]!=A[w])return!0;return!1},getTagTextNode(y){return y.querySelector(this.settings.classNames.tagTextSelector)},setTagTextNode(y,A){this.getTagTextNode(y).innerHTML=d(A)},editTag(y,A){y=y||this.getLastTag(),A=A||{},this.dropdown.hide();var w=this.settings,k=this.getTagTextNode(y),H=this.getNodeIndex(y),S=T(y),C=this.events.callbacks,D=this,I=!0;if(k){if(!(S instanceof Object&&"editable"in S)||S.editable)return S=T(y,{__originalData:g({},S),__originalHTML:y.cloneNode(!0)}),T(S.__originalHTML,S.__originalData),k.setAttribute("contenteditable",!0),y.classList.add(w.classNames.tagEditing),k.addEventListener("focus",C.onEditTagFocus.bind(this,y)),k.addEventListener("blur",(function(){setTimeout((()=>C.onEditTagBlur.call(D,D.getTagTextNode(y))))})),k.addEventListener("input",C.onEditTagInput.bind(this,k)),k.addEventListener("paste",C.onEditTagPaste.bind(this,k)),k.addEventListener("keydown",(A=>C.onEditTagkeydown.call(this,A,y))),k.addEventListener("compositionstart",C.onCompositionStart.bind(this)),k.addEventListener("compositionend",C.onCompositionEnd.bind(this)),A.skipValidation||(I=this.editTagToggleValidity(y)),k.originalIsValid=I,this.trigger("edit:start",{tag:y,index:H,data:S,isValid:I}),k.focus(),this.setRangeAtStartEnd(!1,k),this}else console.warn("Cannot find element in Tag template: .",w.classNames.tagTextSelector)},editTagToggleValidity(y,A){var w;if(A=A||T(y))return(w=!("__isValid"in A)||!0===A.__isValid)||this.removeTagsFromValue(y),this.update(),y.classList.toggle(this.settings.classNames.tagNotAllowed,!w),A.__isValid;console.warn("tag has no data: ",y,A)},onEditTagDone(y,A){A=A||{};var w={tag:y=y||this.state.editing.scope,index:this.getNodeIndex(y),previousData:T(y),data:A};this.trigger("edit:beforeUpdate",w,{cloneData:!1}),this.state.editing=!1,delete A.__originalData,delete A.__originalHTML,y&&A[this.settings.tagTextProp]?(y=this.replaceTag(y,A),this.editTagToggleValidity(y,A),this.settings.a11y.focusableTags?y.focus():this.placeCaretAfterNode(y)):y&&this.removeTags(y),this.trigger("edit:updated",w),this.dropdown.hide(),this.settings.keepInvalidTags&&this.reCheckInvalidTags()},replaceTag(y,A){A&&A.value||(A=y.__tagifyTagData),A.__isValid&&1!=A.__isValid&&g(A,this.getInvalidTagAttrs(A,A.__isValid));var w=this.createTagElem(A);return y.parentNode.replaceChild(w,y),this.updateValueByDOMTags(),w},updateValueByDOMTags(){this.value.length=0,[].forEach.call(this.getTagElms(),(y=>{y.classList.contains(this.settings.classNames.tagNotAllowed.split(" ")[0])||this.value.push(T(y))})),this.update()},injectAtCaret(y,A){return!(A=A||this.state.selection?.range)&&y?(this.appendMixTags(y),this):(f(y,A),this.setRangeAtStartEnd(!1,y),this.updateValueByDOMTags(),this.update(),this)},input:{set(){let y=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",A=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var w=this.settings.dropdown.closeOnSelect;this.state.inputText=y,A&&(this.DOM.input.innerHTML=d(""+y)),!y&&w&&this.dropdown.hide.bind(this),this.input.autocomplete.suggest.call(this),this.input.validate.call(this)},raw(){return this.DOM.input.textContent},validate(){var y=!this.state.inputText||!0===this.validateTag({value:this.state.inputText});return this.DOM.input.classList.toggle(this.settings.classNames.inputInvalid,!y),y},normalize(y){var A=y||this.DOM.input,w=[];A.childNodes.forEach((y=>3==y.nodeType&&w.push(y.nodeValue))),w=w.join("\n");try{w=w.replace(/(?:\r\n|\r|\n)/g,this.settings.delimiters.source.charAt(0))}catch(y){}return w=w.replace(/\s/g," "),this.trim(w)},autocomplete:{suggest(y){if(this.settings.autoComplete.enabled){"string"==typeof(y=y||{value:""})&&(y={value:y});var A=this.dropdown.getMappedValue(y);if("number"!=typeof A){var w=A.substr(0,this.state.inputText.length).toLowerCase(),k=A.substring(this.state.inputText.length);A&&this.state.inputText&&w==this.state.inputText.toLowerCase()?(this.DOM.input.setAttribute("data-suggest",k),this.state.inputSuggestion=y):(this.DOM.input.removeAttribute("data-suggest"),delete this.state.inputSuggestion)}}},set(y){var A=this.DOM.input.getAttribute("data-suggest"),w=y||(A?this.state.inputText+A:null);return!!w&&("mix"==this.settings.mode?this.replaceTextWithNode(document.createTextNode(this.state.tag.prefix+w)):(this.input.set.call(this,w),this.setRangeAtStartEnd(!1,this.DOM.input)),this.input.autocomplete.suggest.call(this),this.dropdown.hide(),!0)}}},getTagIdx(y){return this.value.findIndex((A=>A.__tagId==(y||{}).__tagId))},getNodeIndex(y){var A=0;if(y)for(;y=y.previousElementSibling;)A++;return A},getTagElms(){for(var y=arguments.length,A=new Array(y),w=0;w<y;w++)A[w]=arguments[w];var k="."+[...this.settings.classNames.tag.split(" "),...A].join(".");return[].slice.call(this.DOM.scope.querySelectorAll(k))},getLastTag(){var y=this.DOM.scope.querySelectorAll(`${this.settings.classNames.tagSelector}:not(.${this.settings.classNames.tagHide}):not([readonly])`);return y[y.length-1]},isTagDuplicate(y,A,w){var k=0;if("select"==this.settings.mode)return!1;for(let H of this.value)s(this.trim(""+y),H.value,A)&&w!=H.__tagId&&k++;return k},getTagIndexByValue(y){var A=[];return this.getTagElms().forEach(((w,k)=>{s(this.trim(w.textContent),y,this.settings.dropdown.caseSensitive)&&A.push(k)})),A},getTagElmByValue(y){var A=this.getTagIndexByValue(y)[0];return this.getTagElms()[A]},flashTag(y){y&&(y.classList.add(this.settings.classNames.tagFlash),setTimeout((()=>{y.classList.remove(this.settings.classNames.tagFlash)}),100))},isTagBlacklisted(y){return y=this.trim(y.toLowerCase()),this.settings.blacklist.filter((A=>(""+A).toLowerCase()==y)).length},isTagWhitelisted(y){return!!this.getWhitelistItem(y)},getWhitelistItem(y,A,w){A=A||"value";var k,H=this.settings;return(w=w||H.whitelist).some((w=>{var S="string"==typeof w?w:w[A]||w.value;if(s(S,y,H.dropdown.caseSensitive,H.trim))return k="string"==typeof w?{value:w}:w,!0})),k||"value"!=A||"value"==H.tagTextProp||(k=this.getWhitelistItem(y,H.tagTextProp,w)),k},validateTag(y){var A=this.settings,w="value"in y?"value":A.tagTextProp,k=this.trim(y[w]+"");return(y[w]+"").trim()?A.pattern&&A.pattern instanceof RegExp&&!A.pattern.test(k)?this.TEXTS.pattern:!A.duplicates&&this.isTagDuplicate(k,A.dropdown.caseSensitive,y.__tagId)?this.TEXTS.duplicate:this.isTagBlacklisted(k)||A.enforceWhitelist&&!this.isTagWhitelisted(k)?this.TEXTS.notAllowed:!A.validate||A.validate(y):this.TEXTS.empty},getInvalidTagAttrs(y,A){return{"aria-invalid":!0,class:`${y.class||""} ${this.settings.classNames.tagNotAllowed}`.trim(),title:A}},hasMaxTags(){return this.value.length>=this.settings.maxTags&&this.TEXTS.exceed},setReadonly(y,A){var w=this.settings;document.activeElement.blur(),w[A||"readonly"]=y,this.DOM.scope[(y?"set":"remove")+"Attribute"](A||"readonly",!0),this.setContentEditable(!y)},setContentEditable(y){this.settings.userInput&&(this.DOM.input.contentEditable=y,this.DOM.input.tabIndex=y?0:-1)},setDisabled(y){this.setReadonly(y,"disabled")},normalizeTags(y){var A=this.settings,w=A.whitelist,k=A.delimiters,H=A.mode,S=A.tagTextProp,C=[],D=!!w&&w[0]instanceof Object,I=Array.isArray(y),x=I&&y[0].value,h=y=>(y+"").split(k).filter((y=>y)).map((y=>({[S]:this.trim(y),value:this.trim(y)})));if("number"==typeof y&&(y=y.toString()),"string"==typeof y){if(!y.trim())return[];y=h(y)}else I&&(y=[].concat(...y.map((y=>null!=y.value?y:h(y)))));return D&&!x&&(y.forEach((y=>{var A=C.map((y=>y.value)),w=this.dropdown.filterListItems.call(this,y[S],{exact:!0});this.settings.duplicates||(w=w.filter((y=>!A.includes(y.value))));var k=w.length>1?this.getWhitelistItem(y[S],S,w):w[0];k&&k instanceof Object?C.push(k):"mix"!=H&&(null==y.value&&(y.value=y[S]),C.push(y))})),C.length&&(y=C)),y},parseMixTags(y){var A=this.settings,w=A.mixTagsInterpolator,k=A.duplicates,H=A.transformTag,S=A.enforceWhitelist,C=A.maxTags,D=A.tagTextProp,I=[];return y=y.split(w[0]).map(((y,A)=>{var x,E,L,M=y.split(w[1]),U=M[0],O=I.length==C;try{if(U==+U)throw Error;E=JSON.parse(U)}catch(y){E=this.normalizeTags(U)[0]||{value:U}}if(H.call(this,E),O||!(M.length>1)||S&&!this.isTagWhitelisted(E.value)||!k&&this.isTagDuplicate(E.value)){if(y)return A?w[0]+y:y}else E[x=E[D]?D:"value"]=this.trim(E[x]),L=this.createTagElem(E),I.push(E),L.classList.add(this.settings.classNames.tagNoAnimation),M[0]=L.outerHTML,this.value.push(E);return M.join("")})).join(""),this.DOM.input.innerHTML=y,this.DOM.input.appendChild(document.createTextNode("")),this.DOM.input.normalize(),this.getTagElms().forEach(((y,A)=>T(y,I[A]))),this.update({withoutChangeEvent:!0}),y},replaceTextWithNode(y,A){if(this.state.tag||A){A=A||this.state.tag.prefix+this.state.tag.value;var w,k,H=this.state.selection||window.getSelection(),S=H.anchorNode,C=this.state.tag.delimiters?this.state.tag.delimiters.length:0;return S.splitText(H.anchorOffset-C),-1==(w=S.nodeValue.lastIndexOf(A))||(k=S.splitText(w),y&&S.parentNode.replaceChild(y,k)),!0}},selectTag(y,A){var w=this.settings;if(!w.enforceWhitelist||this.isTagWhitelisted(A.value)){this.input.set.call(this,A[w.tagTextProp]||A.value,!0),this.state.actions.selectOption&&setTimeout((()=>this.setRangeAtStartEnd(!1,this.DOM.input)));var k=this.getLastTag();return k?this.replaceTag(k,A):this.appendTag(y),this.value[0]=A,this.update(),this.trigger("add",{tag:y,data:A}),[y]}},addEmptyTag(y){var A=g({value:""},y||{}),w=this.createTagElem(A);T(w,A),this.appendTag(w),this.editTag(w,{skipValidation:!0})},addTags(y,A,w){var k=[],H=this.settings,S=[],C=document.createDocumentFragment();if(w=w||H.skipInvalid,!y||0==y.length)return k;switch(y=this.normalizeTags(y),H.mode){case"mix":return this.addMixTags(y);case"select":A=!1,this.removeAllTags()}return this.DOM.input.removeAttribute("style"),y.forEach((y=>{var A,D={},I=Object.assign({},y,{value:y.value+""});if(y=Object.assign({},I),H.transformTag.call(this,y),y.__isValid=this.hasMaxTags()||this.validateTag(y),!0!==y.__isValid){if(w)return;if(g(D,this.getInvalidTagAttrs(y,y.__isValid),{__preInvalidData:I}),y.__isValid==this.TEXTS.duplicate&&this.flashTag(this.getTagElmByValue(y.value)),!H.createInvalidTags)return void S.push(y.value)}if("readonly"in y&&(y.readonly?D["aria-readonly"]=!0:delete y.readonly),A=this.createTagElem(y,D),k.push(A),"select"==H.mode)return this.selectTag(A,y);C.appendChild(A),y.__isValid&&!0===y.__isValid?(this.value.push(y),this.trigger("add",{tag:A,index:this.value.length-1,data:y})):(this.trigger("invalid",{data:y,index:this.value.length,tag:A,message:y.__isValid}),H.keepInvalidTags||setTimeout((()=>this.removeTags(A,!0)),1e3)),this.dropdown.position()})),this.appendTag(C),this.update(),y.length&&A&&(this.input.set.call(this,H.createInvalidTags?"":S.join(H._delimiters)),this.setRangeAtStartEnd(!1,this.DOM.input)),H.dropdown.enabled&&this.dropdown.refilter(),k},addMixTags(y){if((y=this.normalizeTags(y))[0].prefix||this.state.tag)return this.prefixedTextToTag(y[0]);var A=document.createDocumentFragment();return y.forEach((y=>{var w=this.createTagElem(y);A.appendChild(w)})),this.appendMixTags(A),A},appendMixTags(y){var A=!!this.state.selection;A?this.injectAtCaret(y):(this.DOM.input.focus(),(A=this.setStateSelection()).range.setStart(this.DOM.input,A.range.endOffset),A.range.setEnd(this.DOM.input,A.range.endOffset),this.DOM.input.appendChild(y),this.updateValueByDOMTags(),this.update())},prefixedTextToTag(y){var A,w=this.settings,k=this.state.tag.delimiters;if(w.transformTag.call(this,y),y.prefix=y.prefix||this.state.tag?this.state.tag.prefix:(w.pattern.source||w.pattern)[0],A=this.createTagElem(y),this.replaceTextWithNode(A)||this.DOM.input.appendChild(A),setTimeout((()=>A.classList.add(this.settings.classNames.tagNoAnimation)),300),this.value.push(y),this.update(),!k){var H=this.insertAfterTag(A)||A;setTimeout(this.placeCaretAfterNode,0,H)}return this.state.tag=null,this.trigger("add",g({},{tag:A},{data:y})),A},appendTag(y){var A=this.DOM,w=A.input;A.scope.insertBefore(y,w)},createTagElem(y,A){y.__tagId=m();var w,k=g({},y,e({value:d(y.value+"")},A));return function(y){for(var A,w=document.createNodeIterator(y,NodeFilter.SHOW_TEXT,null,!1);A=w.nextNode();)A.textContent.trim()||A.parentNode.removeChild(A)}(w=this.parseTemplate("tag",[k,this])),T(w,y),w},reCheckInvalidTags(){var y=this.settings;this.getTagElms(y.classNames.tagNotAllowed).forEach(((A,w)=>{var k=T(A),H=this.hasMaxTags(),S=this.validateTag(k),C=!0===S&&!H;if("select"==y.mode&&this.toggleScopeValidation(S),C)return k=k.__preInvalidData?k.__preInvalidData:{value:k.value},this.replaceTag(A,k);A.title=H||S}))},removeTags(y,A,w){var k,H=this.settings;if(y=y&&y instanceof HTMLElement?[y]:y instanceof Array?y:y?[y]:[this.getLastTag()],k=y.reduce(((y,A)=>{A&&"string"==typeof A&&(A=this.getTagElmByValue(A));var w=T(A);return A&&w&&!w.readonly&&y.push({node:A,idx:this.getTagIdx(w),data:T(A,{__removed:!0})}),y}),[]),w="number"==typeof w?w:this.CSSVars.tagHideTransition,"select"==H.mode&&(w=0,this.input.set.call(this)),1==k.length&&"select"!=H.mode&&k[0].node.classList.contains(H.classNames.tagNotAllowed)&&(A=!0),k.length)return H.hooks.beforeRemoveTag(k,{tagify:this}).then((()=>{function t(y){y.node.parentNode&&(y.node.parentNode.removeChild(y.node),A?H.keepInvalidTags&&this.trigger("remove",{tag:y.node,index:y.idx}):(this.trigger("remove",{tag:y.node,index:y.idx,data:y.data}),this.dropdown.refilter(),this.dropdown.position(),this.DOM.input.normalize(),H.keepInvalidTags&&this.reCheckInvalidTags()))}w&&w>10&&1==k.length?function(y){y.node.style.width=parseFloat(window.getComputedStyle(y.node).width)+"px",document.body.clientTop,y.node.classList.add(H.classNames.tagHide),setTimeout(t.bind(this),w,y)}.call(this,k[0]):k.forEach(t.bind(this)),A||(this.removeTagsFromValue(k.map((y=>y.node))),this.update(),"select"==H.mode&&this.setContentEditable(!0))})).catch((y=>{}))},removeTagsFromDOM(){[].slice.call(this.getTagElms()).forEach((y=>y.parentNode.removeChild(y)))},removeTagsFromValue(y){(y=Array.isArray(y)?y:[y]).forEach((y=>{var A=T(y),w=this.getTagIdx(A);w>-1&&this.value.splice(w,1)}))},removeAllTags(y){y=y||{},this.value=[],"mix"==this.settings.mode?this.DOM.input.innerHTML="":this.removeTagsFromDOM(),this.dropdown.refilter(),this.dropdown.position(),this.state.dropdown.visible&&setTimeout((()=>{this.DOM.input.focus()})),"select"==this.settings.mode&&(this.input.set.call(this),this.setContentEditable(!0)),this.update(y)},postUpdate(){this.state.blockChangeEvent=!1;var y=this.settings,A=y.classNames,w="mix"==y.mode?y.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value.trim():this.value.length+this.input.raw.call(this).length;this.toggleClass(A.hasMaxTags,this.value.length>=y.maxTags),this.toggleClass(A.hasNoTags,!this.value.length),this.toggleClass(A.empty,!w),"select"==y.mode&&this.toggleScopeValidation(this.value?.[0]?.__isValid)},setOriginalInputValue(y){var A=this.DOM.originalInput;this.settings.mixMode.integrated||(A.value=y,A.tagifyValue=A.value,this.setPersistedData(y,"value"))},update(y){clearTimeout(this.debouncedUpdateTimeout),this.debouncedUpdateTimeout=setTimeout(function(){var A=this.getInputValue();this.setOriginalInputValue(A),this.settings.onChangeAfterBlur&&(y||{}).withoutChangeEvent||this.state.blockChangeEvent||this.triggerChangeEvent(),this.postUpdate()}.bind(this),100)},getInputValue(){var y=this.getCleanValue();return"mix"==this.settings.mode?this.getMixedTagsAsString(y):y.length?this.settings.originalInputValueFormat?this.settings.originalInputValueFormat(y):JSON.stringify(y):""},getCleanValue(y){return a(y||this.value,this.dataProps)},getMixedTagsAsString(){var y="",A=this,w=this.settings,k=w.originalInputValueFormat||JSON.stringify,H=w.mixTagsInterpolator;return function i(w){w.childNodes.forEach((w=>{if(1==w.nodeType){const S=T(w);if("BR"==w.tagName&&(y+="\r\n"),S&&v.call(A,w)){if(S.__removed)return;y+=H[0]+k(n(S,A.dataProps))+H[1]}else w.getAttribute("style")||["B","I","U"].includes(w.tagName)?y+=w.textContent:"DIV"!=w.tagName&&"P"!=w.tagName||(y+="\r\n",i(w))}else y+=w.textContent}))}(this.DOM.input),y}},N.prototype.removeTag=N.prototype.removeTags,N}());class TagDialog extends FormApplication{tagify=null;dragSort=null;constructor(y){super(y,{title:y.title}),this.content=y.content,this.submit=y.submit,this.categoryId=null,this.subcategoryId=null}static get defaultOptions(){const y=super.defaultOptions;return foundry.utils.mergeObject(y,{classes:["tah-dialog","sheet"],closeOnSubmit:!0,id:"token-action-hud-dialog",popOut:!0,resizable:!0,height:"auto",width:600})}getData(y){return this.content}activateListeners(y){super.activateListeners(y);y.find("#tah-form-cancel").on("click",this.close.bind(this));y.find("#tah-dialog-reset-actions").on("click",this.#X)}static showDialog(y,A,w,k,H){this.nestId=A,TagDialog._prepareHook(w);const S={title:k.title,content:k.content,submit:H};let C;switch(y){case"hud":C=new TagDialogHud(S);break;case"topLevelGroup":C=new TagDialogTopLevelGroup(S);break;case"group":C=new TagDialogGroup(S)}C.render(!0)}static _prepareHook(y){Hooks.once("renderTagDialog",((A,w,k)=>{const H=w.find('input[class="tah-dialog-tagify"]');if(H.length>0){const S={delimiters:";",maxTags:"Infinity",dropdown:{position:"manual",maxItems:1/0,classname:"tah-dialog-tags-dropdown",enabled:0},templates:{dropdownItemNoMatch:()=>"<div class='empty'>Nothing Found</div>"}};function onDragEnd(y){TagDialog.tagify.updateValueByDOMTags()}y.available&&(S.whitelist=y.available),TagDialog.tagify=new _(H[0],S),y.selected&&TagDialog.tagify.addTags(y.selected),TagDialog.dragSort=new F(TagDialog.tagify.DOM.scope,{selector:"."+TagDialog.tagify.settings.classNames.tag,callbacks:{dragEnd:onDragEnd}}),w.find(".tagify__input").on("keydown",(y=>{"Enter"===y.key&&(y.preventDefault(),TagDialog.tagify.addTags(TagDialog.tagify.state.inputText,!0))}));if(w.find("#tah-dialog-unselect-all").on("click",TagDialog.tagify.removeAllTags.bind(TagDialog.tagify)),"TagDialogHud"===A.constructor.name)return;TagDialog.tagify.dropdown.show();const C=document.createElement("div");C.classList.add("tah-dialog-label"),C.innerHTML=Utils.i18n("tokenActionHud.form.hud.availableItems"),TagDialog.tagify.DOM.scope.parentNode.appendChild(C),TagDialog.tagify.DOM.scope.parentNode.appendChild(TagDialog.tagify.DOM.dropdown)}})),Hooks.on("renderApplication",((y,A,w)=>{y.constructor.name.startsWith("TagDialog")&&(y.setPosition(),y.setPosition({top:50}))}))}async#X(){new Dialog({title:Utils.i18n("tokenActionHud.dialog.resetActions.title"),content:`<p>${Utils.i18n("tokenActionHud.dialog.resetActions.content")}</p>`,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:Utils.i18n("tokenActionHud.dialog.button.yes"),callback:async()=>{await game.tokenActionHud.resetActorData(),Logger.info("Actions reset",!0)}},no:{icon:'<i class="fas fa-times"></i>',label:Utils.i18n("tokenActionHud.dialog.button.no")}}}).render(!0)}_onKeyDown(y){if("Escape"===y.key&&!y.target.className.includes("tagify"))return y.preventDefault(),y.stopPropagation(),this.close();if("Enter"===y.key&&this.data.default&&!y.target.className.includes("tagify")){y.preventDefault(),y.stopPropagation();const A=this.data.buttons[this.data.default];return this.submit(A)}}async _updateObject(y,A){const w=TagDialog.tagify.value.map((y=>(y.id=y.id??y.value.slugify({replacement:"-",strict:!0}),{id:y.id,listName:y.value,name:y.name??y.value,type:y.type})));await this.submit(w,A)}}class TagDialogHud extends TagDialog{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:w.tagDialogHud})}}class TagDialogTopLevelGroup extends TagDialog{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:w.tagDialogTopLevelGroup,tabs:[{navSelector:".tabs",contentSelector:"form",initial:"groups"}]})}}class TagDialogGroup extends TagDialog{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{template:w.tagDialogGroup,tabs:[{navSelector:".tabs",contentSelector:"form",initial:"groups"}]})}}class TagDialogHelper{static async showHudDialog(y){const A={available:[]};A.selected=await y.getSelectedGroups();const w=await Utils.getSetting("grid"),k={title:Utils.i18n("tokenActionHud.form.hud.hudTitle"),content:{topLabel:Utils.i18n("tokenActionHud.form.hud.hudDetail"),placeholder:Utils.i18n("tokenActionHud.form.hud.tagPlaceholder"),settings:{grid:w}}};TagDialog.showDialog("hud",null,A,k,(async(A,w)=>{const k=w?.grid;await y.updateGroups(A,{level:0}),await y.saveGroups({saveActor:!0,saveUser:!0}),await Utils.setSetting("grid",k),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showGroupDialog(y,A){const{nestId:w,name:k,level:H}=A,S={};S.available=await y.getAvailableGroups({nestId:w,level:H}),S.selected=await y.getSelectedGroups({nestId:w,level:H});const C={title:Utils.i18n("tokenActionHud.form.hud.groupTitle")+` (${k})`,content:{topLabel:Utils.i18n("tokenActionHud.form.hud.groupDetail"),placeholder:Utils.i18n("tokenActionHud.form.hud.tagPlaceholder"),settings:await y.getGroupSettings(A)}};TagDialog.showDialog("topLevelGroup",w,S,C,(async(w,k)=>{w=w.map((y=>(y.id=y.id??y.name.slugify({replacement:"-",strict:!0}),y.type=y.type??"custom",{id:y.id,listName:y.listName,name:y.name,type:y.type})));const H=k?.characterCount,S=k?.customWidth,C=k?.grid,D=k?.image,I=k?.showTitle,x=k?.sort;A.settings={characterCount:H,customWidth:S,grid:C,image:D,showTitle:I,sort:x},await y.updateGroups(w,A),await y.saveGroups({saveActor:!0,saveUser:!0}),Hooks.callAll("forceUpdateTokenActionHud")}))}static async showActionDialog(y,A){const{nestId:w,name:k,level:H}=A,S={},C=await y.getAvailableActions(A),D=await y.getAvailableGroups({nestId:w,level:H});S.available=[...C,...D];const I=await y.getSelectedActions(A),x=await y.getSelectedGroups({nestId:w,level:H});S.selected=[...I,...x];const E={title:`${Utils.i18n("tokenActionHud.form.hud.groupTitle")} (${k})`,content:{topLabel:Utils.i18n("tokenActionHud.form.hud.groupDetail"),placeholder:Utils.i18n("tokenActionHud.form.hud.tagPlaceholder"),settings:await y.getGroupSettings(A)}};TagDialog.showDialog("group",w,S,E,(async(w,k)=>{const H=[],S=[];for(const y of w)"action"===y.type?S.push(y):H.push(y);const C=k?.characterCount,D=k?.collapse,I=k?.grid,x=k?.image,E=k?.showTitle,L=k?.sort,M=k?.style;A.settings={characterCount:C,collapse:D,grid:I,image:x,showTitle:E,sort:L,style:M},await y.updateGroups(H,A),await y.updateActions(S,A),await y.saveGroups({saveActor:!0,saveUser:!0}),Hooks.callAll("forceUpdateTokenActionHud")}))}}class GroupResizer{direction=null;minCols=3;isCustomWidth=!1;settings=null;spacing=10;async resizeGroup(y,A,w,k){if(!A)return;if(this.#J(),this.groupElement=A,await this.#Y(),!this.groupsElement)return;if(this.actionsElements=this.groupElement.querySelectorAll(".tah-actions"),0===this.actionsElements.length)return;this.#Q(),this.direction=w;const H=this.groupElement.dataset.nestId;this.settings=await y.getGroupSettings({nestId:H,level:1}),this.availableWidth=this.#Z(),this.#tt();let S=!1;for(const A of this.groupElements){const w=A.querySelector(".tah-actions");if(!w)continue;const H=A.dataset.nestId,C=await y.getGroupSettings({nestId:H});k||this.settings?.grid||C?.grid?(S||(await this.#et(),S=!0),await this.#it(w)):await this.#st(w)}await this.#ot()}#J(){this.actionsElements=null,this.availableHeight=null,this.availableWidth=null,this.direction=null,this.gridWidth=null,this.groupElement=null,this.groupElements=null,this.groupsElement=null,this.groupsElementPadding=null,this.groupsElementRect=null,this.isCustomWidth=!1,this.minCols=3,this.settings=null,this.spacing=10}#Q(){const y=this.groupElement.closest('.tah-tab-group[data-level="1"]').querySelectorAll(".tah-groups");this.#nt(y,{maxHeight:"",overflowY:""})}async#et(){await this.#nt(this.actionsElements,{display:"",gridTemplateColumns:"",width:""});const y=[],A=[];for(const w of this.actionsElements){const k=w.querySelectorAll(".tah-action:not(.shrink)");for(const w of k){const k=w.getBoundingClientRect(),H=Math.round(parseFloat(k.width)+1||0),S=w.querySelector(".tah-action-button-text"),C=S?.getBoundingClientRect(),D=Math.round(parseFloat(C?.width)||0);A.push(H),y.push({actionWidth:H,actionButtonTextWidth:D})}}let w=Math.ceil(Utils.getUpperQuartileAverage(A));for(const A of y){const y=w-(A.actionWidth-A.actionButtonTextWidth);y<30&&(w=w-y+30)}this.gridWidth=w}async#it(y){if(!y)return;await this.#at(y,{display:"",gridTemplateColumns:"",width:""});const A=y.querySelectorAll(".tah-action"),w=Math.ceil(Math.sqrt(A.length)),k=Math.floor(this.availableWidth/this.gridWidth),H={display:"grid",gridTemplateColumns:`repeat(${w>k?k:A.length<=this.minCols?A.length:w}, ${this.gridWidth}px)`};await this.#at(y,H)}async#st(y){if(!y)return;let A=500;if(this.isCustomWidth)A=this.availableWidth;else{const w=y.querySelectorAll(".tah-action");if(!w.length)return;const k=Math.ceil(Math.sqrt(w.length));let H=1,S=0,C=0;w.length>0&&w.forEach(((y,A)=>{(A+1)/k>H&&(C-=5,S=C>S?C:S,C=0,H++);const D=y.getBoundingClientRect(),I=Math.ceil(parseFloat(D.width)+1||0);C+=I,A+1===w.length&&(C-=5,S=C>S?C:S)})),S+=this.groupsElementPadding,A=S<this.availableWidth&&w.length>3?S:this.availableWidth,A<200&&(A=200)}const w={maxWidth:`${A}px`};await this.#at(y,w)}#Z(){const y=this.settings?.customWidth;if(y)return this.isCustomWidth=!0,y;const A=canvas.screenDimensions[0],w=this.groupsElementRect.left,k=document.querySelector("#ui-right").clientWidth;return Math.floor((k>0?A-k:A)-this.spacing-w)}#rt(){const y=canvas.screenDimensions[1],A=this.groupsElementRect.bottom,w=this.groupsElementRect.top,k=("down"===this.direction?document.querySelector("#ui-bottom"):document.querySelector("#ui-top")).offsetHeight,H="down"===this.direction?y-w-k-this.spacing:A-k-this.spacing;return Math.floor(H<100?100:H)}async#Y(){this.groupsElement=this.groupElement.querySelector(".tah-groups"),this.groupsElement&&(this.groupsElementRect=this.groupsElement.getBoundingClientRect(),this.groupsElementComputed=getComputedStyle(this.groupsElement),this.groupsElementPadding=Math.ceil(parseFloat(this.groupsElementComputed.paddingLeft)||0)+Math.ceil(parseFloat(this.groupsElementComputed.paddingRight)||0))}#tt(){this.groupElements=this.groupElement.querySelectorAll(".tah-group"),0===this.groupElements.length&&(this.groupElements=[this.groupElement])}async#ot(){requestAnimationFrame((()=>{this.availableHeight=this.#rt();const y={maxHeight:`${this.availableHeight}px`,overflowY:"auto"};Object.assign(this.groupsElement.style,y)}))}async#at(y,A){y&&requestAnimationFrame((()=>{Object.assign(y.style,A)}))}async#nt(y,A){for(const w of y)Object.assign(w.style,A)}}class TokenActionHud extends Application{hoveredGroups=[];defaults={};defaultHeight=200;defaultWidth=20;defaultLeftPos=150;defaultTopPos=80;leftPos=this.defaultLeftPos;topPos=this.defaultTopPos;defaultScale=1;refreshTimeout=null;rendering=!1;tokens=null;isUpdatePending=!1;isUpdating=!1;updatePendingTimer=new Timer(10);updateTimer=new Timer(10);constructor(A,w){super(),this.module=y,this.systemManager=w,this.autoDirection="down",this.directionSetting="down",this.alwaysShowSetting=!1,this.clickOpenCategorySetting=!1,this.isCollapsed=!1,this.enableCustomizationSetting=!1,this.dragSetting="whenUnlocked",this.enableSetting=!1,this.isHudEnabled=!1,this.gridSetting=!1,this.isUnlocked=!1,this.styleSetting=null}async init(){this.activeCssAsTextSetting=Utils.getSetting("activeCssAsTextSetting"),this.allowSetting=Utils.getSetting("allow"),this.alwaysShowSetting=Utils.getSetting("alwaysShowHud"),this.clickOpenCategorySetting=Utils.getSetting("clickOpenCategory"),this.directionSetting=Utils.getSetting("direction"),this.debugSetting=Utils.getSetting("debug"),this.displayIconsSetting=Utils.getSetting("displayIcons"),this.dragSetting=Utils.getSetting("drag"),this.enableCustomizationSetting=Utils.getSetting("enableCustomization"),this.enableSetting=Utils.getSetting("enable"),this.gridSetting=Utils.getSetting("grid"),this.scaleSetting=Utils.getSetting("scale"),this.styleSetting=Utils.getSetting("style"),this.isCollapsed=Utils.getUserFlag("isCollapsed"),this.isHudEnabled=this.#lt(),this.hudPosition=Utils.getUserFlag("position"),this.isUnlocked=Utils.getUserFlag("isUnlocked"),await this.systemManager.registerDefaults(),this.dataHandler=new DataHandler,await this.dataHandler.init(),this.actionHandler=await this.systemManager.getActionHandler(),this.actionHandler.customLayoutSetting=Utils.getSetting("customLayout"),this.actionHandler.userCustomLayoutSetting=Utils.getSetting("userCustomLayout"),this.actionHandler.enableCustomizationSetting=this.enableCustomizationSetting,this.actionHandler.displayCharacterNameSetting=Utils.getSetting("displayCharacterName"),this.actionHandler.sortActionsSetting=Utils.getSetting("sortActions"),this.actionHandler.tooltipsSetting=Utils.getSetting("tooltips"),this.GroupResizer=new GroupResizer,this.rollHandler=this.systemManager.getRollHandler()}async updateSettings(y,A=null){this.updateSettingsPending||(this.updateSettingsPending=!0,Logger.debug("Updating settings..."));const w=G[y],k=w?.variable;switch(k&&(w.classes.includes("TokenActionHud")&&(this[k]=A),w.classes.includes("ActionHandler")&&(this.actionHandler[k]=A)),y){case"allow":case"enable":this.isHudEnabled=this.#lt();break;case"customLayout":case"userCustomLayout":this.actionHandler.customLayout=null;break;case"rollHandler":this.updateRollHandler()}}updateRollHandler(){this.rollHandler=this.systemManager.getRollHandler()}static get defaultOptions(){return mergeObject(super.defaultOptions,{template:w.hud,id:"token-action-hud",classes:[],width:this.defaultWidth,height:this.defaultHeight,left:this.defaultLeftPos,top:this.defaultTopPos,scale:this.defaultScale,background:"none",popOut:!1,minimizable:!1,resizable:!1,title:"token-action-hud",dragDrop:[],tabs:[],scrollY:[],zIndex:100})}#dt(){return"always"===this.dragSetting||"whenUnlocked"===this.dragSetting&&this.isUnlocked}#ct(){const y=parseFloat(this.scaleSetting);return y<.5?.5:y>2?2:y}getData(y={}){const A=super.getData();return A.hud=this.hud,A.id="token-action-hud",A.style=D[this.styleSetting].class,A.scale=this.#ct(),A.background="#00000000",Logger.debug("Application data",{data:A}),A}activateListeners(y){const A={action:y.find(".tah-action"),buttons:y.find("#tah-buttons"),tabGroup:y.find(".tah-tab-group"),groups:y.find("#tah-groups"),editHudButton:y.find("#tah-edit-hud"),listGroups:y.find(".tah-list-groups"),group:y.find(".tah-group"),subtitle:y.find(".tah-subtitle"),groupButton:y.find(".tah-group-button"),collapseHudButton:y.find("#tah-collapse-hud"),expandHudButton:y.find("#tah-expand-hud"),unlockButton:y.find("#tah-unlock"),lockButton:y.find("#tah-lock")};this.#gt(A),this.#ut(A),this.#ht(A),this.#pt(A),this.#mt(A)}postRender(){if(this.#ft(),this.hoveredGroups.length)for(const y of this.hoveredGroups){const A=document.querySelector(`#${y}`);this.GroupResizer.resizeGroup(this.actionHandler,A,this.autoDirection,this.gridSetting)}}#gt(y){const closeGroup=y=>{if(game.tokenActionHud.rendering)return;const A=this.clickOpenCategorySetting?y.currentTarget.parentElement:y.currentTarget;A.classList.remove("hover");const w=A.closest(".tah-group");let k=w?.nextElementSibling;for(;k;)k.classList.contains("tah-group")&&k.classList.remove("tah-hidden"),k=k.nextElementSibling;this.#yt(A.id)},openGroup=async y=>{const A=this.clickOpenCategorySetting?y.currentTarget.parentElement:y.currentTarget;A.classList.add("hover");const w=A.closest(".tah-group");let k=w?.nextElementSibling;for(;k;)k.classList.contains("tah-group")&&k.classList.add("tah-hidden"),k=k.nextElementSibling;this.GroupResizer.resizeGroup(this.actionHandler,A,this.autoDirection,this.gridSetting),this.#vt(A.id)},toggleGroup=y=>{const A=y.currentTarget.parentElement;if(A.classList.contains("hover"))closeGroup(y);else{const w=A.parentElement.querySelectorAll(".tah-tab-group");for(const y of w)y.classList.remove("hover"),this.#yt(y.id);openGroup(y)}y.currentTarget.blur()};y.groupButton.on("click",(y=>{this.bringToTop(),y.currentTarget.blur()})),this.clickOpenCategorySetting?y.groupButton.on("click",toggleGroup):(y.tabGroup.get().forEach((y=>{y.addEventListener("touchstart",toggleGroup,{passive:!0})})),y.tabGroup.hover(openGroup,closeGroup)),y.groupButton.on("mousedown",(y=>this.#bt(y))),y.groupButton.get().forEach((y=>{y.addEventListener("touchstart",(y=>this.#bt(y)),{passive:!0})}));const openGroupDialog=y=>{const A=y.currentTarget;if(!A?.parentElement?.dataset?.nestId)return;const w=A?.parentElement?.dataset?.nestId,k=A?.parentElement?.dataset?.name??A.innerText??A.outerText,H=parseInt(A?.parentElement?.dataset?.level)||null,S=A?.parentElement?.dataset?.type;TagDialogHelper.showGroupDialog(this.actionHandler,{nestId:w,name:k,level:H,type:S})};y.groupButton.on("contextmenu",(y=>{this.isUnlocked&&"1"===y.currentTarget.parentElement.dataset.level&&openGroupDialog(y)}))}#ut(y){const handleAction=y=>{let A=y.target;"BUTTON"!==A.tagName&&(A=y.currentTarget.children[0]);const w=A.value;try{this.rollHandler.handleActionEvent(y,w,this.actionHandler),A.blur()}catch(A){Logger.error(y)}},openActionDialog=y=>{const A=y.target.classList.contains("tah-button-text")||y.target.classList.contains("tah-button-image")||y.target.classList.contains("tah-group-button")?y.target.closest(".tah-tab-group"):y.target.closest(".tah-group");if(!A?.dataset?.nestId)return;const w=A?.dataset?.nestId,k=y.target.innerText??y.target.outerText,H=parseInt(A?.dataset?.level)||null,S=A?.dataset?.type;TagDialogHelper.showActionDialog(this.actionHandler,{nestId:w,name:k,level:H,type:S})},collapseExpandGroup=(y,A)=>{const w=y.target.classList.contains("tah-subtitle-text")?y.target.parentElement:y.target,k=w?.closest(".tah-group"),H=k?.dataset?.nestId,S=w.closest(".tah-tab-group.hover"),C=k?.querySelector(".tah-groups"),D=w.querySelector(".tah-collapse-icon"),I=w.querySelector(".tah-expand-icon"),x=k.querySelector(".tah-list-image"),toggleGroupVisibility=()=>{C?.classList.toggle("tah-hidden"),D?.classList.toggle("tah-hidden"),I?.classList.toggle("tah-hidden"),x?.classList.toggle("tah-hidden")},saveGroupSettings=y=>{A&&this.actionHandler.saveGroupSettings({nestId:H,settings:{collapse:y}})};C?.classList.contains("tah-hidden")?(toggleGroupVisibility(),saveGroupSettings(!1),this.GroupResizer.resizeGroup(this.actionHandler,S,this.autoDirection,this.gridSetting)):(toggleGroupVisibility(),saveGroupSettings(!0))};y.subtitle.on("contextmenu",(y=>{this.isUnlocked&&openActionDialog(y)})),y.subtitle.on("click",(y=>{y.target.classList.contains("tah-button-text")||collapseExpandGroup(y,this.enableCustomizationSetting)})),y.action.on("click contextmenu",(y=>{y.preventDefault(),handleAction(y)})),y.groupButton.on("contextmenu",(y=>{this.isUnlocked&&"1"!==y.currentTarget.parentElement.dataset.level&&openActionDialog(y)}))}#ht(y){y.editHudButton.on("click",(y=>{y.preventDefault(),y=y||window.event,TagDialogHelper.showHudDialog(this.actionHandler)}))}#pt(y){const unlockHud=async A=>{A&&A.preventDefault();const w=A?.target||y.unlockButton;$(w).addClass("tah-hidden"),y.editHudButton.removeClass("tah-hidden"),y.group.removeClass("tah-hidden"),y.groupButton.removeClass("disable-edit"),y.groups.addClass("tah-unlocked"),y.listGroups.removeClass("tah-hidden"),y.lockButton.removeClass("tah-hidden"),y.tabGroup.removeClass("tah-hidden"),y.subtitle.removeClass("disable-edit tah-hidden"),this.isUnlocked||(await Utils.setUserFlag("isUnlocked",!0),this.isUnlocked=!0)},lockHud=async(A=null)=>{A&&A.preventDefault();const w=A?.target||y.lockButton;$(w).addClass("tah-hidden"),y.unlockButton.removeClass("tah-hidden"),y.editHudButton.addClass("tah-hidden"),y.groups.removeClass("tah-unlocked");for(const A of y.tabGroup){A.getElementsByClassName("tah-action").length>0||A.classList.add("tah-hidden")}for(const A of y.group){A.getElementsByClassName("tah-action").length>0||A.classList.add("tah-hidden")}for(const A of y.listGroups){A.getElementsByClassName("tah-action").length>0||A.classList.add("tah-hidden")}for(const A of y.subtitle){const y=A.closest(".tah-group");"false"===y?.dataset?.showTitle&&A.classList.add("tah-hidden")}y.groupButton.addClass("disable-edit"),y.subtitle.addClass("disable-edit"),this.isUnlocked&&(await Utils.setUserFlag("isUnlocked",!1),this.isUnlocked=!1)};this.isUnlocked&&this.enableCustomizationSetting?unlockHud():lockHud(),this.enableCustomizationSetting||y.unlockButton.addClass("tah-hidden"),y.unlockButton.on("click",unlockHud),y.lockButton.on("click",lockHud)}#mt(y){const collapseHud=(A=null)=>{A&&(A.preventDefault(),A=A||window.event);const w=A?.target||y.collapseHudButton;$(w).addClass("tah-hidden"),y.expandHudButton.removeClass("tah-hidden"),y.groups.addClass("tah-hidden"),y.buttons.addClass("tah-hidden"),this.isCollapsed||(Utils.setUserFlag("isCollapsed",!0),this.isCollapsed=!0)};this.isCollapsed&&collapseHud(),y.collapseHudButton.on("click",collapseHud),y.expandHudButton.on("click",(A=>{A.preventDefault(),A=A||window.event,$(A.target).addClass("tah-hidden"),y.collapseHudButton.removeClass("tah-hidden"),y.groups.removeClass("tah-hidden"),y.buttons.removeClass("tah-hidden"),this.isCollapsed&&(Utils.setUserFlag("isCollapsed",!1),this.isCollapsed=!1)})),y.expandHudButton.on("mousedown",(y=>this.#bt(y))),y.expandHudButton.get(0).addEventListener("touchstart",(y=>this.#bt(y)),{passive:!0})}#bt(y){if(!this.#dt())return;const A=document.getElementById("token-action-hud"),w=y.clientX??y.changedTouches[0].clientX,k=y.clientY??y.changedTouches[0].clientY;let H=0,S=0,C=w,D=k;const I=A.offsetTop,x=A.offsetLeft;let E=I,L=x;const mouseMoveEvent=y=>{const w=y.clientX??y.changedTouches[0].clientX,k=y.clientY??y.changedTouches[0].clientY;H=C-w,S=D-k,C=w,D=k,H===C&&S===D||(E-=S,L-=H,this.topPos=E,requestAnimationFrame((()=>{Object.assign(A.style,{left:`${L}px`,position:"fixed",top:`${E}px`})})))},mouseUpEvent=()=>{document.onmousemove=null,A.ontouchmove=null,document.onmouseup=null,A.ontouchend=null,E===I&&L===x||(this.topPos=E,this.#ft(),this.hudPosition={top:E,left:L},Utils.setUserFlag("position",this.hudPosition),Logger.debug(`Set position to x: ${E}px, y: ${L}px`))};document.onmousemove=mouseMoveEvent,A.ontouchmove=mouseMoveEvent,document.onmouseup=mouseUpEvent,A.ontouchend=mouseUpEvent}#Tt(){return"up"===this.directionSetting||"auto"===this.directionSetting&&this.topPos>window.innerHeight/2?"up":"down"}#ft(){this.autoDirection=this.#Tt(),"up"===this.autoDirection?($(document).find(".tah-groups-container").removeClass("expand-down"),$(document).find(".tah-groups-container").addClass("expand-up"),$(document).find(".tah-groups-container").removeClass("expand-down"),$(document).find(".tah-groups-container").addClass("expand-up"),$(document).find("#tah-character-name").addClass("tah-hidden")):($(document).find(".tah-groups-container").addClass("expand-down"),$(document).find(".tah-groups-container").removeClass("expand-up"),$(document).find(".tah-groups-container").addClass("expand-down"),$(document).find(".tah-groups-container").removeClass("expand-up"),$(document).find("#tah-character-name").removeClass("tah-hidden"))}setPosition(){this.hud&&(this.#At(),this.#wt(),this.rendering=!1)}#At(){if(!this.hudPosition)return;const y=this.defaultLeftPos,A=this.defaultTopPos;return new Promise((w=>{const check=()=>{const k=document.getElementById("token-action-hud");k?(k.style.bottom=null,this.topPos=this.hudPosition.top<5||this.hudPosition.top>window.innerHeight+5?A:this.hudPosition.top,k.style.top=`${this.topPos}px`,this.leftPos=this.hudPosition.left<5||this.hudPosition.left>window.innerWidth+5?y:this.hudPosition.left,k.style.left=`${this.leftPos}px`,k.style.position="fixed",w()):setTimeout(check,10)};check()}))}async resetPosition(){Logger.debug("Resetting position..."),this.hudPosition={top:this.defaultTopPos,left:this.defaultLeftPos},await Utils.setUserFlag("position",this.hudPosition),Logger.debug(`Position reset to x: ${this.defaultTopPos}px, y: ${this.defaultLeftPos}px`)}#vt(y){this.hoveredGroups.length>10&&(this.hoveredGroups=[]),this.hoveredGroups.push(y)}#yt(y){this.hoveredGroups=this.hoveredGroups.filter((A=>A!==y))}#wt(){if(this.hoveredGroups.length)for(const y of this.hoveredGroups){const A=$(`#${y}`);if(A[0])if(this.clickOpenCategorySetting){A.find(".tah-group-button")[0].click()}else A.mouseenter()}}async toggleHud(){const y=Utils.humanizeBinding("toggleHud");this.enableSetting?(this.#kt(),this.enableSetting=!1,await Utils.setSetting("enable",!1),Logger.info(game.i18n.format("tokenActionHud.keybinding.toggleHud.disabled",{binding:y}),!0)):(this.enableSetting=!0,await Utils.setSetting("enable",!0),Logger.info(game.i18n.format("tokenActionHud.keybinding.toggleHud.enabled",{binding:y}),!0),Hooks.callAll("forceUpdateTokenActionHud"))}async copy(y,A){if(!game.user.isGM)return;await this.#Ht(y,A)?Logger.info("HUD copied",!0):Logger.info("Copy HUD failed",!0)}async#Ht(y,A){if(!y||!A.length)return!1;Logger.debug("Copying user data...");const w=await DataHandler.getDataAsGm({type:"user",id:y});if("string"==typeof A)await DataHandler.saveDataAsGm("user",A,w);else if(Array.isArray(A))for(const y of A)await DataHandler.saveDataAsGm("user",y,w);return Logger.debug("User data copied"),!0}async resetDialog(){new Dialog({title:Utils.i18n("tokenActionHud.dialog.resetLayout.title"),content:`<p>${Utils.i18n("tokenActionHud.dialog.resetLayout.content")}</p>`,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:Utils.i18n("tokenActionHud.dialog.button.yes"),callback:async()=>{const y=document.querySelector("#token-action-hud-core-settings input[name=customLayout]");y&&(await this.updateSettings("customLayout",y?.value??""),await Utils.setSetting("customLayout",y?.value??""));const A=document.querySelector("#token-action-hud-core-settings input[name=userCustomLayout]");A&&(await this.updateSettings("userCustomLayout",A?.value??""),await Utils.setSetting("userCustomLayout",y?.value??"")),await game.tokenActonHud.reset(),Logger.info("Layout reset",!0)}},no:{icon:'<i class="fas fa-times"></i>',label:Utils.i18n("tokenActionHud.dialog.button.no")}}}).render(!0)}async resetAllDialog(){new Dialog({title:Utils.i18n("tokenActionHud.dialog.resetAllLayouts.title"),content:`<p>${Utils.i18n("tokenActionHud.dialog.resetAllLayouts.content")}</p>`,buttons:{yes:{icon:'<i class="fas fa-check"></i>',label:Utils.i18n("tokenActionHud.dialog.button.yes"),callback:async()=>{const y=document.querySelector("#token-action-hud-core-settings input[name=customLayout]");y&&await Utils.setSetting("customLayout",y?.value??"");document.querySelector("#token-action-hud-core-settings input[name=userCustomLayout]")&&await Utils.setSetting("userCustomLayout",y?.value??""),await game.tokenActionHud.socket.executeForEveryone("reset"),Logger.info("All layouts reset",!0)}},no:{icon:'<i class="fas fa-times"></i>',label:Utils.i18n("tokenActionHud.dialog.button.no")}}}).render(!0)}static async reset(){Logger.debug("Resetting layout..."),await(game?.tokenActionHud?.resetUserAndActorData()),game?.tokenActionHud?.resetPosition(),Logger.debug("Layout reset")}async resetActorData(){Logger.debug("Resetting actor data..."),await DataHandler.saveDataAsGm("actor",this.actor.id,{}),this.actionHandler.hardResetActionHandler(),Logger.debug("Actor data reset");this.update({trigger:{type:"method",name:"TokenActionHud#resetActorData"}})}async resetAllActorData(){Logger.debug("Resetting all actor data...");for(const y of game.actors)Logger.debug(`Resetting flags for actor [${y.id}]`,{actor:y}),await DataHandler.saveDataAsGm("actor",y.id,{});this.actionHandler.hardResetActionHandler(),Logger.debug("All actor data reset");this.update({trigger:{type:"method",name:"TokenActionHud#resetAllActorData"}})}async resetUserData(){Logger.debug("Resetting user data..."),await DataHandler.saveDataAsGm("user",game.userId,{}),Logger.debug("User data reset"),this.actionHandler.hardResetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud#resetUserData"}})}async resetAllUserData(){Logger.debug("Resetting all user data...");for(const y of game.users)await DataHandler.saveDataAsGm("user",y.id,{});Logger.debug("All user data reset"),this.actionHandler.hardResetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud#resetAllUserData"}})}async resetUserAndActorData(){Logger.debug("Resetting user data..."),await DataHandler.saveDataAsGm("user",game.userId,{}),Logger.debug("User data reset"),Logger.debug("Resetting actor data..."),await DataHandler.saveDataAsGm("actor",this.actor.id,{}),Logger.debug("Actor data reset"),this.actionHandler.hardResetActionHandler();this.update({trigger:{type:"method",name:"TokenActionHud#resetUserAndActorData"}})}async update(y=null){if("closeSettingsConfig"===y?.name){if(!this.updateSettingsPending)return;this.updateSettingsPending=!1,Logger.debug("Settings updated")}await this.#St(),await this.#Ct(y)}async#St(){this.isUpdatePending&&this.updatePendingTimer.abort(),this.isUpdatePending=!0,await this.updatePendingTimer.start(),this.isUpdatePending=!1;const waitForUpdateCompletion=async()=>{let y=0;for(;y<500&&this.isUpdating;)await this.updateTimer.start(),y++;return!this.isUpdating};if(this.isUpdating){await waitForUpdateCompletion()||Logger.debug("Update took too long. Aborting...")}}async#Ct(y){this.isUpdating=!0,Logger.debug("Updating HUD...",y);const A=this.actor?.id,w=Utils.getControlledTokens(),k=this.#Dt(w),H=w.length>1&&!k;if(!k&&!H||!this.isHudEnabled)return this.#kt(),this.hoveredGroups=[],Logger.debug("HUD update aborted as no character(s) found or HUD is disabled"),void(this.isUpdating=!1);const S="controlToken"===y&&A!==this.actor?.id?{saveActor:!0}:{};if(this.hud=await this.actionHandler.buildHud(S),0===this.hud.length)return this.#kt(),this.hoveredGroups=[],Logger.debug("HUD update aborted as action list empty"),void(this.isUpdating=!1);this.rendering=!0,this.render(!0),ui.windows[this.appId]||(ui.windows[this.appId]=this),this.isUpdating=!1,Hooks.callAll("tokenActionHudCoreHudUpdated",this.module),Logger.debug("HUD updated")}#kt(){this.close()}isValidTokenChange(y,A=null){return!A?.actorData?.flags&&(this.alwaysShowSetting?this.#It(y)||y.actorId===game.user.character?.id:this.#It(y))}#It(y){const A=Utils.getControlledTokens();return A?.some((A=>A.id===y.id))||0===A?.length&&canvas?.tokens?.placeables?.some((y=>y.id===this.hud?.tokenId))}isSelectedActor(y){return!y?.id||y?.id===this.actor?.id}isValidActorOrItemUpdate(y,A){return!!this.isSelectedActor(y)&&(y?y?this.hud&&y.id===this.hud.actorId?(Logger.debug("Same actor, update hud",{actor:y,data:A}),!0):(Logger.debug("Different actor, do not update hud",{actor:y,data:A}),!1):(Logger.debug("No actor, update hud",{data:A}),!0):void 0)}#xt(y={}){const A=y?.actor;return game.user.isGM||A?.testUserPermission(game.user,"OWNER")}#lt(){const y=game.user.role,A=game.user.isGM;return!!this.enableSetting&&(!!A||Utils.checkAllow(y,this.allowSetting))}#Dt(y=[]){if(y.length>1)return this.actor=null,this.token=null,this.actionHandler.characterName="Multiple",this.actionHandler.actor=null,this.actionHandler.token=null,this.rollHandler.actor=null,this.rollHandler.token=null,null;const A={token:null,actor:null};if(1===y.length){const w=y[0],k=w.actor;if(!this.#xt(w))return null;A.token=w,A.actor=k}else 0===y.length&&game.user.character&&this.alwaysShowSetting&&(A.actor=game.user.character,A.token=canvas.tokens.placeables.find((y=>y.actor?.id===A.actor.id)));return A.actor?(this.actor=A.actor,this.token=A.token,this.actionHandler.characterName=A.token?.name??A.actor.name,this.actionHandler.actor=A.actor,this.actionHandler.token=A.token,this.rollHandler.actor=A.actor,this.rollHandler.token=A.token,A):null}}let R,V,j;function sendHudToBottom(){game.tokenActionHud?.element[0]&&(game.tokenActionHud.element[0].style.zIndex=0)}Hooks.once("socketlib.ready",(()=>{j=socketlib.registerModule(y.ID),j.register("getFilePaths",DataHandler.getFilePaths),j.register("getData",DataHandler.getData),j.register("saveData",DataHandler.saveData),j.register("reset",TokenActionHud.reset)})),Hooks.on("ready",(async()=>{V=game.modules.get(y.ID),V.api={ActionListExtender:ActionListExtender,ActionHandler:ActionHandler,DataHandler:DataHandler,Logger:Logger,PreRollHandler:PreRollHandler,RollHandler:RollHandler,SystemManager:SystemManager,Timer:Timer,Utils:Utils},Hooks.callAll("tokenActionHudCoreApiReady",V)})),Hooks.on("tokenActionHudSystemReady",(async A=>{if(!await Utils.checkModuleCompatibility(A.api.requiredCoreModuleVersion))return;const k=game.modules.get("socketlib");k&&k.active?(R=new A.api.SystemManager(y.ID),R.registerSettings(),Utils.switchCSS(Utils.getSetting("style")),Utils.registerHandlebars(),loadTemplates([w.action,w.customStyleForm,w.group,w.hud,w.listGroup,w.settings,w.tabGroup,w.tagDialogGroup,w.tagDialogHud,w.tagDialogTopLevelGroup]),Hooks.callAll("tokenActionHudCoreReady")):Logger.error("This module requires the 'socketlib' module to be installed and enabled.",!0)})),Hooks.on("tokenActionHudCoreReady",(async()=>{if(game.user.isGM&&!game.modules.get("color-picker")?.active){!1===Utils.getSetting("startup")&&(Logger.info("To enable color pickers in this module's settings, install the 'Color Picker' module.",!0),Utils.setSetting("startup",!0))}const y=Utils.getSetting("enableCustomization");game.user.isGM&&y&&await DataHandler.createDirectories();const A=new MigrationManager(j);function handleHookEvent(y,A){const w={type:"hook",name:A,data:y};switch(A){case"deleteActor":case"updateActor":if(!game.tokenActionHud.isValidActorOrItemUpdate(y.actor,y.data))return;break;case"createActiveEffect":case"deleteActiveEffect":if(!game.tokenActionHud.isSelectedActor(y.activeEffect.parent))return;break;case"updateCombatant":if(!game.tokenActionHud.isSelectedActor(y.combatant.actor))return;break;case"deleteCompendium":case"updateCompendium":if(!game.tokenActionHud.actionHandler.compendiumActionHandler.isLinkedCompendium(y.source?.metadata?.id))return;game.tokenActionHud.actionHandler.compendiumActionHandler.compendiumActions=new Map;break;case"createItem":case"deleteItem":case"updateItem":if(!game.tokenActionHud.isValidActorOrItemUpdate(y.item?.actor))return;break;case"deleteMacro":case"updateMacro":game.tokenActionHud.actionHandler.macroActionHandler.macroActions=null;break;case"updateToken":if(Object.hasOwn(y.data,"y")||Object.hasOwn(y.data,"x"))return;if(!game.tokenActionHud.isValidTokenChange(y.token,y.data))return}game.tokenActionHud.update(w)}await A.init(),game.tokenActionHud||(game.tokenActionHud=new TokenActionHud(V,R),game.tokenActionHud.socket=j,await game.tokenActionHud.init()),Hooks.on("renderTokenActionHud",(()=>game.tokenActionHud.postRender())),Hooks.on("deleteActor",((y,A)=>handleHookEvent({actor:y,data:A},"deleteActor"))),Hooks.on("updateActor",((y,A)=>handleHookEvent({actor:y,data:A},"updateActor"))),Hooks.on("createActiveEffect",((y,A,w)=>handleHookEvent({activeEffect:y,options:A,userId:w},"createActiveEffect"))),Hooks.on("deleteActiveEffect",((y,A,w)=>handleHookEvent({activeEffect:y,options:A,userId:w},"deleteActiveEffect"))),Hooks.on("createCombat",(y=>handleHookEvent({combat:y},"createCombat"))),Hooks.on("deleteCombat",(y=>handleHookEvent({combat:y},"deleteCombat"))),Hooks.on("updateCombat",(y=>handleHookEvent({combat:y},"updateCombat"))),Hooks.on("updateCombatant",((y,A,w,k)=>handleHookEvent({combatant:y,data:A,options:w,userId:k},"updateCombatant"))),Hooks.on("deleteCompendium",((y,A)=>handleHookEvent({source:y,html:A},"deleteCompendium"))),Hooks.on("renderCompendium",((y,A)=>handleHookEvent({source:y,html:A},"renderCompendium"))),Hooks.on("updateCompendium",((y,A)=>handleHookEvent({source:y,html:A},"updateCompendium"))),Hooks.on("createItem",(y=>handleHookEvent({item:y},"createItem"))),Hooks.on("deleteItem",(y=>handleHookEvent({item:y},"deleteItem"))),Hooks.on("updateItem",(y=>handleHookEvent({item:y},"updateItem"))),Hooks.on("deleteMacro",(()=>handleHookEvent({},"deleteMacro"))),Hooks.on("updateMacro",(()=>handleHookEvent({},"updateMacro"))),Hooks.on("controlToken",((y,A)=>handleHookEvent({token:y,controlled:A},"controlToken"))),Hooks.on("deleteToken",((y,A,w,k)=>handleHookEvent({scene:y,token:A,change:w,userId:k},"deleteToken"))),Hooks.on("updateToken",((y,A,w)=>handleHookEvent({token:y,data:A,diff:w},"updateToken"))),Hooks.on("closeSettingsConfig",(()=>handleHookEvent({},"closeSettingsConfig"))),Hooks.on("forceUpdateTokenActionHud",(()=>handleHookEvent({},"forceUpdateTokenActionHud")));game.tokenActionHud.update({type:"hook",name:"canvasReady"})})),Hooks.on("renderSceneNavigation",((y,A)=>{A.find("li.scene.nav-item").contextmenu((y=>sendHudToBottom()))})),Hooks.on("renderHotbar",((y,A)=>{A.find("li.macro").contextmenu((y=>sendHudToBottom()))}));
//# sourceMappingURL=token-action-hud-core.min.js.map
