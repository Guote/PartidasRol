var CFG={id:"data-inspector",SETTINGS:{allowEditing:"allowEditing",allowEditingUnsupported:"allowEditingUnsupported",allowUsers:"allowUsers",functions:"functions",results:"results",mode:"mode",tooltip:"tooltip"},COLORS:{main:"color:deepskyblue",number:"color:mediumpurple",label:"color:mediumseagreen",id:"color:darkseagreen",unset:"color:unset"},typeIcons:{array:"fa-solid fa-list-ol",number:"fa-solid fa-hashtag",string:"",object:"fa-solid fa-box",model:"fa-solid fa-pizza-slice"}};var DATA_TYPES={undefined:-1,null:0,object:110,number:410,boolean:420,string:430,array:120,set:130,map:510,collection:520,function:910,getter:980,model:1010,document:2020,placeable:5010,pixi:5020,app:5030,custom:1e4};var DATA_TYPE_INVERTED=foundry.utils.invertObject(DATA_TYPES);var getTypeName=(value)=>{if(value===undefined)return"undefined";if(value===null)return"null";const type=typeof value;if(["string","number","function","boolean"].includes(type))return type;if(Array.isArray(value))return"array";const n=value.__proto__.constructor.name;if(n==="Object")return"object";if(n==="Map")return"map";return"_"+n};function getChildTypeId(parent,childKey){const data=Object.getOwnPropertyDescriptor(parent,childKey);if(typeof data.get==="function")return DATA_TYPES.getter;return getTypeId(parent[childKey])}function getTypeId(value){if(value===undefined)return DATA_TYPES.undefined;if(value===null)return DATA_TYPES.null;const type=typeof value;switch(type){case"string":return DATA_TYPES.string;case"number":case"bigint":return DATA_TYPES.number;case"function":return DATA_TYPES.function;case"boolean":return DATA_TYPES.boolean}if(Array.isArray(value))return DATA_TYPES.array;if(value instanceof Set)return DATA_TYPES.set;if(value instanceof foundry.abstract.Document)return DATA_TYPES.document;if(value instanceof PlaceableObject)return DATA_TYPES.placeable;if(value instanceof PIXI.Container)return DATA_TYPES.pixi;if(value instanceof Application)return DATA_TYPES.app;if(value instanceof foundry.abstract.DataModel)return DATA_TYPES.model;if(value instanceof Collection)return DATA_TYPES.collection;if(value instanceof Map)return DATA_TYPES.map;const n=value.__proto__?.constructor.name;if(n==="Object")return DATA_TYPES.object;return DATA_TYPES.custom}var fu=foundry.utils;var setUpdateData=(update,parent,{inArray=false,isUpdate=false,isDelete=false}={})=>{const opLabel=isDelete?"Delete":"Update";const{value,last:updateProp}=update;const C=CFG.COLORS;if(Array.isArray(updateProp)){const index=Number(parent.child);console.log(`${opLabel} index %c${index}%c in %c${parent.path}%c`,C.number,C.unset,C.id,C.unset);if(isDelete)updateProp.splice(index,1);else{console.log("=",value);updateProp.splice(index,1,value)}}else{console.log(`${opLabel} value %c${parent.child}%c in %c${parent.path}%c`,C.id,C.unset,C.id,C.unset);if(isDelete){delete updateProp[parent.child];if(!inArray)updateProp["-="+parent.child]=null}else{console.log("... Value =",value);updateProp[parent.child]=value}}};var getParentProperty=(path,docData)=>{const parts=path.split(".");const lastProp=parts.pop();const parentPath=parts.join(".");const parent=fu.getProperty(docData,parentPath);return{path:parentPath,value:parent,child:lastProp}};var reconstructParentArrays=(docData,path)=>{const parts=path.split(".");const updateData={};let currentUpdateProp=updateData,current=docData;let inArray=false;do{const prop=parts.shift();const value=current[prop];if(Array.isArray(value)){currentUpdateProp[prop]=foundry.utils.deepClone(value);inArray=true}else currentUpdateProp[prop]??={};currentUpdateProp=currentUpdateProp[prop];current=current[prop]}while(parts.length);return{updateData,last:currentUpdateProp,inArray}};class DataEditor extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.DocumentSheetV2){_type;static get supportedTypes(){return[DATA_TYPES.number,DATA_TYPES.string,DATA_TYPES.boolean,DATA_TYPES.null,DATA_TYPES.undefined]}constructor({document:document2,path,type,isToken=false,inArray=false,...options}={}){super({document:document2,inArray,path,...options});this._isToken=isToken;this._inArray=inArray;const value=fu.getProperty(document2.toObject(),path);this._originalTypeId=type??getTypeId(value);this._originalTypeName=DATA_TYPE_INVERTED[this._originalTypeId];this._type=this._originalTypeName}get title(){const title=[game.i18n.localize("DataInspector.Title")];title.push(this.document.name);title.push(this.options.path);return title.join(": ")}_initializeApplicationOptions(options){options=super._initializeApplicationOptions(options);const documentUuid=options.document.uuid.replace(".","-");const safePath=options.path.replaceAll(".","-");options.uniqueId="data-inspector-"+documentUuid+"-"+safePath;return options}static DEFAULT_OPTIONS={tag:"form",classes:["koboldworks","data-inspector","editor","standard-form"],sheetConfig:false,window:{resizable:true},position:{width:520,height:360},form:{handler:this._onSubmit},actions:{delete:this._onDelete}};static PARTS={form:{template:`modules/${CFG.id}/template/editor.hbs`},footer:{template:"templates/generic/form-footer.hbs"}};get isUnsupported(){const value=fu.getProperty(this.document.toObject(),this.options.path),typeId=this._typeId=getTypeId(value);return!this.constructor.supportedTypes.includes(typeId)}async _prepareMainContext(context,options){const doc=this.document,value=fu.getProperty(doc.toObject(),this.options.path),typeId=this._typeId=getTypeId(value),typeName=this._type??getTypeName(value),originalTypeName=this._originalTypeName;context.document=doc;context.path=this.options.path;context.value=value;context.type=typeName;context.typeName=typeName;context.originalType=originalTypeName;context.similarType=originalTypeName==="string"&&["text","html"].includes(typeName);context.isHTML=typeName==="html";context.isString=["html","text","string"].includes(typeName);context.isLongString=typeName==="html"||typeName==="text"||originalTypeName==="string"&&(context.value.length>16||context.value.indexOf("\n")>=0);context.isUnsupported=this.isUnsupported;context.noUpdate=typeName==="undefined";context.isActor=doc instanceof Actor;context.isItem=doc instanceof Item;context.isEditable=!context.isUnsupported;context.isOwner=doc.isOwner;context.simpleType=["number","string","boolean"].includes(typeName);context.deadType=["null","undefined"].includes(typeName);context.selectedType=this._type;context.types={number:"Number",boolean:"Boolean",string:"String",null:"Null",undefined:"Undefined",text:"Text Block",html:"HTML"};context.field=null;switch(typeName){case"number":context.field=new foundry.data.fields.NumberField;break;case"string":if(context.isHTML)context.field=new foundry.data.fields.HTMLField;else context.field=new foundry.data.fields.StringField;break;case"boolean":context.field=new foundry.data.fields.BooleanField;break;case"undefined":case"null":case"object":break}context.isToken=this._isToken;context.inArray=this._inArray;context.TYPES=DATA_TYPES;return context}async _preparePartContext(partId,context,options){switch(partId){case"form":return this._prepareMainContext(context,options);case"footer":{const context2={buttons:[{type:"submit",label:"DataInspector.Update",icon:"fa-solid fa-floppy-disk",action:"submit"},{type:"button",label:"DataInspector.Delete",icon:"fa-solid fa-trash",action:"delete"}]};if(this.isUnsupported)context2.buttons.shift();return context2}}}static _onDelete(event,elem){const doc=this.document,path=this.options.path;const docData=doc.toObject();const parent=getParentProperty(path,docData);const update=reconstructParentArrays(docData,parent.path);const{updateData,inArray}=update;setUpdateData(update,parent,{isDelete:true,inArray});console.log("\uD83D\uDD0E \u2326 UpdateData:",updateData);const app=this;Dialog.confirm({title:"Delete data?",content:`<p>Delete: <code>${path}</code></p>`,yes:()=>{app.close();doc.update(updateData)},defaultYes:false})}_onRender(context,options){super._onRender(context,options);const html=this.element.querySelector(".window-content");const app=this;html.querySelector('select[name="type"]')?.addEventListener("change",(ev)=>{ev.preventDefault();ev.stopPropagation();const oldType=this._type,newType=ev.target.value;this._type=newType;this.render()});html.querySelector('select[name="type"]')?.addEventListener("change",function(ev){ev.preventDefault();ev.stopPropagation();app._type=this.value;app.editors={};app.render(true)})}static _onSubmit(event,form,formData){formData=foundry.utils.expandObject(formData.object);const type=this._type,path=this.options.path,doc=this.document;let value=formData.value;if(type==="undefined")value=undefined;else if(type==="null")value=null;console.log("Setting data:",{type,path,value});const docData=doc.toObject();const parent=getParentProperty(path,docData);const update=reconstructParentArrays(docData,parent.path);const{updateData}=update;update.value=value;setUpdateData(update,parent,{isUpdate:true});console.log("\uD83D\uDD0E \uFF0B UpdateData:",updateData);try{doc.update(updateData)}finally{this.close()}}}var fu2=foundry.utils;var dataKeySorter=(a,b)=>a.key.localeCompare(b.key);class StubModel extends(foundry.abstract.TypeDataModel||foundry.abstract.DataModel){static defineSchema(){return{}}}var ignoreDataModelParts=Object.getOwnPropertyNames(new StubModel);class ChildKeyData{key;type;constructor(key,type){this.key=key;this.type=type}}class DataStructure{key;path;get basePath(){return this.path.replace(/^system\./,"")}get type(){return DATA_TYPE_INVERTED[this.typeId]}typeId;root;value;parent;children=[];depth=0;treetype;get isRollData(){return this.root.treetype==="rolldata"}_sourceData;_derivedData;_rollData;_overides;includeFunctions=false;get isBigString(){return this.typeId===DATA_TYPES.string&&this.value?.length>24}get isNull(){return this.typeId===DATA_TYPES.null}get isFunction(){return this.typeId===DATA_TYPES.function}get isGetter(){return this.typeId===DATA_TYPES.getter}get isUndefined(){return this.typeId===DATA_TYPES.undefined}get isNullish(){if([DATA_TYPES.null,DATA_TYPES.undefined].includes(this.typeId))return true;if(this.isArray&&this.value.length===0)return true;if(this.isSet&&this.value.size===0)return true;if((this.isMap||this.isCollection)&&this.value.size==0)return true;return false}get identifier(){switch(this.typeId){case DATA_TYPES.custom:case DATA_TYPES.model:return this.value.constructor.name;default:return null}}get isModel(){return this.typeId===DATA_TYPES.model}get isArray(){return this.typeId===DATA_TYPES.array}get isSet(){return this.typeId===DATA_TYPES.set}get isArrayLike(){return this.isArray||this.isSet}get isMap(){return this.typeId===DATA_TYPES.map}get isCollection(){return this.typeId===DATA_TYPES.collection}get isObject(){return this.typeId===DATA_TYPES.object}get isUndesirable(){return this.isDocument||[DATA_TYPES.placeable,DATA_TYPES.pixi,DATA_TYPES.app].includes(this.typeId)}get isDocument(){return[DATA_TYPES.document].includes(this.typeId)}get documentId(){if(this.typeId===DATA_TYPES.document)return this.value.id;return}get hasName(){if(this.isContainer){return"name"in this.value||"label"in this.value||"title"in this.value}return false}get name(){return this.value.name||this.value.label||this.value.title}get hasValues(){if(this.isContainer&&!this.isArrayLike){return"total"in this.value||"value"in this.value||"max"in this.value}return false}get values(){const data={value:this.value.value,haveValue:false,max:this.value.max,haveMax:false,isValue:false,total:this.value.total,haveTotal:false,noValues:false};if(data.value===null||typeof data.value==="number"){data.value=`${data.value}`;data.haveValue=true}if(data.max===null||typeof data.max==="number"){data.max=`${data.max}`;data.haveMax=true}if(data.total===null||typeof data.total==="number"){data.total=`${data.total}`;data.haveTotal=true}if(data.haveValue||data.haveMax){data.isValue=true;data.isValueOf=data.haveValue&&data.haveMax}if(!data.isValue&&!data.haveTotal)data.noValues=true;return data}get className(){return this.value.__proto__?.constructor.name}get isEmpty(){if(this.isNullish)return true;switch(this.typeId){case DATA_TYPES.string:case DATA_TYPES.array:return this.value.length==0;case DATA_TYPES.object:return fu2.isEmpty(this.value);case DATA_TYPES.map:case DATA_TYPES.collection:return this.value.size===0;case DATA_TYPES.custom:return this.children.length==0}return false}get isEmptyPrimitive(){return this.isNull||this.isUndefined}recursionPoint=false;get isPrimitive(){return this.isBoolean||this.isNumber||this.isString||this.isNull||this.isUndefined}get isBoolean(){return this.typeId===DATA_TYPES.boolean}get isString(){return this.typeId===DATA_TYPES.string}get isNumber(){return this.typeId===DATA_TYPES.number}get inArray(){return this.parent?.isArrayLike??false}get isContainer(){if(this.recursionPoint)return false;return[DATA_TYPES.array,DATA_TYPES.set,DATA_TYPES.object,DATA_TYPES.model,DATA_TYPES.map,DATA_TYPES.collection,DATA_TYPES.custom].includes(this.typeId)}get isChildless(){return[DATA_TYPES.boolean,DATA_TYPES.string,DATA_TYPES.null,DATA_TYPES.undefined,DATA_TYPES.number].includes(this.typeId)}get isCustom(){return this.typeId===DATA_TYPES.custom}get formattedValue(){switch(this.typeId){case DATA_TYPES.undefined:return"undefined";case DATA_TYPES.null:return"null";case DATA_TYPES.function:return"function"}return this.value}#inRoll;get inRollData(){if(this.#inRoll===undefined){if(this.root.treetype==="rolldata")return this.#inRoll=true;if(!this.root._rollData)return false;const path=this.basePath;try{return this.#inRoll=fu2.hasProperty(this.root._rollData,path)}catch(err){}return this.#inRoll=3}return this.#inRoll}#inSource;get inSourceData(){if(this.#inSource===undefined){if(this.root.treetype==="source")return this.#inSource=true;if(!this.root._sourceData)return false;const path=this.basePath;try{const data=this.root._sourceData;return this.#inSource=fu2.hasProperty(data,path)}catch(err){}return this.#inSource=3}return this.#inSource}#inDerived;get inDerivedData(){if(this.#inDerived===undefined){if(this.root.treetype==="derived")return this.#inDerived=true;if(!this.root._derivedData)return false;const path=this.basePath;try{const data=this.root._derivedData;return this.#inDerived=fu2.hasProperty(data,path)}catch(err){}return this.#inDerived=3}return this.#inDerived}#inTemporary;get inTemporaryData(){if(this.#inTemporary===undefined){if(!this.root._temporaryData)return false;const path=this.basePath;try{const data=this.root._temporaryData;return this.#inTemporary=fu2.hasProperty(data,path)}catch(err){}return this.#inTemporary=3}return this.#inTemporary}get hasOverrides(){return!!this._overrides}get css(){if(this.typeId===DATA_TYPES.boolean)return this.value?"true":"false";if(this.typeId===DATA_TYPES.number)return this.value===0?"zero":this.value<0?"negative":"positive";return""}constructor({key,path,value,parent,type,treeType,depth}){this.key=key;this.path=path;this.typeId=type??getTypeId(value);this.value=value;this.parent=parent;this.root=parent?.root??parent;this.depth=depth;this.treetype=treeType;this.includeFunctions=parent?.includeFunctions??false}#childKeys;childKeys(){if(this.#childKeys)return this.#childKeys;if(this.isUndesirable)return[];switch(this.typeId){case DATA_TYPES.set:return this.#childKeys=[Array.from(this.value).map((k)=>new ChildKeyData(k))];case DATA_TYPES.array:return this.#childKeys=[this.value.map((k)=>new ChildKeyData(k))];case DATA_TYPES.collection:case DATA_TYPES.map:return this.#childKeys=[Array.from(this.value.keys()).map((k)=>new ChildKeyData(k))];case DATA_TYPES.model:case DATA_TYPES.object:case DATA_TYPES.custom:{const allKeys=[],rvg=[],rvf=[];const props=Object.getOwnPropertyNames(this.value).filter((k)=>{if(this.isModel)return!ignoreDataModelParts.includes(k);return true});allKeys.push(...props.map((k)=>new ChildKeyData(k)));if(this.includeFunctions){let proto=this.value;if([DATA_TYPES.custom,DATA_TYPES.object,DATA_TYPES.model].includes(this.typeId)){const ignored=["constructor","toString","almostEqual","__proto__","prototype","between","toObject","toJSON","clone"];const ignoreModelBits=[...ignoreDataModelParts,"schema","validationFailures","invalid","validate","update","updateSource","reset"];do{const keys=Object.getOwnPropertyNames(proto);for(const key of keys){if(key.startsWith("_"))continue;if(ignored.includes(key))continue;if(this.isModel&&ignoreModelBits.includes(key))continue;const cType=getChildTypeId(proto,key);if(cType===DATA_TYPES.getter)rvg.push(new ChildKeyData(key,DATA_TYPES.getter));else if(cType===DATA_TYPES.function)rvf.push(new ChildKeyData(key,DATA_TYPES.function))}proto=Object.getPrototypeOf(proto);if(proto?.__proto__==null)break}while(proto)}}return this.#childKeys=[allKeys.sort(dataKeySorter),rvg.sort(dataKeySorter),rvf.sort(dataKeySorter)]}default:return this.#childKeys=[]}}fillChildren(){if(this.recursionPoint)return[];const curpath=this.path,basePath=curpath?.length?curpath:this.key,isArrayLike=this.isArrayLike,isMap=this.isMap||this.isCollection,isSet=this.isSet;const saferValue=isSet?Array.from(this.value):this.value;const parseChildren=(list)=>{list?.forEach((ckData,i)=>{const{key,type}=ckData;const childKey=!isArrayLike?key:i;const path=basePath?`${basePath}.${childKey}`:childKey;const hookId="data-inspector.filterData";if(Hooks.events[hookId]){if(Hooks.call(hookId,this.root.document,path,this.treetype)===false)return}const value=isMap?this.value.get(childKey):saferValue[childKey],typeId=getTypeId(value);if(typeId===DATA_TYPES.function&&!this.includeFunctions)return;const c=new DataStructure({key:childKey,path,value,parent:this,type,depth:this.depth+1});this.children.push(c)})};const[all,functions,getters]=this.childKeys();parseChildren(all);parseChildren(functions);parseChildren(getters);return this.children}static recurse(sourceData,key,path,type,{includeFunctions=false,document:document2}={}){this.includeFunctions=includeFunctions??false;const dt=new DataStructure({key,path,value:sourceData,parent:null,treeType:type,depth:0});dt.document=document2;dt.root=dt;const all={};if(dt.path)all[dt.path]=dt;let itemCount=0,error=false,maxDepth=0;const visitedNodes=new Map;const handleChild=(ds)=>{all[ds.path]=ds;if(maxDepth<ds.depth)maxDepth=ds.depth;itemCount++;if(itemCount>25000){if(!error){ui.notifications.error("DATA INSPECTOR | Possible cyclic reference encountered; ending inspection early",{console:false});console.error(ds.path,"\nDATA INSPECTOR | Possible cyclic reference encountered; ending inspection early\n",ds);error=true}return}if(!ds.isPrimitive){const old=visitedNodes.get(ds.value);if(old){ds.recursionPoint=old;return}else visitedNodes.set(ds.value,ds.path)}try{recurseChildren(ds)}catch(err){console.error(err,this);throw err}};const recurseChildren=(ds)=>{if(!ds.isChildless){ds.fillChildren().forEach(handleChild)}};recurseChildren(dt);return{root:dt,all,count:itemCount,depth:maxDepth}}getAtPath(path){const parts=path.split(".");const key=parts.shift();const getPart=()=>{switch(this.typeId){case DATA_TYPES.set:case DATA_TYPES.array:return this.children[parseInt(key)];default:return this.children.find((cd)=>cd.key===key)}};const c=getPart();if(parts.length===0)return c;else if(c)return c.getAtPath(parts.join("."))}}class SearchResult{path;keyFocus=true;match;get mismatch(){return this.indexes.path.length===0}target;score;keyFullMatch;pathFullMatch;indexes={path:[],key:[]};ratio;get good(){return this.ratio>0.8}get bad(){return this.ratio<0.3}scoring={full:undefined,key:undefined};constructor({path,match,target,score,keyFocus,keyFullMatch,pathFullMatch,pathIndexes,keyIndexes,ratio,scoring}={}){this.path=path;this.match=match;this.target=target;this.keyFocus=keyFocus;this.score=score;this.keyFullMatch=keyFullMatch;this.pathFullMatch=pathFullMatch;this.indexes.path=pathIndexes;this.indexes.key=keyIndexes;this.ratio=ratio;this.scoring=scoring}}class TermMatch{score;indexes;full;half;ratio;consecutives;longestChain;scoring;constructor({indexes,full,half,ratio,consecutives,longestChain,scoring}={}){this.indexes=indexes;this.full=full;this.half=half;this.ratio=ratio;this.consecutives=consecutives;this.longestChain=longestChain;this.scoring=scoring;this.score=scoring.reduce((old,scr)=>old+scr.value)}}class Score{value;description;constructor(value,description){this.value=value;this.description=description}}var fu3=foundry.utils;function getSafeCopy(value,_visited=new Set){if(value===null)return value;if(value===undefined)return value;if(Array.isArray(value))return value.map((v)=>getSafeCopy(v,_visited));if(["string","number","boolean"].includes(typeof value))return value;if(value instanceof Set)return[...value].map((v)=>getSafeCopy(v,_visited));if(_visited.has(value))return"<<INFINITE LOOP>>";_visited.add(value);value={...value};for(const[path,pvalue]of Object.entries(value)){value[path]=getSafeCopy(pvalue,_visited)}return value}function createTemporaryDocument(doc){const data={name:doc.name+" [Temporary]",type:doc.type,system:{}};const hookId="data-inspector.temporaryData";if(Hooks.events[hookId])Hooks.callAll(hookId,doc,data);return doc instanceof Actor?new Actor.implementation(data):new Item.implementation(data)}class DataBrowser extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static EDITABLE_MODES=["source","override","flags"];_path="";_pathEl;_search="";_searchEnd=true;_functions=game.settings.get(CFG.id,CFG.SETTINGS.functions);_document=false;_mode=game.settings.get(CFG.id,CFG.SETTINGS.mode);_expandedItems=new Set;_derivedData;_sourceData;_temporaryData;_rollData;_flagData;_overrides;_resultQuality=game.settings.get(CFG.id,CFG.SETTINGS.results);root;paths;get document(){return this.options.document}get object(){return this.options.object??this.document}_initializeApplicationOptions(options){if(!options.document&&!options.object)throw new Error("Need an object to browse");if(options.object instanceof foundry.abstract.Document)options.root??="system";options=super._initializeApplicationOptions(options);const uuid=options.object?.uuid||options.document?.uuid;if(uuid)options.uniqueId="data-inspector-"+uuid.replace(".","-");else options.uniqueId="data-inspector-"+options.uniqueId;return options}get title(){const title=[];const doc=this.document;if(doc){const parent=doc.actor;if(parent)title.push(parent.name);title.push(doc.name)}const tf=this.options.title;if(tf&&doc!==this.object){if(typeof tf==="function")title.push(tf(this,this.object));else title.push(tf)}return game.i18n.localize("DataInspector.Title")+": "+title.join(" > ")}static DEFAULT_OPTIONS={tag:"form",viewPermission:"OBSERVER",classes:["koboldworks","data-inspector","browser"],window:{resizable:true,icon:"fa-solid fa-atom"},position:{width:580,height:620},sheetConfig:false,actions:{expandPath:this._onExpandPath}};static PARTS={header:{template:`modules/${CFG.id}/template/header.hbs`},form:{template:`modules/${CFG.id}/template/inspector.hbs`,templates:["object","inspector","value","object-data"].map((t)=>`modules/${CFG.id}/template/${t}.hbs`),scrollable:[".datatree > .dataview"]},footer:{template:`modules/${CFG.id}/template/footer.hbs`}};getDataVariant(doc,mode){let root=this.options.root??null;if(doc instanceof foundry.abstract.Document)root??="system";mode||=this._mode;switch(mode){case"flags":if(this._flagData==null)this._flagData=doc.flags??{};return{data:this._flagData,path:"flags"};case"override":if(this._overrides==null){this._overrides=doc.token?.delta.toObject()??{};if(root)this._overrides=foundry.utils.getProperty(this._overrides,root)??{}}return{data:this._overrides,path:root};case"rolldata":if(this._rollData==null)this._rollData=doc.getRollData();return{data:this._rollData,path:""};case"source":if(this._sourceData==null){this._sourceData=doc.toObject();if(root)this._sourceData=foundry.utils.getProperty(this._sourceData,root)??{}}return{data:this._sourceData,path:root};default:case"derived":{if(this._derivedData==null){this._derivedData=doc;if(root)this._derivedData=foundry.utils.getProperty(this._derivedData,root)}return{data:this._derivedData,path:root}}}}getBaseData(){const doc=this.object;switch(this._mode){case"flags":return doc.flags??{};case"override":return doc.token?.actorData??{};case"rolldata":return doc.getRollData();case"source":return doc.toObject();default:case"derived":return doc}}async _prepareContext(options){const doc=this.object;const isDocument=doc instanceof foundry.abstract.Document;const context={},isActor=doc instanceof Actor,type=doc.type;if(isDocument&&this._mode==="source"){this._temporaryData??=createTemporaryDocument(doc).toObject()}context.rolldata=this.getDataVariant(doc,"rolldata").data;context.sourcedata=this.getDataVariant(doc,"source").data;context.derived=this.getDataVariant(doc,"derived").data;if(isActor)context.overrides=this.getDataVariant(doc,"override").data;context.flags=this.getDataVariant(doc,"flags").data;const{data:docData,path:basePath}=this.getDataVariant(doc);context.document=doc;context.type=type;const typeLabelKey=isDocument?CONFIG[doc.documentName].typeLabels[type]:null;context.typeLabel=typeLabelKey?game.i18n.localize(typeLabelKey):null;context.objectType=doc.constructor.name;context.dataType=this._mode;context.isRollData=this._mode==="rolldata";context.isSourceData=this._mode==="source";context.isDerivedData=this._mode==="derived";context.isOverrideData=this._mode==="override";context.resultQuality=this._resultQuality;const isRollData=this._mode==="rolldata";const isFlags=this._mode==="flags";const{root,all,count,depth}=DataStructure.recurse(docData,basePath,basePath,this._mode,{includeFunctions:this._functions,document:doc});context.data=root;this.root=root;context.count=count;context.depth=depth;context.model=root.isModel?root.className:game.i18n.localize("DataInspector.NotAvailable");if(root.treetype==="source"){if(doc instanceof foundry.abstract.Document){context.model=doc.system instanceof foundry.abstract.DataModel?doc.system.constructor.name:game.i18n.localize("DataInspector.NotAvailable")}else{context.model=doc instanceof foundry.abstract.DataModel?doc.constructor.name:game.i18n.localize("DataInspector.NotAvailable")}}context.dataTypes={rolldata:"DataInspector.Data.Roll",derived:"DataInspector.Data.Derived",source:"DataInspector.Data.Source",override:"DataInspector.Data.Override",flags:"DataInspector.Data.Flags"};if(!context.data.hasOverrides)delete context.dataTypes.override;if(!this.object.getRollData)delete context.dataTypes.rolldata;if(!this.object.flags)delete context.dataTypes.flags;if(!this.object.toObject){delete context.dataTypes.source}root._sourceData=context.sourcedata;root._derivedData=context.derived;root._rollData=context.rolldata;root._overrides=context.overrides;root._temporaryData=this._temporaryData?.system;context.uuid=doc.uuid;context.search=this._search;context.searchEnd=this._searchEnd;context.includeFunctions=this._functions;context.includeDocument=this._document;context.path=this._path;context.TYPES=DATA_TYPES;return context}_treeWalker(el,callback,...args){callback(el,...args);const parent=el.parentElement;if(parent&&["LI","UL"].includes(parent.tagName))this._treeWalker(parent,callback,...args)}_highlightEl(el,enabled=true){if(this._pathEl)this._pathEl.classList.toggle("selected",false);el.classList.toggle("selected",enabled);this._pathEl=el}_expandDataElTree(el){this._treeWalker(el,this._expandDataEl,false,true)}_expandDataEl(el,record=true,expand=undefined){el.classList.toggle("hide",false);if(el.classList.contains("value")||el.classList.contains("empty")){return}if(record){const path=el.dataset.path;const items=this._expandedItems;el.classList.contains("collapsed")?items.add(path):items.delete(path)}el.classList.toggle("collapsed",expand!==undefined?!expand:undefined);el.classList.toggle("expanded",expand)}collapseAndClearEl(el,hide=false,includeValues=false){el.classList.toggle("hide",hide);el.dataset.matchQuality=null;el.classList.toggle("selected",false);if(el.classList.contains("value")||el.classList.contains("empty"))return;el.classList.toggle("collapsed",true);el.classList.toggle("expanded",false)}static _onExpandPath(ev,el){ev.stopPropagation();this._expandDataEl(el)}static _onCopyPath(ev,elem){const path=elem.closest("[data-path]").dataset.path;if(!path){ui.notifications.error("Failed to parse data path.");return void console.error("Failed to parse path from",{path,element:elem})}const properPath=this._mode==="rolldata"?`@${path}`:path;console.log(`Saving path %c${path}%c to clipboard`,CFG.COLORS.id,CFG.COLORS.unset);game.clipboard.copyPlainText(properPath).then(()=>ui.notifications.info(game.i18n.format("DataInspector.Info.CopyPath",{path})))}static _onCopyValue(ev,elem){const path=elem.closest("[data-path]").dataset.path;if(!path){ui.notifications.error("Failed to parse data path.");return void console.error("Failed to parse path from",{path,element:this})}const{path:root,data}=this.getDataVariant(this.object);const copyData=root?{}:data;if(root)foundry.utils.setProperty(copyData,root,data);const original=fu3.getProperty(copyData,path);const value=getSafeCopy(original);const jsonString=JSON.stringify(value,null,2);console.log(`Saving value of %c${path}%c to clipboard:`,CFG.COLORS.id,CFG.COLORS.unset,{value:jsonString});game.clipboard.copyPlainText(jsonString).then(()=>ui.notifications.info(game.i18n.format("DataInspector.Info.CopyValue",{path})))}_syncPartState(partId,newEl,oldEl,state){if(partId==="form")this._syncMainPart(newEl);return super._syncPartState(partId,newEl,oldEl,state)}_syncMainPart(html){for(const el of html.querySelectorAll("[data-path]")){const path=el.dataset.path;if(this._expandedItems.has(path))this._expandDataEl(el)}}_onRender(context,options){super._onRender(context,options);const html=this.element.querySelector(".window-content");const header=html.querySelector("header");const appEl=html.closest("[data-appid]");if(appEl){const doc=this.document;const item=doc instanceof Item?doc:null;if(item){appEl.dataset.itemId=item.id;appEl.dataset.itemUuid=item.uuid}const actor=doc instanceof Actor?doc:doc.parent;if(actor){appEl.dataset.actorId=actor.id;appEl.dataset.actorUuid=actor.uuid}}const app=this;const dataSection=html.querySelector(".datatree > .dataview");dataSection.addEventListener("dblclick",function openEditor(ev){ev.preventDefault();ev.stopPropagation();if(DataBrowser.EDITABLE_MODES.includes(app._mode)){const el=ev.target;const ael=el.dataset.path?el:el.closest("[data-path]");if(ael)app._openValueEditor(ev,ael.dataset.path)}else{ui.notifications.warn(`Editing not supported in "${app._mode}" mode!`)}});const events={copy:{path:this.constructor._onCopyPath.bind(this),value:this.constructor._onCopyValue.bind(this)}};dataSection.addEventListener("contextmenu",function copyData(ev){ev.preventDefault();ev.stopPropagation();const elem=ev.target.closest("[data-copy]");events.copy[elem?.dataset.copy]?.(ev,elem)});const buildSearchCache=(el)=>{const path=el.dataset.path;const key=el.dataset.key;const label=el.querySelector("label.key");this.paths.set(path,{path,key,element:el,label:label.textContent})};const useTooltips=game.settings.get(CFG.id,CFG.SETTINGS.tooltip);const paths=dataSection.querySelectorAll("li[data-path]");const pathPrefix=this._mode==="rolldata"?"@":"";paths.forEach((el)=>{if(!useTooltips)return;const dEl=el.querySelector(".details");dEl?.addEventListener("mouseenter",async(ev)=>{const path=el.dataset.path;let dpath=path;if(app._mode!=="rolldata"){const parts=path.split(".");if(this.options.root)parts.shift();dpath=parts.join(".")}const dd=this.root?.getAtPath(dpath);const typeId=dd.typeId;const typeName=typeId!==DATA_TYPES.custom?game.i18n.localize(`DataInspector.Types.${DATA_TYPE_INVERTED[typeId]}`):dd.className;const isFlags=dd.treetype==="flags";const templateData={dd,path:pathPrefix+path,type:typeName,documentId:dd.documentId,isContainer:dd.isContainer||dd.isDocument,children:dd.isContainer||dd.isDocument?dd.children.length:null,isString:dd.isString,length:dd.isString?dd.value.length:null,treetype:dd.treetype,notFlags:!isFlags,inData:{rolldata:{show:!isFlags&&dd.treetype!=="rolldata",label:"DataInspector.Data.Roll",present:!isFlags?dd.inRollData:false},derived:{show:!isFlags&&dd.treetype!=="derived",label:"DataInspector.Data.Derived",present:!isFlags?dd.inDerivedData:false},source:{show:!isFlags&&dd.treetype!=="source",label:"DataInspector.Data.Source",present:!isFlags?dd.inSourceData:false},temporary:{show:dd.treetype==="source",label:"DataInspector.Data.Temporary",present:!isFlags?dd.inTemporaryData:false}}};const div=document.createElement("div");const rt=foundry.utils.renderTemplate??renderTemplate;div.innerHTML=await rt(`modules/${CFG.id}/template/tooltip.hbs`,templateData);game.tooltip.activate(dEl,{content:div,direction:"UP",cssClass:"data-inspector"})},{passive:true});dEl?.addEventListener("mouseleave",()=>game.tooltip.deactivate(),{passive:true})});const search=header.querySelector("input.search");search.addEventListener("change",(ev)=>this.debounceSearch(ev.target.value,ev,false),{passive:true});search.addEventListener("input",(ev)=>this.debounceSearch(ev.target.value,ev,true),{passive:true});this.paths=new Collection;paths.forEach((el)=>buildSearchCache(el));const functions=header.querySelector("input.functions");functions.addEventListener("change",(ev)=>{ev.preventDefault();ev.stopPropagation();this._functions=ev.target.checked;this.render()});if(this._search.length)this.debounceSearch(this._search);if(this._functions){if(!this._getGetterValueBound)this._getGetterValueBound=this._getGetterValue.bind(this);dataSection.addEventListener("click",function(ev){if(!ev.target.matches(".getter.value"))return;ev.preventDefault();ev.stopPropagation();app._getGetterValueBound(ev)})}this.expandSelectedPath()}_onChangeForm(config,event){super._onChangeForm(config,event);const el=event.target;switch(el.name){case"mode":this._onChangeDataSource(el.value,el,event);break;case"quality":this._onChangeSearchQuality(el.valueAsNumber,el,event);break;case"path":this._debounceCustomPath(el.value,event,true);break}}_onChangeSearchQuality(quality,el,ev){this._resultQuality=quality;if(this._search.length>0)this.doSearch(this._search,{forceRefresh:true})}_onChangeDataSource(mode,el,event){console.log("Mode Change:",this._mode,"->",mode);if(this._mode===mode)return;const path=this._path;if(path.length>0){const pathp=path.split("");const root=this.options.root??null;let prefix;if(root)prefix=`${root}.`;if(path[0]==="@"&&this._mode==="rolldata")pathp.splice(0,1,prefix);else if(path.length>5&&path.startsWith(prefix)&&mode==="rolldata")pathp.splice(0,prefix.length,"@");this._path=pathp.join("")}this._path=this.getBasePath(this._path,this._mode);this._mode=mode;this._lastSearch=undefined;this.render({keepCache:true})}_openValueEditor(event,path){if(!game.settings.get(CFG.id,CFG.SETTINGS.allowEditing))return ui.notifications.warn("Editing has been disabled.");const pp=path.split(".");const doc=this.document;let currentData=doc;let type;let inArray=false;while(pp.length>0){const part=pp.shift();type=getChildTypeId(currentData,part);if(type===DATA_TYPES.getter)return ui.notifications.error(game.i18n.localize("DataInspector.Error.NoGetterEdit"));currentData=currentData[part];if(currentData==null&&pp.length>0)return ui.notifications.warn(game.i18n.format("DataInspector.Error.NavigationFailure",{path}));if(Array.isArray(currentData)&&pp.length>0){inArray=true}}const isSupported=DataEditor.supportedTypes.includes(type);if(!isSupported){const allowUnsupported=game.settings.get(CFG.id,CFG.SETTINGS.allowEditingUnsupported);if(!allowUnsupported)return ui.notifications.warn(game.i18n.format("DataInspector.Error.UnsupportedEditType",{type:DATA_TYPE_INVERTED[type]}))}new DataEditor({document:this.document,path,type,isToken:this._mode==="override",inArray}).render({force:true,focus:true})}_copyId(_event){const id=this.dataset.id;console.log("Copying ID:",id);return game.clipboard.copyPlainText(id)}_getGetterValueBound;_getGetterValue(event){event.stopImmediatePropagation();event.preventDefault();const target=event.target;if(!target)return;target.removeEventListener("click",this._getGetterValueBound);this._resolveGetter(target)}_resolveGetter(element){const el=element.dataset.path?element:element.closest("[data-path]");if(!el)return;const path=el.dataset.path;const ds=this.root.getAtPath(path);const value=ds.value;ds.typeId=getTypeId(value);element.textContent=value;element.classList.add("resolved");element.classList.add(ds.type)}getBasePath(path,oldMode,targetMode){oldMode??=this._mode;if(oldMode==="rolldata")return path.replace(/^@/,"");if(targetMode==="rolldata")return path.replace(/^system\./,"@");return path}expandSelectedPath(){if(this._path.length==0)return;const path=this.getBasePath(this._path);const p=this.paths.get(path);if(p){this._expandDataElTree(p.element);this._pathEl=p.element;this._highlightEl(this._pathEl,true);this._pathEl.scrollIntoView({block:"center"})}}static INPUT_DELAY=250;static INPUT_MAX_DELAY=500;searchDelayTimer;selectDelayTimer;debounceSearch(search,event,active=false){clearTimeout(this.searchDelayTimer);if(search.length===0)active=false;const iDelay=this.constructor.INPUT_DELAY;const iMaxDelay=this.constructor.INPUT_MAX_DELAY;const delay=Math.clamp(active?search.length>3?iDelay:iDelay*2:iDelay/2,100,iMaxDelay);this.searchDelayTimer=setTimeout((_)=>this.doSearch(search),delay)}_debounceCustomPath(input,event,active=false){this._path=input;if(this._pathEl){this._pathEl.classList.toggle("selected",false);this._pathEl=null}clearTimeout(this.selectDelayTimer);if(input.length===0)active=false;const iDelay=this.constructor.INPUT_DELAY;const iMaxDelay=this.constructor.INPUT_MAX_DELAY;const delay=Math.clamp(active?input.length>3?iDelay:iDelay*2:iDelay/2,100,iMaxDelay);this.selectDelayTimer=setTimeout((_)=>this.selectCustomPath(input),delay)}selectCustomPath(input){this._path=input;this.expandSelectedPath();const path=this.paths.get(input);if(path){this._expandDataElTree(path.element);this._highlightEl(path.element);this._pathEl=path.element}else{this._pathEl=null}}_lastSearch;lastEndSerch;doSearch(search,{forceRefresh=false}={}){this._search=search;console.log("Searching:",this._search);if(forceRefresh!==true&&this._lastSearch===search&&this.lastEndSerch===this._searchEnd)return;this._lastSearch=search;this.lastEndSerch=this._searchEnd;if(search.length==0){this.paths.forEach((p)=>this.collapseAndClearEl(p.element,false));this.expandSelectedPath();return}this.paths.forEach((p)=>this.collapseAndClearEl(p.element,true));const term=search.toLowerCase().split("");function matchTerm(term2,subject,{harsh=true}={}){const indexes=[];const subjectParts=subject.toLowerCase().split("");let consecutives=0,longestChain=0;let si=0,sm=term2[0],lastMatch=-2;let lastChain=1;const scoring=[];const updateLongestChain=()=>{if(lastChain>longestChain)longestChain=lastChain;lastChain=1};for(let i=0;i<subjectParts.length;i++){if(subjectParts[i]===sm){indexes.push(i);if(lastMatch===i-1){scoring.push(new Score(3,`Consecutive [${i}]: +3`));consecutives++;lastChain++}else{scoring.push(new Score(1,`Match [${i}]: +1`));updateLongestChain()}lastMatch=i;const endBonus=Math.clamp(Math.round((subjectParts.length-i)/5),0,3);if(endBonus>0)scoring.push(new Score(endBonus,`End bonus: +${endBonus}`));sm=term2[++si];if(sm===undefined)break}}updateLongestChain();if(indexes.length>0)scoring.push(new Score(indexes.length*3,`Matched letters bonus: ${indexes.length*3}`));else scoring.push(new Score(-100,"No matches: -100"));const full=indexes.length==term2.length;if(full)scoring.push(new Score(20,"Full match: +20"));const half=indexes.length<Math.floor(term2.length/2)-2;if(harsh){const cumulative=scoring.reduce((prev,cur)=>cur.value+prev),halfScore=-Math.floor(cumulative/2);if(half)scoring.push(new Score(halfScore,`Partial match: ${halfScore}`));if(longestChain<=1)scoring.push(new Score(-20,"Short chains: -20"))}return new TermMatch({indexes,full,half,ratio:(consecutives+1)/term2.length,consecutives,longestChain,scoring})}let fullMatches0=0,fullMatches1=0;const results=this.paths.reduce((results2,target)=>{const matchPath=matchTerm(term,target.path),matchKey=matchTerm(term,target.key);if(matchKey.full)fullMatches0++;if(matchPath.full)fullMatches1++;let match=matchPath.ratio>0.5,ratio=matchPath.ratio;if(this._keyFocus){matchPath.score/=5;ratio=matchKey.ratio;match=matchKey.ratio>matchPath.ratio}else{ratio+=matchKey.ratio*2;ratio/=3}results2.push(new SearchResult({path:target.path,match,target,keyFocus:this._keyFocus,score:matchPath.score/2+matchKey.score*2,keyFullMatch:matchKey.full,pathFullMatch:matchPath.full,pathIndexes:matchPath.indexes,keyIndexes:matchKey.indexes,ratio,scoring:{full:matchPath.scoring,key:matchKey.scoring}}));return results2},[]);results.sort((a,b)=>{if(a.full&&!b.full)return-1;if(b.full&&!a.full)return 1;return b.score-a.score});const Break={};try{results.forEach((r)=>{const el=r.target.element;el.dataset.searchScore=`${r.score}`;el.dataset.searchRatio=`${r.ratio}`;let q="decent";if(r.mismatch)q="mismatch";else if(r.bad)q="bad";else if(r.good)q="good";el.dataset.matchQuality=q;if(fullMatches0>0){if(r.ratio>this._resultQuality)this._expandDataElTree(el)}else if(!r.bad)this._expandDataElTree(el)})}catch(err){if(err!==Break)throw err}this.expandSelectedPath()}render(options={}){if(options.action==="update")options.keepCache=false;if(options.keepCache!==true){this._currentData=undefined;this._rollData=undefined;this._sourceData=undefined;this._derivedData=undefined;this._overrides=undefined;this._flagData=undefined;this._lastSearch=undefined}return super.render(options)}_onFirstRender(context,options){super._onFirstRender(context,options);if(this.document){this.document.apps[this.id]=this}}async _preClose(options){await super._preClose(options);if(this.document){delete this.document.apps[this.id]}}}var refreshActiveDialogs=()=>Object.values(ui.windows).forEach((app)=>app instanceof DataBrowser?app.render():null);Hooks.once("init",function registerSettings(){game.settings.register(CFG.id,CFG.SETTINGS.mode,{name:"DataInspector.Settings.DefaultMode",hint:"DataInspector.Settings.DefaultModeHint",scope:"client",config:true,type:String,default:"rolldata",choices:{rolldata:"DataInspector.Data.Roll",source:"DataInspector.Data.Source",derived:"DataInspector.Data.Derived",flags:"DataInspector.Data.Flags"}});game.settings.register(CFG.id,CFG.SETTINGS.results,{name:"DataInspector.Settings.ResultQuality",hint:"DataInspector.Settings.ResultQualityHint",scope:"client",config:true,type:Number,default:0.7,range:{min:0,max:1,step:0.01}});game.settings.register(CFG.id,CFG.SETTINGS.functions,{name:"DataInspector.Settings.IncludeFunctions",hint:"DataInspector.Settings.IncludeFunctionsHint",scope:"client",config:true,type:Boolean,default:false});game.settings.register(CFG.id,CFG.SETTINGS.allowEditing,{name:"DataInspector.Settings.AllowEditing",hint:"DataInspector.Settings.AllowEditingHint",config:true,scope:"world",type:Boolean,default:false});game.settings.register(CFG.id,CFG.SETTINGS.allowEditingUnsupported,{name:"DataInspector.Settings.AllowEditingUnsupported",hint:"DataInspector.Settings.AllowEditingUnsupportedHint",config:true,scope:"world",type:Boolean,default:false});game.settings.register(CFG.id,CFG.SETTINGS.allowUsers,{name:"DataInspector.Settings.AllowUsers",hint:"DataInspector.Settings.AllowUsersHint",config:true,scope:"world",type:Boolean,default:true});game.settings.register(CFG.id,CFG.SETTINGS.tooltip,{name:"DataInspector.Settings.Tooltip",hint:"DataInspector.Settings.TooltipHint",config:true,scope:"client",type:Boolean,default:true,onChange:()=>refreshActiveDialogs()})});function openInspector(options={}){if(options instanceof foundry.abstract.DataModel)options={document:options};options.object??=options.document;let app=[...foundry.applications.instances].find((app2)=>app2.object===options.object);app??=new DataBrowser(options);app.render({render:true,force:true})}function injectHeaderDataButton(sheet,buttons){const allowUsers=game.settings.get(CFG.id,CFG.SETTINGS.allowUsers);if(!allowUsers&&!game.user.isGM)return;const document2=sheet.document??sheet.actor??sheet.item??sheet.object;if(!(document2 instanceof foundry.abstract.Document))throw new Error("Could not locate sheet\'s document");buttons.unshift({class:"data-inspector",icon:"fa-solid fa-atom",label:game.i18n.localize("DataInspector.DataButton"),onclick:(_)=>openInspector(document2)})}function injectContextDataButton(app,entries){let collection=app.collection??game.packs.get(packId);if(!(collection instanceof DocumentCollection))collection=collection.collection;if(!collection)return;const packId=collection.metadata?.id;const documentType=collection.documentName;if(!["Item","Actor"].includes(documentType))return;entries.push({name:"DataInspector.Context.OpenInspector",icon:'<i class="fa-solid fa-atom"></i>',condition:()=>{const allowUsers=game.settings.get(CFG.id,CFG.SETTINGS.allowUsers);return allowUsers||game.user.isGM},callback:async(entry)=>{if(entry instanceof jQuery)entry=entry[0];const documentId=entry.dataset.entryId||entry.dataset.documentId;let doc;if(packId)doc=await collection.getDocument(documentId);else doc=collection.get(documentId);if(doc)openInspector(doc);else console.warn("Document not found:",{documentId,packId,id:app.id})}})}Hooks.once("ready",async()=>{const C=CFG.COLORS;const allowUsers=game.settings.get(CFG.id,CFG.SETTINGS.allowUsers);if(!allowUsers&&!game.user.isGM)return void console.log(`%cDATA INSPECTOR%c \uD83D\uDD0D | %c${mod.version}%c | User access blocked in settings.`,C.main,C.unset,C.id,C.unset);const mod=game.modules.get(CFG.id);mod.api={inspect:openInspector,applications:{browser:DataBrowser,editor:DataEditor},handlers:{applications:{render:injectAppHeaderDataButton}}};if(["pf1"].includes(game.system.id)){await import(`./systems/${game.system.id}.mjs`).then(()=>console.log("%cDATA INSPECTOR%c \uD83D\uDD0D | System extensions loaded %c\u2714",C.main,C.unset,"color:green")).catch(()=>console.log("%cDATA INSPECTOR%c \uD83D\uDD0D | System extensions not found %c\u2718",C.main,C.unset,"color:red"))}console.log(`%cDATA INSPECTOR%c \uD83D\uDD0D | %c${mod.version}%c | READY`,C.main,C.unset,C.id,C.unset);Hooks.callAll("data-inspector.appHandler",mod.api.handlers.applications.render)});function injectAppHeaderDataButton(app,getObject,strict=false){let html=app.element;if(html instanceof jQuery)html=html[0];let object;if(getObject){object=getObject(app);object.title??=()=>object.name??object.title??object.label}else{object=app.document??app.object??app.actor??app.item}if(app instanceof foundry.applications.api.ApplicationV2)injectAppHeaderDataButtonAppV2(app,html,object,strict);else injectAppHeaderDataButtonAppV1(app,html,object,strict)}function injectAppHeaderDataButtonAppV2(app,html,target,strict=false){const header=html.querySelector("header.window-header");if(!header)return;if(header.querySelector('button[data-action="__mdiInspectData"]'))return;const rel=header.querySelector('button[data-action="copyUuid"]');if(!rel)return;const b=document.createElement("button");b.type="button";b.dataset.action="__mdiInspectData";b.dataset.tooltip=game.i18n.localize("DataInspector.Context.OpenInspector");b.classList.add("header-control","fa-solid","fa-atom","data-inspector","icon");rel.before(b);app.options.actions.__mdiInspectData??=function(_event,_el){openInspector(target)}}function injectAppHeaderDataButtonAppV1(app,html,target,strict=false){const header=html.querySelector("header.window-header");if(!header)return;if(header.querySelector("a.data-inspector.control.icon"))return;const close=header.querySelector(".header-button.control.close");const title=!close?header.querySelector(".window-title"):null;if(!close&&!title)return;const allowUsers=game.settings.get(CFG.id,CFG.SETTINGS.allowUsers);if(!allowUsers&&!game.user.isGM)return;const b=document.createElement("a");b.dataset.tooltip=game.i18n.localize("DataInspector.Context.OpenInspector");b.classList.add("header-button","control","data-inspector","icon");const i=document.createElement("i");i.classList.add("fa-solid","fa-atom","fa-fw");i.inert=true;b.append(i," ",game.i18n.localize("DataInspector.DataButton"));setTimeout(()=>{b.addEventListener("click",(event)=>{event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();openInspector(target)})},510);if(close)close.before(b);else if(title)title.after(b)}function injectDocumentSheetHeaderDataButtonV2(app,el){if(app instanceof DataBrowser||app instanceof DataEditor)return;const doc=app.document;if(!(doc instanceof Actor||doc instanceof Item))return;if(!doc?.testUserPermission?.(game.user,"OBSERVER"))return;injectAppHeaderDataButton(app,undefined,true)}Hooks.on("renderDocumentSheetV2",injectDocumentSheetHeaderDataButtonV2);Hooks.on("getActorSheetHeaderButtons",injectHeaderDataButton);Hooks.on("getItemSheetHeaderButtons",injectHeaderDataButton);Hooks.on("getItemDirectoryEntryContext",injectContextDataButton);Hooks.on("getItemContextOptions",injectContextDataButton);Hooks.on("getActorDirectoryEntryContext",injectContextDataButton);Hooks.on("getActorContextOptions",injectContextDataButton);Hooks.on("getCompendiumEntryContext",injectContextDataButton);Hooks.on("getCompendiumEntryContextOptions",injectContextDataButton);

//# debugId=D264C91AC047CEF364756E2164756E21
//# sourceMappingURL=data-inspector.mjs.map
