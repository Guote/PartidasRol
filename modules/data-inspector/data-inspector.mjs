var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});var CFG={id:"data-inspector",SETTINGS:{allowEditing:"allowEditing",allowEditingUnsupported:"allowEditingUnsupported",allowUsers:"allowUsers",functions:"functions",results:"results",mode:"mode",tooltip:"tooltip"},COLORS:{main:"color:deepskyblue",number:"color:mediumpurple",label:"color:mediumseagreen",id:"color:darkseagreen",unset:"color:unset"},typeIcons:{array:"fa-solid fa-list-ol",number:"fa-solid fa-hashtag",string:"",object:"fa-solid fa-box",model:"fa-solid fa-pizza-slice"}};var DATA_TYPES={undefined:-1,null:0,object:110,number:410,boolean:420,string:430,array:120,set:130,map:510,collection:520,function:910,getter:980,model:1010,data:2010,document:2020,placeable:5010,pixi:5020,app:5030,custom:1e4},DATA_TYPE_INVERTED=invertObject(DATA_TYPES),getTypeName=__name(value=>{if(value===void 0)return"undefined";if(value===null)return"null";let type=typeof value;if(["string","number","function","boolean"].includes(type))return type;if(Array.isArray(value))return"array";let n=value.__proto__.constructor.name;return n==="Object"?"object":n==="Map"?"map":"_"+n},"getTypeName");function getChildTypeId(parent,childKey){return Object.getOwnPropertyDescriptor(parent,childKey)?.get?DATA_TYPES.getter:getTypeId(parent[childKey])}__name(getChildTypeId,"getChildTypeId");function getTypeId(value){if(value===void 0)return DATA_TYPES.undefined;if(value===null)return DATA_TYPES.null;switch(typeof value){case"string":return DATA_TYPES.string;case"number":case"bigint":return DATA_TYPES.number;case"function":return DATA_TYPES.function;case"boolean":return DATA_TYPES.boolean}return Array.isArray(value)?DATA_TYPES.array:value instanceof Set?DATA_TYPES.set:value instanceof foundry.abstract.Document?DATA_TYPES.document:value instanceof foundry.abstract.DocumentData?DATA_TYPES.data:value instanceof PlaceableObject?DATA_TYPES.placeable:value instanceof PIXI.Container?DATA_TYPES.pixi:value instanceof Application?DATA_TYPES.app:value instanceof foundry.abstract.DataModel?DATA_TYPES.model:value instanceof Collection?DATA_TYPES.collection:value instanceof Map?DATA_TYPES.map:value.__proto__?.constructor.name==="Object"?DATA_TYPES.object:DATA_TYPES.custom}__name(getTypeId,"getTypeId");var setUpdateData=__name((update,parent,{inArray=!1,isUpdate=!1,isDelete=!1}={})=>{let opLabel=isDelete?"Delete":"Update",{value,last:updateProp}=update,C=CFG.COLORS;if(Array.isArray(updateProp)){let index=Number(parent.child);console.log(`${opLabel} index %c${index}%c in %c${parent.path}%c`,C.number,C.unset,C.id,C.unset),isDelete?updateProp.splice(index,1):(console.log("=",value),updateProp.splice(index,1,value))}else console.log(`${opLabel} value %c${parent.child}%c in %c${parent.path}%c`,C.id,C.unset,C.id,C.unset),isDelete?(delete updateProp[parent.child],inArray||(updateProp["-="+parent.child]=null)):(console.log("... Value =",value),updateProp[parent.child]=value)},"setUpdateData"),getParentProperty=__name((path,docData)=>{let parts=path.split("."),lastProp=parts.pop(),parentPath=parts.join("."),parent=getProperty(docData,parentPath);return{path:parentPath,value:parent,child:lastProp}},"getParentProperty"),reconstructParentArrays=__name((docData,path)=>{let parts=path.split("."),updateData={},currentUpdateProp=updateData,current=docData,inArray=!1;do{let prop=parts.shift(),value=current[prop];Array.isArray(value)?(currentUpdateProp[prop]=deepClone(value),inArray=!0):currentUpdateProp[prop]??={},currentUpdateProp=currentUpdateProp[prop],current=current[prop]}while(parts.length);return{updateData,last:currentUpdateProp,inArray}},"reconstructParentArrays"),ValueEditor=class _ValueEditor extends FormApplication{static{__name(this,"ValueEditor")}_path;_type;document;parentApp;static get supportedTypes(){return[DATA_TYPES.number,DATA_TYPES.string,DATA_TYPES.boolean,DATA_TYPES.null,DATA_TYPES.undefined]}constructor(document,path,type,{isToken=!1,app,inArray=!1}={}){super(document),this.document=document,this.parentApp=app,this.isToken=isToken,this._path=path,this.document=document;let value=getProperty(document.toObject(),path);this.originalTypeId=type??getTypeId(value),this.originalTypeName=DATA_TYPE_INVERTED[this.originalTypeId],this._type=this.originalTypeName,this.inArray=inArray,document.apps[this.appId]=this}get title(){let title=["Data Inspector"];return title.push(this.document.name),title.push(this._path),title.join(": ")}get id(){return"data-inspector-"+this.document.uuid.replaceAll(".","-")+"-"+this._path.replaceAll("=","-")}get template(){return`modules/${CFG.id}/template/editor.hbs`}static get defaultOptions(){let options=super.defaultOptions;return{...options,classes:[...options.classes,"koboldworks","data-inspector-editor"],submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,resizable:!0,width:520,height:360}}async getData(){let data=super.getData(),doc=this.document,value=getProperty(doc.toObject(),this._path),typeId=this._typeId=getTypeId(value),typeName=this._type??getTypeName(value),originalTypeName=this.originalTypeName;return this.object={value},data.document=doc,data.path=this._path,data.value=value,data.type=typeName,data.typeName=typeName,data.originalType=originalTypeName,data.similarType=originalTypeName==="string"&&["text","html"].includes(typeName),data.isHTML=typeName==="html",data.isString=["html","text","string"].includes(typeName),data.isLongString=typeName==="html"||typeName==="text"||originalTypeName==="string"&&(data.value.length>16||data.value.indexOf(`
`)>=0),data.isUnsupported=!_ValueEditor.supportedTypes.includes(typeId),data.noUpdate=typeName==="undefined",data.isActor=doc instanceof Actor,data.isItem=doc instanceof Item,data.isEditable=!data.isUnsupported,data.isOwner=doc.isOwner,data.simpleType=["number","string","boolean"].includes(typeName),data.deadType=["null","undefined"].includes(typeName),data.selectedType=this._type,data.types={number:"Number",boolean:"Boolean",string:"String",null:"Null",undefined:"Undefined",text:"Text Block",html:"HTML"},data.enriched=data.isHTML?await TextEditor.enrichHTML(this.object.value,{async:!0}):null,data.isToken=this.isToken,data.inArray=this.inArray,data.TYPES=DATA_TYPES,data}_deleteData(event){event.preventDefault(),event.stopPropagation();let doc=this.document,path=this._path,docData=doc.toObject(),parent=getParentProperty(path,docData),update=reconstructParentArrays(docData,parent.path),{updateData,inArray}=update;setUpdateData(update,parent,{isDelete:!0,inArray}),console.log("\u{1F50E} \u2326 UpdateData:",updateData);let app=this;Dialog.confirm({title:"Delete data?",content:`<p>Delete: <code>${path}</code></p>`,yes:()=>{app.close(),doc.update(updateData)},defaultYes:!1})}activateListeners(jq){super.activateListeners(jq);let html=jq[0],app=this;html.querySelector('select[name="type"]')?.addEventListener("change",ev=>{ev.preventDefault(),ev.stopPropagation();let oldType=this._type,newType=ev.target.value;this._type=newType,this.render()}),html.querySelector('select[name="type"]')?.addEventListener("change",function(ev){ev.preventDefault(),ev.stopPropagation(),app._type=this.value,app.editors={},app.render(!0)}),html.querySelector("button.delete")?.addEventListener("click",app._deleteData.bind(app))}_updateObject(event,formData){event.preventDefault(),event.stopPropagation();let type=this._type,path=this._path,doc=this.document,value=formData.value;type==="undefined"?value=void 0:type==="null"&&(value=null),console.log("Setting data:",{type,path,value});let docData=doc.toObject(),parent=getParentProperty(path,docData),update=reconstructParentArrays(docData,parent.path),{updateData}=update;update.value=value,setUpdateData(update,parent,{isUpdate:!0}),console.log("\u{1F50E} \uFF0B UpdateData:",updateData),doc.update(updateData).then(_=>this.close())}close(...args){delete this.document.apps[this.appId],super.close(...args)}};var dataKeySorter=__name((a,b)=>a.key.localeCompare(b.key),"dataKeySorter"),StubModel=class extends(foundry.abstract.TypeDataModel||foundry.abstract.DataModel){static{__name(this,"StubModel")}static defineSchema(){return{}}},ignoreDataModelParts=Object.getOwnPropertyNames(new StubModel),ChildKeyData=class{static{__name(this,"ChildKeyData")}key;type;constructor(key,type){this.key=key,this.type=type}},DataStructure=class _DataStructure{static{__name(this,"DataStructure")}key;path;get basePath(){return this.path.replace(/^system\./,"")}get type(){return DATA_TYPE_INVERTED[this.typeId]}typeId;root;value;parent;children=[];depth=0;treetype;get isRollData(){return this.root.treetype==="rolldata"}_sourceData;_derivedData;_rollData;_overides;includeFunctions=!1;get isBigString(){return this.typeId===DATA_TYPES.string&&this.value?.length>24}get isNull(){return this.typeId===DATA_TYPES.null}get isFunction(){return this.typeId===DATA_TYPES.function}get isGetter(){return this.typeId===DATA_TYPES.getter}get isUndefined(){return this.typeId===DATA_TYPES.undefined}get isNullish(){return!!([DATA_TYPES.null,DATA_TYPES.undefined].includes(this.typeId)||this.isArray&&this.value.length===0||this.isSet&&this.value.size===0||(this.isMap||this.isCollection)&&this.value.size==0)}get identifier(){switch(this.typeId){case DATA_TYPES.custom:case DATA_TYPES.model:return this.value.constructor.name;default:return null}}get isModel(){return this.typeId===DATA_TYPES.model}get isArray(){return this.typeId===DATA_TYPES.array}get isSet(){return this.typeId===DATA_TYPES.set}get isArrayLike(){return this.isArray||this.isSet}get isMap(){return this.typeId===DATA_TYPES.map}get isCollection(){return this.typeId===DATA_TYPES.collection}get isObject(){return this.typeId===DATA_TYPES.object}get isUndesirable(){return this.isDocument||[DATA_TYPES.placeable,DATA_TYPES.pixi,DATA_TYPES.app].includes(this.typeId)}get isDocument(){return[DATA_TYPES.document,DATA_TYPES.data].includes(this.typeId)}get documentId(){if(this.typeId===DATA_TYPES.data)return this.value._id;if(this.typeId===DATA_TYPES.document)return this.value.id}get hasValues(){return this.isContainer&&!this.isArrayLike?"total"in this.value||"value"in this.value||"max"in this.value:!1}get values(){let data={value:this.value.value,haveValue:!1,max:this.value.max,haveMax:!1,isValue:!1,total:this.value.total,haveTotal:!1,noValues:!1};return(data.value===null||typeof data.value=="number")&&(data.value=`${data.value}`,data.haveValue=!0),(data.max===null||typeof data.max=="number")&&(data.max=`${data.max}`,data.haveMax=!0),(data.total===null||typeof data.total=="number")&&(data.total=`${data.total}`,data.haveTotal=!0),(data.haveValue||data.haveMax)&&(data.isValue=!0,data.isValueOf=data.haveValue&&data.haveMax),!data.isValue&&!data.haveTotal&&(data.noValues=!0),data}get className(){return this.value.__proto__?.constructor.name}get isEmpty(){if(this.isNullish)return!0;switch(this.typeId){case DATA_TYPES.array:return this.value.length==0;case DATA_TYPES.object:return foundry.utils.isEmpty(this.value);case DATA_TYPES.map:case DATA_TYPES.collection:return this.value.size===0;case DATA_TYPES.custom:return this.children.length==0}return!1}recursionPoint=!1;get isPrimitive(){return this.isBoolean||this.isNumber||this.isString||this.isNull||this.isUndefined}get isBoolean(){return this.typeId===DATA_TYPES.boolean}get isString(){return this.typeId===DATA_TYPES.string}get isNumber(){return this.typeId===DATA_TYPES.number}get inArray(){return this.parent?.isArrayLike??!1}get isContainer(){return this.recursionPoint?!1:[DATA_TYPES.array,DATA_TYPES.set,DATA_TYPES.object,DATA_TYPES.model,DATA_TYPES.map,DATA_TYPES.collection,DATA_TYPES.custom].includes(this.typeId)}get isChildless(){return[DATA_TYPES.boolean,DATA_TYPES.string,DATA_TYPES.null,DATA_TYPES.undefined,DATA_TYPES.number].includes(this.typeId)}get isCustom(){return this.typeId===DATA_TYPES.custom}get formattedValue(){switch(this.typeId){case DATA_TYPES.undefined:return"undefined";case DATA_TYPES.null:return"null";case DATA_TYPES.function:return"function"}return this.value}#inRoll;get inRollData(){if(this.#inRoll===void 0){if(this.root.treetype==="rolldata")return this.#inRoll=!0;if(!this.root._rollData)return!1;let path=this.basePath;try{return this.#inRoll=hasProperty(this.root._rollData,path)}catch{}return this.#inRoll=3}return this.#inRoll}#inSource;get inSourceData(){if(this.#inSource===void 0){if(this.root.treetype==="source")return this.#inSource=!0;if(!this.root._sourceData)return!1;let path=this.basePath;try{let data=this.root._sourceData;return this.#inSource=hasProperty(data,path)}catch{}return this.#inSource=3}return this.#inSource}#inDerived;get inDerivedData(){if(this.#inDerived===void 0){if(this.root.treetype==="derived")return this.#inDerived=!0;if(!this.root._derivedData)return!1;let path=this.basePath;try{let data=this.root._derivedData;return this.#inDerived=hasProperty(data,path)}catch{}return this.#inDerived=3}return this.#inDerived}#inTemporary;get inTemporaryData(){if(this.#inTemporary===void 0){if(!this.root._temporaryData)return!1;let path=this.basePath;try{let data=this.root._temporaryData;return this.#inTemporary=hasProperty(data,path)}catch{}return this.#inTemporary=3}return this.#inTemporary}get hasOverrides(){return!!this._overrides}get css(){return this.typeId===DATA_TYPES.boolean?this.value?"true":"false":this.typeId===DATA_TYPES.number?this.value===0?"zero":this.value<0?"negative":"positive":""}constructor({key,path,value,parent,type,treeType,depth}){this.key=key,this.path=path,this.typeId=type??getTypeId(value),this.value=value,this.parent=parent,this.root=parent?.root??parent,this.depth=depth,this.treetype=treeType,this.includeFunctions=parent?.includeFunctions??!1}#childKeys;childKeys(){if(this.#childKeys)return this.#childKeys;if(this.isUndesirable)return[];switch(this.typeId){case DATA_TYPES.set:return this.#childKeys=[Array.from(this.value).map(k=>new ChildKeyData(k))];case DATA_TYPES.array:return this.#childKeys=[this.value.map(k=>new ChildKeyData(k))];case DATA_TYPES.collection:case DATA_TYPES.map:return this.#childKeys=[Array.from(this.value.keys()).map(k=>new ChildKeyData(k))];case DATA_TYPES.model:case DATA_TYPES.object:case DATA_TYPES.custom:{let allKeys=[],rvg=[],rvf=[],props=Object.getOwnPropertyNames(this.value).filter(k=>this.isModel?!ignoreDataModelParts.includes(k):!0);if(allKeys.push(...props.map(k=>new ChildKeyData(k))),this.includeFunctions){let proto=this.value;if([DATA_TYPES.custom,DATA_TYPES.object,DATA_TYPES.model].includes(this.typeId)){let ignored=["constructor","toString","almostEqual","__proto__","prototype","between","toObject","toJSON","clone"],ignoreModelBits=[...ignoreDataModelParts,"schema","validationFailures","invalid","validate","update","updateSource","reset"];do{let keys=Object.getOwnPropertyNames(proto);for(let key of keys){if(key.startsWith("_")||ignored.includes(key)||this.isModel&&ignoreModelBits.includes(key))continue;let cType=getChildTypeId(proto,key);cType===DATA_TYPES.getter?rvg.push(new ChildKeyData(key,DATA_TYPES.getter)):cType===DATA_TYPES.function&&rvf.push(new ChildKeyData(key,DATA_TYPES.function))}if(proto=Object.getPrototypeOf(proto),proto?.__proto__==null)break}while(proto)}}return this.#childKeys=[allKeys.sort(dataKeySorter),rvg.sort(dataKeySorter),rvf.sort(dataKeySorter)]}default:return this.#childKeys=[]}}fillChildren(){if(this.recursionPoint)return[];let curpath=this.path,basePath=curpath?.length?curpath:this.key,isArrayLike=this.isArrayLike,isMap=this.isMap||this.isCollection,saferValue=this.isSet?Array.from(this.value):this.value,parseChildren=__name(list=>{list?.forEach((ckData,i)=>{let{key,type}=ckData,childKey=isArrayLike?i:key,path=basePath?`${basePath}.${childKey}`:childKey,hookId="data-inspector.filterData";if(Hooks.events[hookId]&&Hooks.call(hookId,this.root.document,path,this.treetype)===!1)return;let value=isMap?this.value.get(childKey):saferValue[childKey];if(getTypeId(value)===DATA_TYPES.function&&!this.includeFunctions)return;let c=new _DataStructure({key:childKey,path,value,parent:this,type,depth:this.depth+1});this.children.push(c)})},"parseChildren"),[all,functions,getters]=this.childKeys();return parseChildren(all),parseChildren(functions),parseChildren(getters),this.children}static recurse(sourceData,key,path,type,{includeFunctions=!1,document}={}){this.includeFunctions=includeFunctions??!1;let dt=new _DataStructure({key,path,value:sourceData,parent:null,treeType:type,depth:0});dt.document=document,dt.root=dt;let all={};dt.path&&(all[dt.path]=dt);let itemCount=0,error=!1,maxDepth=0,visitedNodes=new Map,handleChild=__name(ds=>{if(all[ds.path]=ds,maxDepth<ds.depth&&(maxDepth=ds.depth),itemCount++,itemCount>25e3){error||(ui.notifications.error("DATA INSPECTOR | Possible cyclic reference encountered; ending inspection early",{console:!1}),console.error(ds.path,`
DATA INSPECTOR | Possible cyclic reference encountered; ending inspection early
`,ds),error=!0);return}if(!ds.isPrimitive){let old=visitedNodes.get(ds.value);if(old){ds.recursionPoint=old;return}else visitedNodes.set(ds.value,ds.path)}try{recurseChildren(ds)}catch(err){throw console.error(err,this),err}},"handleChild"),recurseChildren=__name(ds=>{ds.isChildless||ds.fillChildren().forEach(handleChild)},"recurseChildren");return recurseChildren(dt),{root:dt,all,count:itemCount,depth:maxDepth}}getAtPath(path){let parts=path.split("."),key=parts.shift(),c=__name(()=>{switch(this.typeId){case DATA_TYPES.set:case DATA_TYPES.array:return this.children[parseInt(key)];default:return this.children.find(cd=>cd.key===key)}},"getPart")();if(parts.length===0)return c;if(c)return c.getAtPath(parts.join("."))}};var SearchResult=class{static{__name(this,"SearchResult")}path;keyFocus=!0;match;get mismatch(){return this.indexes.path.length===0}target;score;keyFullMatch;pathFullMatch;indexes={path:[],key:[]};ratio;get good(){return this.ratio>.8}get bad(){return this.ratio<.3}scoring={full:void 0,key:void 0};constructor({path,match,target,score,keyFocus,keyFullMatch,pathFullMatch,pathIndexes,keyIndexes,ratio,scoring}={}){this.path=path,this.match=match,this.target=target,this.keyFocus=keyFocus,this.score=score,this.keyFullMatch=keyFullMatch,this.pathFullMatch=pathFullMatch,this.indexes.path=pathIndexes,this.indexes.key=keyIndexes,this.ratio=ratio,this.scoring=scoring}};var TermMatch=class{static{__name(this,"TermMatch")}score;indexes;full;half;ratio;consecutives;longestChain;scoring;constructor({indexes,full,half,ratio,consecutives,longestChain,scoring}={}){this.indexes=indexes,this.full=full,this.half=half,this.ratio=ratio,this.consecutives=consecutives,this.longestChain=longestChain,this.scoring=scoring,this.score=scoring.reduce((old,scr)=>old+scr.value)}};var Score=class{static{__name(this,"Score")}value;description;constructor(value,description){this.value=value,this.description=description}};function createTemporaryDocument(doc){let data={name:doc.name+" [Temporary]",type:doc.type,system:{}},hookId="data-inspector.temporaryData";return Hooks.events[hookId]&&Hooks.callAll(hookId,doc,data),doc instanceof Actor?new Actor.implementation(data):new Item.implementation(data)}__name(createTemporaryDocument,"createTemporaryDocument");var DataInspectorDialog=class _DataInspectorDialog extends DocumentSheet{static{__name(this,"DataInspectorDialog")}static EDITABLE_MODES=["source","override","flags"];_path="";_pathEl;_search="";_searchEnd=!0;_functions=!1;_document=!1;_mode="rolldata";_expandedItems=new Set;_derivedData;_sourceData;_temporaryData;_rollData;_flagData;_overrides;_resultQuality=.7;root;paths;constructor(document,options={}){if(super(document,options),!document.testUserPermission(game.user,"OBSERVER")){let msg="Insufficient permissions to inspect document";throw ui.notifications.error(msg,{console:!1}),new Error(msg)}this._functions=game.settings.get(CFG.id,CFG.SETTINGS.functions),this._resultQuality=game.settings.get(CFG.id,CFG.SETTINGS.results),this._mode=game.settings.get(CFG.id,CFG.SETTINGS.mode)}get isEditable(){return!0}get title(){let doc=this.document,parent=doc.actor,title=["Data Inspector"];return parent&&title.push(parent.name),title.push(doc.name),title.join(": ")}get id(){return"data-inspector-"+this.document.uuid.replace(".","-")}get template(){return`modules/${CFG.id}/template/inspector.hbs`}static get defaultOptions(){let _default=super.defaultOptions;return mergeObject(_default,{classes:[..._default.classes,"koboldworks","data-inspector"],resizable:!0,width:520,height:620,sheetConfig:!1,scrollY:["div.data"]})}getDataVariant(doc,mode){let v11=game.release.generation>=11;switch(mode??this._mode){case"flags":return this._flagData==null&&(this._flagData=doc.flags??{}),{data:this._flagData,path:"flags"};case"override":return this._overrides==null&&(this._overrides=(v11?doc.token?.delta.toObject().system:doc.token?.actorData?.system)??{}),{data:this._overrides,path:"system"};case"rolldata":return this._rollData==null&&(this._rollData=doc.getRollData()),{data:this._rollData,path:""};case"source":return this._sourceData==null&&(this._sourceData=doc.toObject().system),{data:this._sourceData,path:"system"};default:case"derived":return this._derivedData==null&&(this._derivedData=doc.system),{data:this._derivedData,path:"system"}}}getBaseData(){let doc=this.document;switch(this._mode){case"flags":return doc.flags??{};case"override":return doc.token?.actorData??{};case"rolldata":return doc.getRollData();case"source":return doc.toObject();default:case"derived":return doc}}getData(){let data={},doc=this.document,isActor=doc instanceof Actor,type=doc.type,typeLabelKey=`${isActor?"ACTOR":"ITEM"}.Type${type.capitalize()}`,typeLabel=game.i18n.localize(typeLabelKey);this._mode==="source"&&(this._temporaryData??=createTemporaryDocument(this.document).toObject()),data.rolldata=this.getDataVariant(doc,"rolldata").data,data.sourcedata=this.getDataVariant(doc,"source").data,data.derived=this.getDataVariant(doc,"derived").data,isActor&&(data.overrides=this.getDataVariant(doc,"override").data),data.flags=this.getDataVariant(doc,"flags").data;let{data:docData,path:basepath}=this.getDataVariant(doc);data.document=doc,data.type=type,data.typeLabel=typeLabel,data.docType=doc.constructor.name,data.dataType=this._mode,data.isRollData=this._mode==="rolldata",data.isSourceData=this._mode==="source",data.isDerivedData=this._mode==="derived",data.isOverrideData=this._mode==="override",data.resultQuality=this._resultQuality;let isRollData=this._mode==="rolldata",isFlags=this._mode==="flags",basePath=isRollData?null:"system",{root,all,count,depth}=DataStructure.recurse(docData,basepath,basepath,this._mode,{includeFunctions:this._functions,document:doc});return data.data=root,this.root=root,data.count=count,data.depth=depth,data.model=root.isModel?root.className:game.i18n.localize("DataInspector.NotAvailable"),root.treetype==="source"&&(data.model=doc.system instanceof foundry.abstract.DataModel?doc.system.constructor.name:game.i18n.localize("DataInspector.NotAvailable")),root._sourceData=data.sourcedata,root._derivedData=data.derived,root._rollData=data.rolldata,root._overrides=data.overrides,root._temporaryData=this._temporaryData?.system,data.uuid=doc.uuid,data.search=this._search,data.searchEnd=this._searchEnd,data.includeFunctions=this._functions,data.includeDocument=this._document,data.path=this._path,data.TYPES=DATA_TYPES,data}treeWalker(el,callback,...args){callback(el,...args);let parent=el.parentElement;parent&&["LI","UL"].includes(parent.tagName)&&this.treeWalker(parent,callback,...args)}highlightEl(el,enabled=!0){this._pathEl&&this._pathEl.classList.toggle("selected",!1),el.classList.toggle("selected",enabled),this._pathEl=el}expandDataElTree(el){this.treeWalker(el,this.expandDataEl,!1,!0)}expandDataEl(el,record=!0,expand=void 0){if(el.classList.toggle("hide",!1),!(el.classList.contains("value")||el.classList.contains("empty"))){if(record){let path=el.dataset.path,items=this._expandedItems;el.classList.contains("collapsed")?items.add(path):items.delete(path)}el.classList.toggle("collapsed",expand!==void 0?!expand:void 0),el.classList.toggle("expanded",expand)}}collapseAndClearEl(el,hide=!1,includeValues=!1){el.classList.toggle("hide",hide),el.dataset.matchQuality=null,el.classList.toggle("selected",!1),!(el.classList.contains("value")||el.classList.contains("empty"))&&(el.classList.toggle("collapsed",!0),el.classList.toggle("expanded",!1))}expandData(ev,el){ev.preventDefault(),ev.stopPropagation(),this.expandDataEl(el)}activateListeners(jq){super.activateListeners(jq);let html=jq[0],header=html.querySelector(".header"),appEl=html.closest("[data-appid]");if(appEl){let doc=this.document,item=doc instanceof Item?doc:null;item&&(appEl.dataset.itemId=item.id,appEl.dataset.itemUuid=item.uuid);let actor=doc instanceof Actor?doc:this.document.parent;actor&&(appEl.dataset.actorId=actor.id,appEl.dataset.actorUuid=actor.uuid)}let pathInput=header.querySelector("input.path"),app=this,rolldata=this._mode==="rolldata",rawdata=this._mode==="source";function changeDataSource(ev){let value=ev.target.value;if(app._mode!==value){ev.preventDefault(),ev.stopPropagation(),ev.target.disabled=!0;let path=app._path;if(path.length>0){let pathp=path.split(""),prefix="system.";path[0]==="@"&&app._mode==="rolldata"?pathp.splice(0,1,prefix):path.length>5&&path.startsWith(prefix)&&value==="rolldata"&&pathp.splice(0,prefix.length,"@"),app._path=pathp.join("")}app._path=app.getBasePath(app._path,app._mode),app._mode=value,app._lastSearch=void 0,app.render(!1,{keepCache:!0})}}__name(changeDataSource,"changeDataSource"),header.querySelector("select.type").addEventListener("change",changeDataSource);function changeSearchQuality(ev){app._resultQuality=Number(this.value),app._search.length>0&&app.doSearch(app._search,{forceRefresh:!0})}__name(changeSearchQuality,"changeSearchQuality"),header.querySelector("input.search-quality").addEventListener("change",changeSearchQuality);function copyPath(ev){ev.preventDefault(),ev.stopPropagation();let path=this.dataset.path??this.closest("[data-path]").dataset.path,properPath=rolldata?`@${path}`:path;if(pathInput.value=properPath,!properPath)return void console.error("Failed to parse path from",{path,element:this});app._path=properPath,app.highlightEl(this,!0),console.log(`Saving path %c${path}%c to clipboard`,CFG.COLORS.id,CFG.COLORS.unset),game.clipboard.copyPlainText(properPath).then(()=>ui.notifications.info(game.i18n.format("DataInspector.Info.CopyPath",{path})))}__name(copyPath,"copyPath");function copyValue(ev){ev.preventDefault(),ev.stopPropagation();let path=this.closest("[data-path]").dataset.path;app._currentData??=app.getBaseData();let value=getProperty(app._currentData,path);["string","number"].includes(typeof value)||(value=JSON.stringify(value,null,2)),console.log(`Saving value of %c${path}%c to clipboard:`,CFG.COLORS.id,CFG.COLORS.unset,{value}),game.clipboard.copyPlainText(value).then(()=>ui.notifications.info(game.i18n.format("DataInspector.Info.CopyValue",{path})))}__name(copyValue,"copyValue");function expandPath(ev){ev.preventDefault(),ev.stopPropagation(),app.expandData(ev,this)}__name(expandPath,"expandPath"),jq.on("click","[data-path]",expandPath),jq.on("contextmenu","[data-path] .details .key",copyPath),jq.on("contextmenu","[data-path] .details .value,[data-path] .details .extended-value",copyValue),pathInput.addEventListener("input",ev=>this.debounceCustomPath(ev.target.value,ev,!0)),pathInput.addEventListener("change",ev=>this.debounceCustomPath(ev.target.value,ev,!1)),html.querySelectorAll("[data-path]").forEach(el=>{let path=el.dataset.path;this._expandedItems.has(path)&&this.expandDataEl(el)});let dataSection=html.querySelector("form > .data");dataSection.addEventListener("dblclick",__name(function(ev){if(ev.preventDefault(),ev.stopPropagation(),_DataInspectorDialog.EDITABLE_MODES.includes(app._mode)){let el=ev.target,ael=el.dataset.path?el:el.closest("[data-path]");ael&&app._openValueEditor(ev,ael.dataset.path)}else ui.notifications.warn(`Editing not supported in "${app._mode}" mode!`)},"openEditor"));let buildSearchCache=__name(el=>{let path=el.dataset.path,key=el.dataset.key,label=el.querySelector("h4");this.paths.set(path,{path,key,element:el,label:label.textContent})},"buildSearchCache"),useTooltips=game.settings.get(CFG.id,CFG.SETTINGS.tooltip),paths=dataSection.querySelectorAll("li[data-path]"),pathPrefix=this._mode==="rolldata"?"@":"";paths.forEach(el=>{if(!useTooltips)return;let dEl=el.querySelector(".details");dEl?.addEventListener("mouseenter",async ev=>{let path=el.dataset.path,dpath=path;if(app._mode!=="rolldata"){let parts=path.split(".");parts.shift(),dpath=parts.join(".")}let dd=this.root?.getAtPath(dpath),typeId=dd.typeId,typeName=typeId!==DATA_TYPES.custom?game.i18n.localize(`DataInspector.Types.${DATA_TYPE_INVERTED[typeId]}`):dd.className,isFlags=dd.treetype==="flags",templateData={dd,path:pathPrefix+path,type:typeName,documentId:dd.documentId,isContainer:dd.isContainer||dd.isDocument,children:dd.isContainer||dd.isDocument?dd.children.length:null,isString:dd.isString,length:dd.isString?dd.value.length:null,treetype:dd.treetype,notFlags:!isFlags,inData:{rolldata:{show:!isFlags&&dd.treetype!=="rolldata",label:"DataInspector.Data.Roll",present:isFlags?!1:dd.inRollData},derived:{show:!isFlags&&dd.treetype!=="derived",label:"DataInspector.Data.Derived",present:isFlags?!1:dd.inDerivedData},source:{show:!isFlags&&dd.treetype!=="source",label:"DataInspector.Data.Source",present:isFlags?!1:dd.inSourceData},temporary:{show:dd.treetype==="source",label:"DataInspector.Data.Temporary",present:isFlags?!1:dd.inTemporaryData}}},text=await renderTemplate(`modules/${CFG.id}/template/tooltip.hbs`,templateData);game.tooltip.activate(dEl,{text,direction:"UP",cssClass:"data-inspector-tooltip"})},{passive:!0}),dEl?.addEventListener("mouseleave",()=>game.tooltip.deactivate(),{passive:!0})});let search=header.querySelector("input.search");search.addEventListener("change",ev=>this.debounceSearch(ev.target.value,ev,!1),{passive:!0}),search.addEventListener("input",ev=>this.debounceSearch(ev.target.value,ev,!0),{passive:!0}),this.paths=new Collection,paths.forEach(el=>buildSearchCache(el)),header.querySelector("input.functions").addEventListener("change",ev=>{ev.preventDefault(),ev.stopPropagation(),this._functions=ev.target.checked,this.render()}),this._search.length&&this.debounceSearch(this._search),this._functions&&(this._getGetterValueBound||(this._getGetterValueBound=this._getGetterValue.bind(this)),dataSection.addEventListener("click",function(ev){ev.target.matches(".getter.value")&&(ev.preventDefault(),ev.stopPropagation(),app._getGetterValueBound(ev))})),this.expandSelectedPath()}_openValueEditor(event,path){if(!game.settings.get(CFG.id,CFG.SETTINGS.allowEditing))return ui.notifications.warn("Editing has been disabled.");let pp=path.split("."),currentData=this.document,type,inArray=!1;for(;pp.length>0;){let part=pp.shift();if(type=getChildTypeId(currentData,part),type===DATA_TYPES.getter)return ui.notifications.error(game.i18n.localize("DataInspector.Error.NoGetterEdit"));if(currentData=currentData[part],currentData==null&&pp.length>0)return ui.notifications.warn(game.i18n.format("DataInspector.Error.NavigationFailure",{path}));Array.isArray(currentData)&&pp.length>0&&(inArray=!0)}if(!ValueEditor.supportedTypes.includes(type)&&!game.settings.get(CFG.id,CFG.SETTINGS.allowEditingUnsupported))return ui.notifications.warn(game.i18n.format("DataInspector.Error.UnsupportedEditType",{type:DATA_TYPE_INVERTED[type]}));new ValueEditor(this.document,path,type,{isToken:this._mode==="override",app:this,inArray}).render(!0,{focus:!0})}_copyId(_event){let id=this.dataset.id;return console.log("Copying ID:",id),game.clipboard.copyPlainText(id)}_getGetterValueBound;_getGetterValue(event){event.stopImmediatePropagation(),event.preventDefault();let target=event.target;target&&(target.removeEventListener("click",this._getGetterValueBound),this._resolveGetter(target))}_resolveGetter(element){let el=element.dataset.path?element:element.closest("[data-path]");if(!el)return;let path=el.dataset.path,ds=this.root.getAtPath(path),value=ds.value;ds.typeId=getTypeId(value),element.textContent=value,element.classList.add("resolved"),element.classList.add(ds.type)}getBasePath(path,oldMode,targetMode){return oldMode??=this._mode,oldMode==="rolldata"?path.replace(/^@/,""):targetMode==="rolldata"?path.replace(/^system\./,"@"):path}expandSelectedPath(){if(this._path.length==0)return;let path=this.getBasePath(this._path),p=this.paths.get(path);p&&(this.expandDataElTree(p.element),this._pathEl=p.element,this.highlightEl(this._pathEl,!0),this._pathEl.scrollIntoView({block:"center"}))}inputDebounceDelay=250;searchDelayTimer;selectDelayTimer;debounceSearch(search,event,active=!1){clearTimeout(this.searchDelayTimer),search.length===0&&(active=!1);let delay=Math.clamped(active?search.length>3?this.inputDebounceDelay:this.inputDebounceDelay*2:this.inputDebounceDelay/2,150,500);this.searchDelayTimer=setTimeout(_=>this.doSearch(search),delay)}debounceCustomPath(input,event,active=!1){this._path=input,this._pathEl&&(this._pathEl.classList.toggle("selected",!1),this._pathEl=null),clearTimeout(this.selectDelayTimer),input.length===0&&(active=!1);let delay=active?input.length>3?this.inputDebounceDelay:this.inputDebounceDelay*2:this.inputDebounceDelay/2;this.selectDelayTimer=setTimeout(_=>this.selectCustomPath(input),delay)}selectCustomPath(input){this._path=input,this.expandSelectedPath();let path=this.paths.get(input);path?(this.expandDataElTree(path.element),this.highlightEl(path.element),this._pathEl=path.element):this._pathEl=null}_lastSearch;lastEndSerch;doSearch(search,{forceRefresh=!1}={}){if(this._search=search,console.log("Searching:",this._search),forceRefresh!==!0&&this._lastSearch===search&&this.lastEndSerch===this._searchEnd)return;if(this._lastSearch=search,this.lastEndSerch=this._searchEnd,search.length==0){this.paths.forEach(p=>this.collapseAndClearEl(p.element,!1)),this.expandSelectedPath();return}this.paths.forEach(p=>this.collapseAndClearEl(p.element,!0));let term=search.toLowerCase().split("");function matchTerm(term2,subject,{harsh=!0}={}){let indexes=[],subjectParts=subject.toLowerCase().split(""),consecutives=0,longestChain=0,si=0,sm=term2[0],lastMatch=-2,lastChain=1,scoring=[],updateLongestChain=__name(()=>{lastChain>longestChain&&(longestChain=lastChain),lastChain=1},"updateLongestChain");for(let i=0;i<subjectParts.length;i++)if(subjectParts[i]===sm){indexes.push(i),lastMatch===i-1?(scoring.push(new Score(3,`Consecutive [${i}]: +3`)),consecutives++,lastChain++):(scoring.push(new Score(1,`Match [${i}]: +1`)),updateLongestChain()),lastMatch=i;let endBonus=Math.clamped(Math.round((subjectParts.length-i)/5),0,3);if(endBonus>0&&scoring.push(new Score(endBonus,`End bonus: +${endBonus}`)),sm=term2[++si],sm===void 0)break}updateLongestChain(),indexes.length>0?scoring.push(new Score(indexes.length*3,`Matched letters bonus: ${indexes.length*3}`)):scoring.push(new Score(-100,"No matches: -100"));let full=indexes.length==term2.length;full&&scoring.push(new Score(20,"Full match: +20"));let half=indexes.length<Math.floor(term2.length/2)-2;if(harsh){let cumulative=scoring.reduce((prev,cur)=>cur.value+prev),halfScore=-Math.floor(cumulative/2);half&&scoring.push(new Score(halfScore,`Partial match: ${halfScore}`)),longestChain<=1&&scoring.push(new Score(-20,"Short chains: -20"))}return new TermMatch({indexes,full,half,ratio:(consecutives+1)/term2.length,consecutives,longestChain,scoring})}__name(matchTerm,"matchTerm");let fullMatches0=0,fullMatches1=0,results=this.paths.reduce((results2,target)=>{let matchPath=matchTerm(term,target.path),matchKey=matchTerm(term,target.key);matchKey.full&&fullMatches0++,matchPath.full&&fullMatches1++;let match=matchPath.ratio>.5,ratio=matchPath.ratio;return this._keyFocus?(matchPath.score/=5,ratio=matchKey.ratio,match=matchKey.ratio>matchPath.ratio):(ratio+=matchKey.ratio*2,ratio/=3),results2.push(new SearchResult({path:target.path,match,target,keyFocus:this._keyFocus,score:matchPath.score/2+matchKey.score*2,keyFullMatch:matchKey.full,pathFullMatch:matchPath.full,pathIndexes:matchPath.indexes,keyIndexes:matchKey.indexes,ratio,scoring:{full:matchPath.scoring,key:matchKey.scoring}})),results2},[]);results.sort((a,b)=>a.full&&!b.full?-1:b.full&&!a.full?1:b.score-a.score);let Break={};try{results.forEach(r=>{let el=r.target.element;el.dataset.searchScore=`${r.score}`,el.dataset.searchRatio=`${r.ratio}`;let q="decent";r.mismatch?q="mismatch":r.bad?q="bad":r.good&&(q="good"),el.dataset.matchQuality=q,fullMatches0>0?r.ratio>this._resultQuality&&this.expandDataElTree(el):r.bad||this.expandDataElTree(el)})}catch(err){if(err!==Break)throw err}this.expandSelectedPath()}render(force=!1,options={}){return options.action==="update"&&(options.keepCache=!1),options.keepCache!==!0&&(this._currentData=void 0,this._rollData=void 0,this._sourceData=void 0,this._derivedData=void 0,this._overrides=void 0,this._flagData=void 0,this._lastSearch=void 0),super.render(force,options)}};var refreshActiveDialogs=__name(()=>Object.values(ui.windows).forEach(app=>app instanceof DataInspectorDialog?app.render():null),"refreshActiveDialogs");Hooks.once("init",__name(function(){game.settings.register(CFG.id,CFG.SETTINGS.mode,{name:"DataInspector.Settings.DefaultMode",hint:"DataInspector.Settings.DefaultModeHint",scope:"client",config:!0,type:String,default:"rolldata",choices:{rolldata:"DataInspector.Data.Roll",source:"DataInspector.Data.Source",derived:"DataInspector.Data.Derived"}}),game.settings.register(CFG.id,CFG.SETTINGS.results,{name:"DataInspector.Settings.ResultQuality",hint:"DataInspector.Settings.ResultQualityHint",scope:"client",config:!0,type:Number,default:.7,range:{min:0,max:1,step:.01}}),game.settings.register(CFG.id,CFG.SETTINGS.functions,{name:"DataInspector.Settings.IncludeFunctions",hint:"DataInspector.Settings.IncludeFunctionsHint",scope:"client",config:!0,type:Boolean,default:!1}),game.settings.register(CFG.id,CFG.SETTINGS.allowEditing,{name:"DataInspector.Settings.AllowEditing",hint:"DataInspector.Settings.AllowEditingHint",config:!0,scope:"world",type:Boolean,default:!1}),game.settings.register(CFG.id,CFG.SETTINGS.allowEditingUnsupported,{name:"DataInspector.Settings.AllowEditingUnsupported",hint:"DataInspector.Settings.AllowEditingUnsupportedHint",config:!0,scope:"world",type:Boolean,default:!1}),game.settings.register(CFG.id,CFG.SETTINGS.allowUsers,{name:"DataInspector.Settings.AllowUsers",hint:"DataInspector.Settings.AllowUsersHint",config:!0,scope:"world",type:Boolean,default:!0}),game.settings.register(CFG.id,CFG.SETTINGS.tooltip,{name:"DataInspector.Settings.Tooltip",hint:"DataInspector.Settings.TooltipHint",config:!0,scope:"client",type:Boolean,default:!0,onChange:()=>refreshActiveDialogs()})},"registerSettings"));var openInspector=__name(doc=>{let oldApp=Object.values(doc.apps).find(app=>app instanceof DataInspectorDialog);oldApp?oldApp.render(!0,{focus:!0}):new DataInspectorDialog(doc).render(!0)},"openInspector"),injectHeaderDataButton=__name((sheet,buttons)=>{!game.settings.get(CFG.id,CFG.SETTINGS.allowUsers)&&!game.user.isGM||buttons.unshift({class:"data-inspector",icon:"fas fa-atom",label:game.i18n.localize("DataInspector.DataButton"),onclick:_=>openInspector(sheet.document)})},"injectHeaderDataButton"),injectContextDataButton=__name(([directory],entries)=>{entries.push({name:"DataInspector.Context.OpenInspector",icon:'<i class="fas fa-atom"></i>',condition:()=>game.settings.get(CFG.id,CFG.SETTINGS.allowUsers)||game.user.isGM,callback:async([entry])=>{let directoryId=directory.id,packId=directory.dataset.pack,documentId=entry.dataset.documentId,doc;if(packId)doc=await game.packs.get(packId)?.getDocument(documentId);else if(directoryId==="items")doc=game.items.get(documentId);else if(directoryId==="actors")doc=game.actors.get(documentId);else return void console.error("Unknown data source:",{directory,entry});doc?openInspector(doc):console.warning("Document not found:",{documentId,directoryId,packId})}})},"injectContextDataButton");Hooks.once("ready",async()=>{let C=CFG.COLORS;if(!game.settings.get(CFG.id,CFG.SETTINGS.allowUsers)&&!game.user.isGM)return void console.log(`%cDATA INSPECTOR%c \u{1F50D} | %c${mod.version}%c | User access blocked in settings.`,C.main,C.unset,C.id,C.unset);let templates=["object","inspector","value","object-data"];await loadTemplates(templates.map(t=>`modules/${CFG.id}/template/${t}.hbs`));let mod=game.modules.get(CFG.id);mod.api={inspect:openInspector},["pf1"].includes(game.system.id)&&await import(`systems/${game.system.id}.mjs`).then(()=>console.log("%cDATA INSPECTOR%c \u{1F50D} | System extensions loaded %c\u2714",C.main,C.unset,"color:green")).catch(()=>console.log("%cDATA INSPECTOR%c \u{1F50D} | System extensions not found %c\u2718",C.main,C.unset,"color:red")),console.log(`%cDATA INSPECTOR%c \u{1F50D} | %c${mod.version}%c | READY`,C.main,C.unset,C.id,C.unset)});Hooks.on("getActorSheetHeaderButtons",injectHeaderDataButton);Hooks.on("getItemSheetHeaderButtons",injectHeaderDataButton);Hooks.on("getItemDirectoryEntryContext",injectContextDataButton);Hooks.on("getActorDirectoryEntryContext",injectContextDataButton);Hooks.on("getCompendiumEntryContext",injectContextDataButton);
//# sourceMappingURL=data-inspector.mjs.map
