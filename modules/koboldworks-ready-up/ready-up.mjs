var __defProp=Object.defineProperty;var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});var __publicField=(obj,key,value)=>(__defNormalProp(obj,typeof key!="symbol"?key+"":key,value),value),__accessCheck=(obj,member,msg)=>{if(!member.has(obj))throw TypeError("Cannot "+msg)};var __privateGet=(obj,member,getter)=>(__accessCheck(obj,member,"read from private field"),getter?getter.call(obj):member.get(obj)),__privateAdd=(obj,member,value)=>{if(member.has(obj))throw TypeError("Cannot add the same private member more than once");member instanceof WeakSet?member.add(obj):member.set(obj,value)},__privateSet=(obj,member,value,setter)=>(__accessCheck(obj,member,"write to private field"),setter?setter.call(obj,value):member.set(obj,value),value);var CFG={id:"koboldworks-ready-up",SETTINGS:{volumeKey:"volume",lingerKey:"linger",notifyKey:"notify",stickyKey:"sticky",spamWardKey:"spamGuard",turnStartMessage:"turnStart",nextUpMessage:"nextUp"}};var getPath=__name(file=>`modules/${CFG.id}/sounds/${file}`,"getPath");var active="active",hidden="hidden",ghosted="ghosted",nextUp="next",turnStart="now",_overlay,_labelNext,_labelNow,_Overlay=class{constructor(){__privateAdd(this,_overlay,document.createElement("div"));__publicField(this,"dismissable",!1);__publicField(this,"timerId");__privateAdd(this,_labelNext,void 0);__privateAdd(this,_labelNow,void 0);__publicField(this,"displayTime",Date.now());__publicField(this,"boundDismiss",this.dismiss.bind(this));__privateGet(this,_overlay).id=`${CFG.id}-overlay`,__privateSet(this,_labelNext,document.createElement("label")),__privateSet(this,_labelNow,document.createElement("label"));let _container=document.createElement("div");__privateGet(this,_labelNow).id=`${CFG.id}-now`,__privateGet(this,_labelNow).textContent=game.i18n.localize("Koboldworks.ReadyUp.YourTurn"),__privateGet(this,_labelNext).id=`${CFG.id}-next`,__privateGet(this,_labelNext).textContent=game.i18n.localize("Koboldworks.ReadyUp.NextUp"),_container.classList.add("container"),_container.append(__privateGet(this,_labelNow),__privateGet(this,_labelNext)),__privateGet(this,_overlay).append(_container),__privateGet(this,_overlay).classList.add(hidden),document.body.append(__privateGet(this,_overlay))}resetTimer(){clearTimeout(this.timerId),this.timerId=void 0}resize(){let sbc=getComputedStyle(document.getElementById("sidebar"));__privateGet(this,_overlay).style.width=`calc(100% - ${sbc.width} - ${sbc.right})`}removeClickListener(){document.getElementById("board").removeEventListener("click",this.boundDismiss)}dismiss(ev){if(Date.now()-this.displayTime<250)return;this.dismissable?this.hide():this.ghost(),__privateGet(this,_overlay).classList.contains(ghosted)||(ev?.preventDefault(),ev?.stopPropagation())}hide(){this.resetTimer(),this.removeClickListener();let o=__privateGet(this,_overlay);o.classList.remove(active),o.classList.add(hidden)}show({now=!1,dismissable=!1,combatant=null,nextCombatant=null}){this.displayTime=Date.now();let o=__privateGet(this,_overlay);if(now){let msg=game.settings.get(CFG.id,CFG.SETTINGS.turnStartMessage);__privateGet(this,_labelNow).textContent=msg.replace("{name}",combatant?.name).replace("\\n",`
`),o.classList.add(turnStart),o.classList.remove(nextUp)}else{let msg=game.settings.get(CFG.id,CFG.SETTINGS.nextUpMessage);__privateGet(this,_labelNext).textContent=msg.replace("{name}",nextCombatant?.name).replace("\\n",`
`),o.classList.add(nextUp),o.classList.remove(turnStart)}let sticky=game.settings.get(CFG.id,CFG.SETTINGS.stickyKey);this.dismissable=sticky&&dismissable||!sticky,this.resize(),document.getElementById("board").addEventListener("click",this.boundDismiss),o.classList.remove(ghosted),o.classList.add(active),o.classList.remove(hidden);let linger=game.settings.get(CFG.id,CFG.SETTINGS.lingerKey);linger>.1&&(this.resetTimer(),this.timerId=setTimeout(this.boundDismiss,linger*1e3))}ghost(){this.resetTimer(),this.removeClickListener(),__privateGet(this,_overlay).classList.add(ghosted)}static delete(){let s=_Overlay.instance;s&&(s.resetTimer(),__privateGet(s,_overlay)?.remove(),__privateSet(s,_overlay,null)),_Overlay.instance=null}},Overlay=_Overlay;__name(Overlay,"Overlay"),_overlay=new WeakMap,_labelNext=new WeakMap,_labelNow=new WeakMap,__publicField(Overlay,"instance");var soundCfg={turn:{key:"sfx-turn-file",default:"turn.unfa.550909.braam.webm"},round:{key:"sfx-round-file",default:"round.halgrimm.169867.swoosh.webm"},next:{key:"sfx-next-file",default:"next.garyq.135434.industrial-warehouse-lights.webm"}},SoundProxy=class{key;file;audio;constructor(key,file,volume=.5){this.key=key,this.file=file,this.audio=new Audio(file),this.audio.preload="auto",this.audio.defaultMuted=!0,this.audio.autoplay=!1,this.audio.loop=!1,this.audio.volume=Math.clamped(volume,0,1),this.audio.addEventListener("error",this.errorHandler.bind(this),{passive:!0}),this.audio.addEventListener("canplay",this.onLoadBound,{passive:!0})}onLoadBound=this.onLoad.bind(this);onLoad(){this.play=this.playReal,this.audio.removeEventListener("canplay",this.onLoadBound),this.queued&&this.play(),delete this.onLoadBound,delete this.queued,delete this.onLoad}errorHandler(){let err=this.audio.error;(err.code===MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED||err.code===MediaError.MEDIA_ERR_NETWORK&&this.audio.networkState===3)&&console.warn(`READY UP | ${this.key} | Failed to load "${this.file}"`)}set volume(value){this.audio.volume=value}queued=!1;play=function(){this.queued=!0};async playReal(volume=null){return volume&&(this.volume=volume),this.audio.paused||this.reset(),this.audio.play()}reset(){this.audio.currentTime=0}};__name(SoundProxy,"SoundProxy");var audio={next:void 0,round:void 0,turn:void 0};function updateAudioVolume(value){let newVolume=Math.clamped(value/100,0,1);console.log("READY UP | Volume | Set:",value,"%");for(let s of Object.values(audio))s.volume=newVolume}__name(updateAudioVolume,"updateAudioVolume");function loadSound(key,file){return audio[key]=file?new SoundProxy(key,file,game.settings.get(CFG.id,CFG.SETTINGS.volumeKey)/100):null,audio[key]}__name(loadSound,"loadSound");var nextSound=-1;async function audioTest(ev,el){ev.preventDefault(),ev.stopPropagation();let volumeVal=el.querySelector(`input[name="${CFG.id}.volume"]`).value,volume=parseFloat(volumeVal)/100,cfg=Object.values(soundCfg);nextSound=(nextSound+1)%cfg.length;let key=Object.keys(soundCfg)[nextSound],file=el.querySelector(`input[name="${CFG.id}.${cfg[nextSound].key}"]`)?.value??audio[key].file,tmp=file?new SoundProxy("test",file,volume):null;return file?ui.notifications.info(game.i18n.format("Koboldworks.ReadyUp.TestNotify",{key,file:tmp.file,volume:Math.floor(volume*1e3)/10})):ui.notifications?.info(`No file specified for ${cfg[nextSound].key} to play it.`),tmp?.play()}__name(audioTest,"audioTest");Hooks.on("renderSettingsConfig",(_sheet,jq)=>{let html=jq[0],p=html.querySelector(`input[name="${CFG.id}.volume"]`)?.parentElement,button=document.createElement("button");button.type="button",button.style.cssText+="margin-left:3px;width:4em;",button.textContent=game.i18n.localize("Koboldworks.ReadyUp.Test"),button.addEventListener("click",ev=>audioTest(ev,html)),p.append(button)});Hooks.once("init",()=>{game.settings.register(CFG.id,CFG.SETTINGS.volumeKey,{name:"Koboldworks.ReadyUp.VolumeLabel",hint:"Koboldworks.ReadyUp.VolumeHint",scope:"client",config:!0,type:Number,range:{min:0,max:100,step:.1},default:50,onChange:updateAudioVolume});for(let[key,settings]of Object.entries(soundCfg))game.settings.register(CFG.id,settings.key,{name:`Koboldworks.ReadyUp.${key.capitalize()}Sfx`,hint:`Koboldworks.ReadyUp.${key.capitalize()}SfxHint`,scope:"world",config:!0,type:String,default:getPath(settings.default),filePicker:!0,onChange:v=>loadSound(key,v)}),loadSound(key,game.settings.get(CFG.id,settings.key));game.settings.register(CFG.id,CFG.SETTINGS.notifyKey,{name:"Koboldworks.ReadyUp.NotifyLabel",hint:"Koboldworks.ReadyUp.NotifyHint",scope:"client",config:!0,type:Boolean,default:!0,onChange:value=>value?Overlay.instance=new Overlay:Overlay.delete()}),game.settings.register(CFG.id,CFG.SETTINGS.lingerKey,{name:"Koboldworks.ReadyUp.LingerLabel",hint:"Koboldworks.ReadyUp.LingerHint",scope:"client",config:!0,type:Number,range:{min:0,max:25,step:.2},default:0}),game.settings.register(CFG.id,CFG.SETTINGS.stickyKey,{name:"Koboldworks.ReadyUp.StickyLabel",hint:"Koboldworks.ReadyUp.StickyHint",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register(CFG.id,CFG.SETTINGS.spamWardKey,{name:"Koboldworks.ReadyUp.SpamGuardLabel",hint:"Koboldworks.ReadyUp.SpamGuardHint",scope:"client",config:!0,type:Boolean,default:!0}),game.settings.register(CFG.id,CFG.SETTINGS.nextUpMessage,{name:"Koboldworks.ReadyUp.NextUpLabel",hint:"Koboldworks.ReadyUp.NextUpHint",scope:"world",config:!0,default:"Next Up!",type:String}),game.settings.register(CFG.id,CFG.SETTINGS.turnStartMessage,{name:"Koboldworks.ReadyUp.TurnStartLabel",hint:"Koboldworks.ReadyUp.TurnStartHint",scope:"world",config:!0,default:"Your Turn!",type:String})});Hooks.once("ready",()=>{if(game.user.isGM){let msg0=game.settings.get(CFG.id,CFG.SETTINGS.turnStartMessage),msg0b=msg0.replace("${name}","{name}"),msg0m=msg0!==msg0b;msg0m&&game.settings.set(CFG.id,CFG.SETTINGS.turnStartMessage,msg0b);let msg1=game.settings.get(CFG.id,CFG.SETTINGS.nextUpMessage),msg1b=msg1.replace("${name}","{name}"),msg1m=msg1!==msg1b;msg1m&&game.settings.set(CFG.id,CFG.SETTINGS.nextUpMessage,msg1b),(msg1m||msg0m)&&console.log("READY UP | Data Migrated")}});var getDocData=__name(doc=>game.release.generation>=10?doc:doc.data,"getDocData");var CombatStatus=class{id;round;combatant;constructor(combat){this.id=combat.id,this.round=combat.round,this.combatant=combat.combatant.id}};__name(CombatStatus,"CombatStatus");var lastCombat=null,lastTurn=null,lastTurnAnticipation=null;function deleteCombatEvent(){Overlay.instance?.hide()}__name(deleteCombatEvent,"deleteCombatEvent");async function updateCombatEvent(combat,_update,_options,_userId){if(!getDocData(combat).active||!combat.started)return;Overlay.instance?.hide();let newCombatStatus=game.settings.get(CFG.id,CFG.SETTINGS.spamWardKey)?new CombatStatus(combat):null;if(combat.turn===0&&(lastCombat?.id===combat.id&&lastCombat?.round===combat.round||audio.round?.play(),lastCombat=newCombatStatus),game.user.isGM)return;let combatant=combat.combatant;if(combatant.actor?.isOwner??!1){if(combatant.isDefeated)return;lastTurn?.id===combat.id&&lastTurn?.round===combat.round&&lastTurn?.combatant===combatant.id||(audio.turn?.play(),Overlay.instance?.show({now:!0,dismissable:!0,combatant})),lastTurn=newCombatStatus;return}if(combat.turns.length<3)return;let nextTurn=(combat.turn+1)%combat.turns.length,nextCombatant=combat.turns[nextTurn];if(nextCombatant.actor?.isOwner??!1){if(nextCombatant.isDefeated)return;lastTurnAnticipation?.id===combat.id&&lastTurnAnticipation?.round===combat.round&&lastTurnAnticipation?.combatant===combat.combatant.id||(audio.next?.play(),Overlay.instance?.show({now:!1,dismissable:!1,nextCombatant})),lastTurnAnticipation=newCombatStatus}}__name(updateCombatEvent,"updateCombatEvent");async function assessActiveCombat({sound=!1}={}){game.combats?.active&&await updateCombatEvent(game.combats.active)}__name(assessActiveCombat,"assessActiveCombat");function updateCombatantEvent(_combatant,update,_options,_userId){update.initiative&&(Overlay.instance?.hide(),Hooks.once("renderCombatTracker",assessActiveCombat))}__name(updateCombatantEvent,"updateCombatantEvent");Hooks.on("updateCombat",updateCombatEvent);Hooks.on("updateCombatant",updateCombatantEvent);Hooks.on("deleteCombat",deleteCombatEvent);Hooks.once("ready",async()=>{game.settings.get(CFG.id,CFG.SETTINGS.notifyKey)&&(Overlay.instance=new Overlay),assessActiveCombat(),console.log("READY UP | Ready!")});
//# sourceMappingURL=ready-up.mjs.map
